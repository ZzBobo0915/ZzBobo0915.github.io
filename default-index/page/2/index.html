<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/background_favicon32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/background_favicon16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":null,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":"Trebuchet","preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="-珍惜眼前人-">
<meta property="og:type" content="website">
<meta property="og:title" content="ZzBoAYU HOME">
<meta property="og:url" content="http://example.com/default-index/page/2/index.html">
<meta property="og:site_name" content="ZzBoAYU HOME">
<meta property="og:description" content="-珍惜眼前人-">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ZzBoAYU">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/default-index/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>ZzBoAYU HOME</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"><a target="_blank" rel="noopener" href="https://github.com/ZzBobo0915" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ZzBoAYU HOME</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">AYU是我最爱的姑娘</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/26/QML-Component/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/26/QML-Component/" class="post-title-link" itemprop="url">QML-Component</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-06-26 18:23:16 / 修改时间：19:02:37" itemprop="dateCreated datePublished" datetime="2023-06-26T18:23:16+08:00">2023-06-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>345</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="QML-Component详解"><a href="#QML-Component详解" class="headerlink" title="QML-Component详解"></a>QML-Component详解</h1><p>​    Component（组件）是Qt QML中的重要元素，用于定义可重用的QML元素，可以视作为自定义控件，要注意：</p>
<ul>
<li>Component只能包含一个顶层的Item或者实例，而且这个在Item之外不能定义除了id以外的任何数据</li>
<li>Component通常用来给一个视图（ListView等）提供图形化组件</li>
<li>Component不是Item的派生类，而是从QQmlComponent继承而来的，虽然它通过自己的顶层Item为其他的View提供可视化组件，但它本身不是可见元素</li>
</ul>
<p>​    下面是Component在视图中的一个应用</p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">    <span class="title">ColumnLayout</span>&#123;</span><br><span class="line">        <span class="attribute">anchors.fill</span>: <span class="built_in">parent</span></span><br><span class="line">        <span class="title">Item</span>&#123;</span><br><span class="line">            <span class="attribute">Layout.fillWidth</span>: <span class="literal">true</span></span><br><span class="line">            <span class="attribute">Layout.preferredHeight</span>: <span class="number">150</span></span><br><span class="line">            <span class="title">MusicBorderImage</span>&#123;</span><br><span class="line">                <span class="attribute">anchors.centerIn</span>: <span class="built_in">parent</span></span><br><span class="line">                <span class="attribute">height</span>: <span class="number">100</span></span><br><span class="line">                <span class="attribute">width</span>: <span class="number">100</span></span><br><span class="line">                <span class="attribute">borderRadius</span>: <span class="number">100</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 列表菜单</span></span><br><span class="line">        <span class="title">ListView</span>&#123;</span><br><span class="line">            <span class="comment">//id: menuListView</span></span><br><span class="line">            <span class="attribute">id:</span><span class="string"> menuView</span></span><br><span class="line">            <span class="attribute">height</span>: <span class="built_in">parent</span>.height</span><br><span class="line">            <span class="attribute">Layout.fillHeight</span>: <span class="literal">true</span></span><br><span class="line">            <span class="attribute">Layout.fillWidth</span>: <span class="literal">true</span></span><br><span class="line">            <span class="attribute">model</span>: <span class="title">ListModel</span>&#123;</span><br><span class="line">                <span class="attribute">id:</span><span class="string"> menuViewModel</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="attribute">delegate</span>: menuViewDelegate</span><br><span class="line">            <span class="attribute">highlight</span>: <span class="title">Rectangle</span>&#123;</span><br><span class="line">                <span class="attribute">color</span>: <span class="string">&quot;#f1efed&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="attribute">highlightMoveDuration</span>: <span class="number">10</span>    <span class="comment">// 设置切换列表中的变形时间</span></span><br><span class="line">            <span class="attribute">highlightResizeDuration</span>: <span class="number">10</span>  <span class="comment">// 设置下拉列表的变形时间</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Component作为代理为ListView提供可视化组件</span></span><br><span class="line">    <span class="title">Component</span> &#123;</span><br><span class="line">        <span class="attribute">id:</span><span class="string"> menuViewDelegate</span></span><br><span class="line">        <span class="title">Rectangle</span>&#123;</span><br><span class="line">            <span class="attribute">id:</span><span class="string"> menuViewDelegateItem</span></span><br><span class="line">            <span class="attribute">width</span>: <span class="number">200</span></span><br><span class="line">            <span class="attribute">height</span>: <span class="number">50</span></span><br><span class="line">            <span class="attribute">color</span>: menuView.isCurrentItem?<span class="string">&quot;#f1efed&quot;</span>:<span class="string">&quot;#ffffff&quot;</span></span><br><span class="line">            <span class="title">RowLayout</span>&#123;</span><br><span class="line">                <span class="attribute">anchors.fill</span>: <span class="built_in">parent</span></span><br><span class="line">                <span class="attribute">anchors.centerIn</span>: <span class="built_in">parent</span></span><br><span class="line">                <span class="attribute">spacing</span>: <span class="number">15</span></span><br><span class="line">                <span class="title">Item</span>&#123;</span><br><span class="line">                   <span class="attribute">width</span>: <span class="number">30</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title">Image</span>&#123;</span><br><span class="line">                    <span class="attribute">source</span>: <span class="string">&quot;qrc:/images/&quot;</span>+icon</span><br><span class="line">                    <span class="attribute">Layout.preferredHeight</span>: <span class="number">20</span></span><br><span class="line">                    <span class="attribute">Layout.preferredWidth</span>: <span class="number">20</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title">Text</span>&#123;</span><br><span class="line">                    <span class="attribute">text</span>: value</span><br><span class="line">                    <span class="attribute">Layout.fillWidth</span>: <span class="literal">true</span></span><br><span class="line">                    <span class="attribute">height</span>: <span class="number">50</span></span><br><span class="line">                    <span class="attribute">font.family</span>: <span class="built_in">window</span>.mFONT_FAMILY</span><br><span class="line">                    <span class="attribute">font.pointSize</span>: <span class="number">12</span></span><br><span class="line">                    <span class="attribute">color</span>: <span class="string">&quot;#000000&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// onCompleted表示</span></span><br><span class="line">    <span class="attribute">Component.onCompleted</span>: &#123;</span><br><span class="line">        menuViewModel.append(qmlList.filter(item=&gt;item.menu))</span><br><span class="line">        <span class="keyword">var</span> loader = repeater.itemAt(defaultIndex)</span><br><span class="line">        loader.visible = <span class="literal">true</span></span><br><span class="line">        loader.source = qmlList[defaultIndex].qml + <span class="string">&quot;.qml&quot;</span></span><br><span class="line">        menuView.currentIndex = defaultIndex</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 作为一个嵌入式的Component必须用Loader来显示</span></span><br><span class="line"><span class="title">Repeater</span>&#123;  <span class="comment">// 重复构造</span></span><br><span class="line">    <span class="attribute">id:</span><span class="string"> repeater</span></span><br><span class="line">    <span class="attribute">model</span>: qmlList.length  <span class="comment">// filter过滤</span></span><br><span class="line">    <span class="title">Loader</span> &#123;</span><br><span class="line">       <span class="attribute">visible</span>: <span class="literal">false</span></span><br><span class="line">       <span class="attribute">Layout.fillWidth</span>: <span class="literal">true</span></span><br><span class="line">       <span class="attribute">Layout.fillHeight</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/01/Qt-socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/01/Qt-socket/" class="post-title-link" itemprop="url">Qt-socket</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-06-01 11:15:18 / 修改时间：11:47:35" itemprop="dateCreated datePublished" datetime="2023-06-01T11:15:18+08:00">2023-06-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Qt中的Tcp网络通信"><a href="#Qt中的Tcp网络通信" class="headerlink" title="Qt中的Tcp网络通信"></a>Qt中的Tcp网络通信</h1><p>​    Qt中的Tcp网络通信使用的是Qt封装的Tcp&#x2F;IP的客户端与服务端的类，想要使用需要在.pro中添加以下内容：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Qt  += network</span><br></pre></td></tr></table></figure>

<h2 id="QTcpServer类"><a href="#QTcpServer类" class="headerlink" title="QTcpServer类"></a>QTcpServer类</h2><p>​    QTcpServer，继承自QObject，用于服务端监听和建立与客户端的连接：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">QTcpServer::<span class="built_in">QTcpServer</span>(QObject* parent=<span class="literal">nullptr</span>);</span><br><span class="line"><span class="comment">// 设置监听的地址与套接字，QHostAddress::Any表示自定绑定，端口为0表示自动选择一个端口</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QTcpServer::listen</span><span class="params">(<span class="type">const</span> QHostAddress &amp;address=QHostAddress::Any, qunit16 port = <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="comment">// 判断是否在监听</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QTcpServer::isListening</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="comment">// 返回当前正在监听的服务器地址信息，没有则返回QHostAddress::Null </span></span><br><span class="line"><span class="function">QHostAddress <span class="title">QTcpServer::serverAddress</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="comment">// 返回当前正在监听的端口，没有则返回0</span></span><br><span class="line"><span class="function">quint16 <span class="title">QTcpServer::serverPort</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="comment">// 获取客户端连接的套接字对象</span></span><br><span class="line"><span class="function">QTcpSocket *<span class="title">QTcpServer::nextPendingConnection</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 阻塞等待客户端发起连接请求，msec表示最大阻塞时间ms，timedOut为传出参数，超时为true</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QTcpServer::waitForNewConnection</span><span class="params">(<span class="type">int</span> msec = <span class="number">0</span>, <span class="type">bool</span> *timedOut = Q_NULLPTR)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="QTcpSocket类"><a href="#QTcpSocket类" class="headerlink" title="QTcpSocket类"></a>QTcpSocket类</h2><p>​    QTcpSocket类为一个套接字通信类，继承自QAbstractSocket类，QAbstractSocket类继承自QIODevice类，客户端和服务端都要使用。</p>
<p>​    在 Qt 中不管调用读操作函数接收数据，还是调用写函数发送数据，操作的对象都是本地的由 Qt 框架维护的一块内存。因此，调用了发送函数数据不一定会马上被发送到网络中，调用了接收函数也不是直接从网络中接收数据，关于底层的相关操作是不需要使用者来维护的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">QTcpSocket::<span class="built_in">QTcpSocket</span>(QObject *parent = <span class="literal">nullptr</span>);</span><br><span class="line"><span class="comment">// 连接服务器，指定hostName与port</span></span><br><span class="line">[<span class="keyword">virtual</span>] <span class="function"><span class="type">void</span> <span class="title">QAbstractSocket::connectToHost</span><span class="params">(<span class="type">const</span> QString &amp;hostName, quint16 port,OpenMode openMode = ReadWrite, NetworkLayerProtocol protocol = AnyIPProtocol)</span></span>;</span><br><span class="line"><span class="comment">// 指定可接收的最大字节数 maxSize 的数据到指针 data 指向的内存中</span></span><br><span class="line"><span class="function">qint64 <span class="title">QIODevice::read</span><span class="params">(<span class="type">char</span> *data, qint64 maxSize)</span></span>;</span><br><span class="line"><span class="comment">// 指定可接收的最大字节数 maxSize，返回接收的字符串</span></span><br><span class="line"><span class="function">QByteArray <span class="title">QIODevice::read</span><span class="params">(qint64 maxSize)</span></span>;</span><br><span class="line"><span class="comment">// 将当前可用操作数据全部读出，通过返回值返回读出的字符串</span></span><br><span class="line"><span class="function">QByteArray <span class="title">QIODevice::readAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 发送指针 data 指向的内存中的 maxSize 个字节的数据</span></span></span><br><span class="line"><span class="function">qint64 <span class="title">QIODevice::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *data, qint64 maxSize)</span></span>;</span><br><span class="line"><span class="comment">// 发送指针 data 指向的内存中的数据，字符串以 \0 作为结束标记</span></span><br><span class="line"><span class="function">qint64 <span class="title">QIODevice::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *data)</span></span>;</span><br><span class="line"><span class="comment">// 发送参数指定的字符串</span></span><br><span class="line"><span class="function">qint64 <span class="title">QIODevice::write</span><span class="params">(<span class="type">const</span> QByteArray &amp;byteArray)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h2><p>QTcpSocket通信中，使用信号传递双方的状态与要进行的操作：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// readyRead()说明对端发送的数据到达了，接下来可以用read函数接收数据</span></span><br><span class="line">[signal] <span class="function"><span class="type">void</span> <span class="title">QIODevice::readyRead</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// connectToHost连接成功，发出connected()信号</span></span><br><span class="line">[signal] <span class="function"><span class="type">void</span> <span class="title">QAbstractSocket::connected</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 套接字断开连接发出disconnected()信号</span></span><br><span class="line">[signal] <span class="function"><span class="type">void</span> <span class="title">QAbstractSocket::disconnected</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="通信流程"><a href="#通信流程" class="headerlink" title="通信流程"></a>通信流程</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><ol>
<li>创建套接字服务器 QTcpServer 对象</li>
<li>通过 QTcpServer 对象设置监听，即：QTcpServer::listen()</li>
<li>基于 QTcpServer::newConnection() 信号检测是否有新的客户端连接</li>
<li>如果有新的客户端连接调用 QTcpSocket *QTcpServer::nextPendingConnection() 得到通信的套接字对象</li>
<li>使用通信的套接字对象 QTcpSocket 和客户端进行通信</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mainwindow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ui_mainwindow.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget *parent)</span><br><span class="line">    : <span class="built_in">QMainWindow</span>(parent)</span><br><span class="line">    , <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setWindowTitle</span>(<span class="string">&quot;Tcp服务端&quot;</span>);</span><br><span class="line">    ui-&gt;port-&gt;<span class="built_in">setText</span>(<span class="string">&quot;8899&quot;</span>);</span><br><span class="line">    ui-&gt;sendMessage-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建监听对象</span></span><br><span class="line">    tcpServer = <span class="keyword">new</span> <span class="built_in">QTcpServer</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">connect</span>(tcpServer, &amp;QTcpServer::newConnection, <span class="keyword">this</span>, [=]()&#123;</span><br><span class="line">        m_tcp = tcpServer-&gt;<span class="built_in">nextPendingConnection</span>();</span><br><span class="line">        <span class="comment">//m_status-&gt;setPixmap(QPixmap(&quot;:/connect.jpg&quot;).scaled(20, 20));</span></span><br><span class="line">        m_status-&gt;<span class="built_in">setText</span>(<span class="string">&quot;已连接&quot;</span>);</span><br><span class="line">        ui-&gt;sendMessage-&gt;<span class="built_in">setDisabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;record-&gt;<span class="built_in">append</span>(<span class="string">&quot;用户连接了服务器!&quot;</span>);</span><br><span class="line">        <span class="comment">// 检测是否可以接受数据</span></span><br><span class="line">        <span class="built_in">connect</span>(m_tcp, &amp;QTcpSocket::readyRead, <span class="keyword">this</span>, [=]()&#123;</span><br><span class="line">            QByteArray data = m_tcp-&gt;<span class="built_in">readAll</span>();</span><br><span class="line">            ui-&gt;record-&gt;<span class="built_in">append</span>(<span class="string">&quot;客户端say:&quot;</span>+data);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">connect</span>(m_tcp, &amp;QTcpSocket::disconnected, <span class="keyword">this</span>, [=]()&#123;</span><br><span class="line">            m_tcp-&gt;<span class="built_in">close</span>();</span><br><span class="line">            <span class="comment">//m_tcp-&gt;deleteLater();  // 封装了delete操作</span></span><br><span class="line">            <span class="comment">//m_status-&gt;setPixmap(QPixmap(&quot;:/disconnect.jpg&quot;).scaled(20, 20));</span></span><br><span class="line">            m_status-&gt;<span class="built_in">setText</span>(<span class="string">&quot;未连接&quot;</span>);</span><br><span class="line">            ui-&gt;sendMessage-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line">            ui-&gt;record-&gt;<span class="built_in">append</span>(<span class="string">&quot;用户断开了服务器!&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态栏</span></span><br><span class="line">    m_status = <span class="keyword">new</span> QLabel;</span><br><span class="line">    <span class="comment">//m_status-&gt;setPixmap(QPixmap(&quot;:/disconnect.jpg&quot;).scaled(20, 20));</span></span><br><span class="line">    m_status-&gt;<span class="built_in">setText</span>(<span class="string">&quot;未连接&quot;</span>);</span><br><span class="line">    ui-&gt;statusbar-&gt;<span class="built_in">addWidget</span>(<span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;连接状态:&quot;</span>));</span><br><span class="line">    ui-&gt;statusbar-&gt;<span class="built_in">addWidget</span>(m_status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MainWindow::~<span class="built_in">MainWindow</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">delete</span> ui;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_setListen_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> port = ui-&gt;port-&gt;<span class="built_in">text</span>().<span class="built_in">toUShort</span>();</span><br><span class="line">    tcpServer-&gt;<span class="built_in">listen</span>(QHostAddress::Any, port);</span><br><span class="line">    ui-&gt;setListen-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_sendMessage_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    QString msg = ui-&gt;msg-&gt;<span class="built_in">toPlainText</span>();</span><br><span class="line">    m_tcp-&gt;<span class="built_in">write</span>(msg.<span class="built_in">toUtf8</span>());</span><br><span class="line">    ui-&gt;record-&gt;<span class="built_in">append</span>(<span class="string">&quot;服务器say:&quot;</span>+msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><ol>
<li><p>创建通信的套接字类 QTcpSocket 对象</p>
</li>
<li><p>使用服务器端绑定的 IP 和端口连接服务器 QAbstractSocket::connectToHost()</p>
</li>
<li><p>使用 QTcpSocket 对象和服务器进行通信</p>
</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mainwindow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ui_mainwindow.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QHostAddress&gt;</span></span></span><br><span class="line"></span><br><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget *parent)</span><br><span class="line">    : <span class="built_in">QMainWindow</span>(parent)</span><br><span class="line">    , <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setWindowTitle</span>(<span class="string">&quot;Tcp客户端&quot;</span>);</span><br><span class="line">    m_tcp = <span class="keyword">new</span> <span class="built_in">QTcpSocket</span>(<span class="keyword">this</span>);</span><br><span class="line">    ui-&gt;port-&gt;<span class="built_in">setText</span>(<span class="string">&quot;8899&quot;</span>);</span><br><span class="line">    ui-&gt;ip-&gt;<span class="built_in">setText</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    ui-&gt;disconnectBtn-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line">    ui-&gt;sendMessage-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(m_tcp, &amp;QTcpSocket::readyRead, <span class="keyword">this</span>, [=]()&#123;</span><br><span class="line">       QByteArray data = m_tcp-&gt;<span class="built_in">readAll</span>();</span><br><span class="line">       ui-&gt;record-&gt;<span class="built_in">append</span>(<span class="string">&quot;服务端say:&quot;</span>+data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(m_tcp, &amp;QTcpSocket::disconnected, <span class="keyword">this</span>, [=]&#123;</span><br><span class="line">        m_tcp-&gt;<span class="built_in">close</span>();</span><br><span class="line">        <span class="comment">//m_tcp-&gt;deleteLater();</span></span><br><span class="line">        <span class="comment">//m_status-&gt;setPixmap(QPixmap(&quot;:/disconnect.jpg&quot;).scaled(20,20));</span></span><br><span class="line">        m_status-&gt;<span class="built_in">setText</span>(<span class="string">&quot;未连接&quot;</span>);</span><br><span class="line">        ui-&gt;record-&gt;<span class="built_in">append</span>(<span class="string">&quot;断开连接!&quot;</span>);</span><br><span class="line">        ui-&gt;connectBtn-&gt;<span class="built_in">setDisabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;disconnectBtn-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line">        ui-&gt;sendMessage-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(m_tcp, &amp;QTcpSocket::connected, <span class="keyword">this</span>, [=]()&#123;</span><br><span class="line">       m_status-&gt;<span class="built_in">setPixmap</span>(<span class="built_in">QPixmap</span>(<span class="string">&quot;:/connect.jpg&quot;</span>).<span class="built_in">scaled</span>(<span class="number">20</span>, <span class="number">20</span>));</span><br><span class="line">       m_status-&gt;<span class="built_in">setText</span>(<span class="string">&quot;已连接&quot;</span>);</span><br><span class="line">       ui-&gt;record-&gt;<span class="built_in">append</span>(<span class="string">&quot;已经成功连接了服务器！&quot;</span>);</span><br><span class="line">       ui-&gt;connectBtn-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line">       ui-&gt;disconnectBtn-&gt;<span class="built_in">setDisabled</span>(<span class="literal">false</span>);</span><br><span class="line">       ui-&gt;sendMessage-&gt;<span class="built_in">setDisabled</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态栏</span></span><br><span class="line">    m_status = <span class="keyword">new</span> QLabel;</span><br><span class="line">    m_status-&gt;<span class="built_in">setPixmap</span>(<span class="built_in">QPixmap</span>(<span class="string">&quot;:/disconnect.jpg&quot;</span>).<span class="built_in">scaled</span>(<span class="number">20</span>, <span class="number">20</span>));</span><br><span class="line">    ui-&gt;statusbar-&gt;<span class="built_in">addWidget</span>(<span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;连接状态:&quot;</span>));</span><br><span class="line">    ui-&gt;statusbar-&gt;<span class="built_in">addWidget</span>(m_status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MainWindow::~<span class="built_in">MainWindow</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">delete</span> ui;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_connectBtn_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QString ip = ui-&gt;ip-&gt;<span class="built_in">text</span>();</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> port = ui-&gt;port-&gt;<span class="built_in">text</span>().<span class="built_in">toUShort</span>();</span><br><span class="line">    m_tcp-&gt;<span class="built_in">connectToHost</span>(<span class="built_in">QHostAddress</span>(ip), port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_sendMessage_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QString msg = ui-&gt;msg-&gt;<span class="built_in">toPlainText</span>();</span><br><span class="line">    m_tcp-&gt;<span class="built_in">write</span>(msg.<span class="built_in">toUtf8</span>());</span><br><span class="line">    ui-&gt;record-&gt;<span class="built_in">append</span>(<span class="string">&quot;客户端say:&quot;</span>+msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_disconnectBtn_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_tcp-&gt;<span class="built_in">close</span>();</span><br><span class="line">    m_status-&gt;<span class="built_in">setText</span>(<span class="string">&quot;未连接&quot;</span>);</span><br><span class="line">    ui-&gt;connectBtn-&gt;<span class="built_in">setDisabled</span>(<span class="literal">false</span>);</span><br><span class="line">    ui-&gt;disconnectBtn-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line">    ui-&gt;sendMessage-&gt;<span class="built_in">setDisabled</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<img src="/2023/06/01/Qt-socket/image-20230601114255964.png" class="" title="image-20230601114255964">

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/14/MusicPlayer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/14/MusicPlayer/" class="post-title-link" itemprop="url">MusicPlayer</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-05-14 18:51:14" itemprop="dateCreated datePublished" datetime="2023-05-14T18:51:14+08:00">2023-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-01 11:16:52" itemprop="dateModified" datetime="2023-06-01T11:16:52+08:00">2023-06-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Qt实现的音乐播放器"><a href="#Qt实现的音乐播放器" class="headerlink" title="Qt实现的音乐播放器"></a>Qt实现的音乐播放器</h1><p>windows平台下基于Qt Creator 4.11.1实现的类网易云移动端播放界面的音乐播放器。</p>
<p>guthub:<a target="_blank" rel="noopener" href="https://github.com/ZzBobo0915/Qt/tree/main/MusciPlayer">https://github.com/ZzBobo0915/Qt/tree/main/MusciPlayer</a></p>
<img src="/2023/05/14/MusicPlayer/image-20230514185428792.png" class="" title="音乐播放器">

<ul>
<li>实现了根据歌曲播放、暂停、上一首、下一首、播放模式（单曲循环、随机播放、队列循环）、歌词显示、歌曲进度改变（滑动条）、音量增大和音量减小（按钮与滑动条）、关闭提示等基本功能</li>
<li>实现了黑胶底片和摇杆的动态改变</li>
<li>实现了根据打开播放器的时间来实现系统菜单栏显示<img src="/2023/05/14/MusicPlayer/image-20230514185747669.png" class=""></li>
<li>实现了高斯模糊背景的实现</li>
<li>整个程序的UI布局全部使用代码书写，没有使用到Qt设计师工具</li>
</ul>
<h2 id="标题栏titlewindow-h-x2F-cpp"><a href="#标题栏titlewindow-h-x2F-cpp" class="headerlink" title="标题栏titlewindow.h&#x2F;cpp"></a>标题栏titlewindow.h&#x2F;cpp</h2><ul>
<li>最小化</li>
<li>最大化（没用上）</li>
<li>关闭</li>
<li>鼠标界面拖动</li>
</ul>
<p>​    部分主要代码如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">    <span class="comment">// 进行最小化、最大化/还原、关闭操作</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onClicked</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 关闭消息框的操作</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onbuttonClicked</span><span class="params">(QAbstractButton *btnClicked)</span></span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// 双击标题栏进行界面的最大化/还原</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mouseDoubleClickEvent</span><span class="params">(QMouseEvent *event)</span></span>;</span><br><span class="line">    <span class="comment">// 进行鼠界面的拖动</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mousePressEvent</span><span class="params">(QMouseEvent *event)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//标题名称</span></span><br><span class="line">    QLabel *m_TitleLabel;</span><br><span class="line">    <span class="comment">//标题栏最小按钮</span></span><br><span class="line">    QPushButton *m_MinimizeButton;</span><br><span class="line">    <span class="comment">//标题栏最大按钮</span></span><br><span class="line">    QPushButton *m_MaximizeButton;</span><br><span class="line">    <span class="comment">//标题栏关闭按钮</span></span><br><span class="line">    QPushButton *m_CloseButton;</span><br><span class="line">    <span class="comment">//关闭消息框</span></span><br><span class="line">    QMessageBox *m_MessageBox;</span><br><span class="line">    <span class="comment">//消息框最小化按钮</span></span><br><span class="line">    QPushButton *m_MessageMinimize;</span><br><span class="line">    <span class="comment">//消息框关闭按钮</span></span><br><span class="line">    QPushButton *m_MessageQuit;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TitleWindow::onClicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获取用户点击的按钮</span></span><br><span class="line">    QPushButton *Button = <span class="built_in">qobject_cast</span>&lt;QPushButton *&gt;(<span class="built_in">sender</span>());</span><br><span class="line">    <span class="comment">//获取当前窗口指针</span></span><br><span class="line">    QWidget *Window = <span class="keyword">this</span>-&gt;<span class="built_in">window</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果小部件是独立的窗口那么返回true不然的话返回false</span></span><br><span class="line">    <span class="keyword">if</span> (Window-&gt;<span class="built_in">isWindow</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//如果点击的按钮是最小化</span></span><br><span class="line">        <span class="keyword">if</span> (Button == m_MinimizeButton)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//以图标的形式显示窗口</span></span><br><span class="line">            <span class="comment">//Window-&gt;showMinimized();</span></span><br><span class="line">            Window-&gt;<span class="built_in">hide</span>();</span><br><span class="line">        &#125;<span class="comment">//如果点击的是最大化</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Button == m_MaximizeButton)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//放大窗口</span></span><br><span class="line">            Window-&gt;<span class="built_in">isMaximized</span>() ? Window-&gt;<span class="built_in">showNormal</span>() : Window-&gt;<span class="built_in">showMaximized</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Button == m_CloseButton)</span><br><span class="line">        &#123;</span><br><span class="line">            m_MessageBox-&gt;<span class="built_in">exec</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TitleWindow::onbuttonClicked</span><span class="params">(QAbstractButton *btnClicked)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (btnClicked == m_MessageMinimize) &#123;</span><br><span class="line">        QPropertyAnimation *animation = <span class="keyword">new</span> <span class="built_in">QPropertyAnimation</span>(<span class="keyword">this</span>-&gt;<span class="built_in">window</span>(), <span class="string">&quot;windowOpacity&quot;</span>);</span><br><span class="line">        animation-&gt;<span class="built_in">setDuration</span>(<span class="number">1000</span>);</span><br><span class="line">        animation-&gt;<span class="built_in">setStartValue</span>(<span class="number">1</span>);</span><br><span class="line">        animation-&gt;<span class="built_in">setEndValue</span>(<span class="number">0</span>);</span><br><span class="line">        animation-&gt;<span class="built_in">start</span>();</span><br><span class="line">        <span class="comment">//动画结束时发出finished信号触发槽函数关闭主窗口</span></span><br><span class="line">        <span class="built_in">connect</span>(animation, <span class="built_in">SIGNAL</span>(<span class="built_in">finished</span>()), <span class="keyword">this</span>-&gt;<span class="built_in">window</span>(), <span class="built_in">SLOT</span>(<span class="built_in">hide</span>()));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (btnClicked == m_MessageQuit)&#123;</span><br><span class="line">        qApp-&gt;<span class="built_in">closeAllWindows</span>();</span><br><span class="line">        qApp-&gt;<span class="built_in">quit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//整个窗口随标题栏移动</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TitleWindow::mousePressEvent</span><span class="params">(QMouseEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> Q_OS_WIN</span></span><br><span class="line">    <span class="comment">//释放对鼠标的捕获消息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ReleaseCapture</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        QWidget *pWindow = <span class="keyword">this</span>-&gt;<span class="built_in">window</span>();</span><br><span class="line">        <span class="keyword">if</span> (pWindow-&gt;<span class="built_in">isTopLevel</span>())</span><br><span class="line">        &#123;</span><br><span class="line">           <span class="built_in">SendMessage</span>(<span class="built_in">HWND</span>(pWindow-&gt;<span class="built_in">winId</span>()), WM_SYSCOMMAND, SC_MOVE + HTCAPTION, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">       event-&gt;<span class="built_in">ignore</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="高斯模糊gaussianbur-h"><a href="#高斯模糊gaussianbur-h" class="headerlink" title="高斯模糊gaussianbur.h"></a>高斯模糊gaussianbur.h</h2><p>​    对背景图片进行高斯模糊处理，高斯模糊原理参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/mahabharata_/article/details/69066942">https://blog.csdn.net/mahabharata_/article/details/69066942</a></p>
<p>​    主要代码如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对图片做一次横向的模糊</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; in.<span class="built_in">width</span>(); ++x)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; in.<span class="built_in">height</span>(); ++y)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> kx = -halfMatrixSize; kx &lt;= halfMatrixSize; ++kx)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 边界处理后的x值</span></span><br><span class="line">            x1 = <span class="built_in">ReflectIndex</span>(x - kx, in.<span class="built_in">width</span>());</span><br><span class="line">            <span class="function">QColor <span class="title">color</span><span class="params">(in.pixel(x1, y))</span></span>;</span><br><span class="line">            matrixValue = mConvolutionMatrix[kx + halfMatrixSize];</span><br><span class="line">            sumRed += color.<span class="built_in">red</span>() * matrixValue;</span><br><span class="line">            sumBlue += color.<span class="built_in">blue</span>() * matrixValue;</span><br><span class="line">            sumGreen += color.<span class="built_in">green</span>() * matrixValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        QRgb finalColor = <span class="built_in">qRgb</span>(sumRed, sumGreen, sumBlue);</span><br><span class="line">        <span class="comment">// 覆盖回去</span></span><br><span class="line">        image.<span class="built_in">setPixel</span>(x, y, finalColor);</span><br><span class="line">        sumRed = sumGreen = sumBlue = <span class="number">0.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 对图片做一次纵向的模糊，同上</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; in.<span class="built_in">width</span>(); ++x)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; in.<span class="built_in">height</span>(); ++y)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> ky = -halfMatrixSize; ky &lt;= halfMatrixSize; ++ky)</span><br><span class="line">        &#123;</span><br><span class="line">            y1 = <span class="built_in">ReflectIndex</span>(y - ky, in.<span class="built_in">height</span>());</span><br><span class="line">            <span class="function">QColor <span class="title">color</span><span class="params">(image.pixel(x, y1))</span></span>;</span><br><span class="line">            matrixValue = mConvolutionMatrix[ky + halfMatrixSize];</span><br><span class="line">            sumRed += color.<span class="built_in">red</span>() * matrixValue;</span><br><span class="line">            sumBlue += color.<span class="built_in">blue</span>() * matrixValue;</span><br><span class="line">            sumGreen += color.<span class="built_in">green</span>() * matrixValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        QRgb finalColor = <span class="built_in">qRgb</span>(sumRed, sumGreen, sumBlue);</span><br><span class="line">        image.<span class="built_in">setPixel</span>(x, y, finalColor);</span><br><span class="line">        sumRed = sumGreen = sumBlue = <span class="number">0.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="缓存背景图片子线程cachethread-h-x2F-cpp"><a href="#缓存背景图片子线程cachethread-h-x2F-cpp" class="headerlink" title="缓存背景图片子线程cachethread.h&#x2F;cpp"></a>缓存背景图片子线程cachethread.h&#x2F;cpp</h2><p>​    创建子线程用来缓存背景图片，对音乐列表中的每一个碟片进行高斯模型并保存在cache文件中。</p>
<p>​    关键代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启线程调用</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Cachethread::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; m_ResourceName.<span class="built_in">size</span>();++i)</span><br><span class="line">    &#123;</span><br><span class="line">        QPixmap pixmap;</span><br><span class="line">        QString BackgroundPath;</span><br><span class="line">        BackgroundPath  =   m_ResourcePath    +   <span class="string">&quot;/&quot;</span>     +   m_ResourceName.<span class="built_in">at</span>(i) + <span class="string">&quot;.png&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">QFileInfo <span class="title">file</span><span class="params">(QApplication::applicationDirPath()    +   <span class="string">&quot;/Cache&quot;</span>     +</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="string">&quot;/&quot;</span>     +   m_ResourceName.at(i)    +   <span class="string">&quot;.png&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(file.<span class="built_in">exists</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pixmap.<span class="built_in">load</span>(BackgroundPath);</span><br><span class="line">        <span class="function">QSize   <span class="title">picSize</span><span class="params">(m_MainWindow-&gt;width()*<span class="number">1.2</span>,m_MainWindow-&gt;height()*<span class="number">1.2</span>)</span></span>;</span><br><span class="line">        QPixmap scaledPixmap = pixmap.<span class="built_in">scaled</span>(picSize);</span><br><span class="line">        QPixmap scaledPixmap2 = scaledPixmap.<span class="built_in">copy</span>(m_MainWindow-&gt;<span class="built_in">pos</span>().<span class="built_in">x</span>()+<span class="number">30</span>,</span><br><span class="line">                                                  m_MainWindow-&gt;<span class="built_in">pos</span>().<span class="built_in">y</span>()+<span class="number">30</span>,</span><br><span class="line">                                                  m_MainWindow-&gt;<span class="built_in">width</span>(),m_MainWindow-&gt;<span class="built_in">height</span>());</span><br><span class="line">        QImage Image = scaledPixmap2.<span class="built_in">toImage</span>();</span><br><span class="line">        QImage img = m_blur-&gt;<span class="built_in">BlurImage</span>(Image);</span><br><span class="line">        BackgroundPath  =   QApplication::<span class="built_in">applicationDirPath</span>()    +   <span class="string">&quot;/Cache&quot;</span>     +</span><br><span class="line">                <span class="string">&quot;/&quot;</span>     +   m_ResourceName.<span class="built_in">at</span>(i)    +   <span class="string">&quot;.png&quot;</span>;</span><br><span class="line">        img.<span class="built_in">save</span>(BackgroundPath);</span><br><span class="line">        m_MainWindow-&gt;<span class="built_in">update</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="基类主窗口basiwindow-h-x2F-cpp"><a href="#基类主窗口basiwindow-h-x2F-cpp" class="headerlink" title="基类主窗口basiwindow.h&#x2F;cpp"></a>基类主窗口basiwindow.h&#x2F;cpp</h2><ul>
<li>阴影窗口</li>
<li>设置窗口圆角</li>
<li>自定义背景</li>
</ul>
<p>​    主要代码如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//阴影窗口</span></span><br><span class="line">    QWidget* m_EffectWindow;</span><br><span class="line">    <span class="comment">//窗口阴影实例</span></span><br><span class="line">    QGraphicsDropShadowEffect * m_shadow;</span><br><span class="line">    <span class="comment">//窗口主要布局</span></span><br><span class="line">    QVBoxLayout*m_VmainLayout;</span><br><span class="line">    <span class="comment">//自定义背景</span></span><br><span class="line">    <span class="type">bool</span> BackgroundState;</span><br><span class="line">    <span class="comment">//自定义背景路径</span></span><br><span class="line">    QString BackgroundPath;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">//设置窗口圆角;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">paintEvent</span><span class="params">(QPaintEvent *event)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//设置窗口阴影</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setWindowEffect</span><span class="params">(<span class="type">int</span> w,<span class="type">int</span> h)</span></span>;</span><br><span class="line">    <span class="comment">//创建标题栏</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createTitlew</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//高斯背景图</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//重写paintEvent事件</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Basiwindow::paintEvent</span><span class="params">(QPaintEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(event);  <span class="comment">// QUNUSED用来告诉编译器其中的变量没有使用，不需要提示警告</span></span><br><span class="line">    <span class="function">QPainter <span class="title">painter</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">    painter.<span class="built_in">setRenderHint</span>(QPainter::SmoothPixmapTransform);  <span class="comment">// 线性插值</span></span><br><span class="line">    painter.<span class="built_in">setRenderHint</span>(QPainter::Antialiasing);  <span class="comment">// 反锯齿;</span></span><br><span class="line">    painter.<span class="built_in">save</span>();</span><br><span class="line">    QRect rect = <span class="keyword">this</span>-&gt;<span class="built_in">rect</span>();</span><br><span class="line">    painter.<span class="built_in">setPen</span>(Qt::transparent);</span><br><span class="line">    <span class="keyword">if</span>(BackgroundState == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        painter.<span class="built_in">setBrush</span>(<span class="built_in">QBrush</span>(<span class="built_in">QColor</span>(<span class="number">230</span>,<span class="number">230</span>,<span class="number">230</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        QPixmap blurImage;</span><br><span class="line">        <span class="comment">// 如果读取到图片</span></span><br><span class="line">        <span class="keyword">if</span>(blurImage.<span class="built_in">load</span>(BackgroundPath))</span><br><span class="line">        &#123;</span><br><span class="line">            m_blurImage     =   blurImage.<span class="built_in">toImage</span>();</span><br><span class="line"></span><br><span class="line">            QBrush brush;</span><br><span class="line">            brush.<span class="built_in">setTextureImage</span>(<span class="built_in">QImage</span>(m_blurImage));</span><br><span class="line">            painter.<span class="built_in">setBrush</span>(brush);</span><br><span class="line">            <span class="comment">//painter.drawImage(-150,-150,m_blurImage,0,0,this-&gt;width()*2,this-&gt;height()*2);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没有读取到则默认黑色</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            painter.<span class="built_in">setBrush</span>(<span class="built_in">QBrush</span>(<span class="built_in">QColor</span>(<span class="number">230</span>,<span class="number">230</span>,<span class="number">230</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rect.<span class="built_in">setWidth</span>(rect.<span class="built_in">width</span>());</span><br><span class="line">    rect.<span class="built_in">setHeight</span>(rect.<span class="built_in">height</span>());</span><br><span class="line">    painter.<span class="built_in">drawRoundedRect</span>(rect, <span class="number">8</span>, <span class="number">8</span>);  <span class="comment">// 绘制带有圆角的矩形，8为圆度，0时为直角，99时为最大圆度</span></span><br><span class="line">    QWidget::<span class="built_in">paintEvent</span>(event);           <span class="comment">// 转发到基类的事件处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="胶片、摇杆区域mylovewindow-h-x2F-cpp"><a href="#胶片、摇杆区域mylovewindow-h-x2F-cpp" class="headerlink" title="胶片、摇杆区域mylovewindow.h&#x2F;cpp"></a>胶片、摇杆区域mylovewindow.h&#x2F;cpp</h2><ul>
<li>胶片的动态转动</li>
<li>摇杆的改变</li>
</ul>
<p>​    主要代码如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//黑胶片的timer</span></span><br><span class="line">    QTimer *        m_RestoreCover;</span><br><span class="line">    <span class="comment">//回复杆的timer</span></span><br><span class="line">    QTimer *        m_RecoveryRod;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span>             m_Increasing;</span><br><span class="line">    QString         m_Love;</span><br><span class="line">    <span class="comment">//黑胶片转动的角度，会有定时器来改变它</span></span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//转动杆的转动角度，会有定时器来改变它</span></span><br><span class="line">    <span class="type">int</span> j=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//设置音乐封面</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setCoverSeting</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//绘制事件，所有的动态实现就在这里面实现的</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">paintEvent</span><span class="params">(QPaintEvent *event)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyLoveWindow::changeCover</span><span class="params">()</span><span class="comment">//转动黑胶片的槽函数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    i+=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(i&gt;<span class="number">360</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        i=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">update</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyLoveWindow::changeRod</span><span class="params">()</span><span class="comment">//摇杆改变的槽函数</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    j-=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(j&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_RecoveryRod-&gt;<span class="built_in">stop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">update</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理歌词、播放时间的子线程thread-h-x2F-cpp"><a href="#处理歌词、播放时间的子线程thread-h-x2F-cpp" class="headerlink" title="处理歌词、播放时间的子线程thread.h&#x2F;cpp"></a>处理歌词、播放时间的子线程thread.h&#x2F;cpp</h2><ul>
<li>歌词的动态改变</li>
<li>播放时间的动态改变</li>
</ul>
<p>​    代码都很主要，在github中产看，这里是重点！</p>
<h2 id="主窗口dialog-h-x2F-cpp"><a href="#主窗口dialog-h-x2F-cpp" class="headerlink" title="主窗口dialog.h&#x2F;cpp"></a>主窗口dialog.h&#x2F;cpp</h2><p>​    继承自basiwindow.h把功能都集成到一起，并设计UI布局。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/NVAS_CN/article/details/122658874">https://blog.csdn.net/NVAS_CN/article/details/122658874</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/" class="post-title-link" itemprop="url">Qt知识点</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-05-06 11:34:09" itemprop="dateCreated datePublished" datetime="2023-05-06T11:34:09+08:00">2023-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-01 11:16:54" itemprop="dateModified" datetime="2023-06-01T11:16:54+08:00">2023-06-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1:01</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Qt笔记"><a href="#Qt笔记" class="headerlink" title="Qt笔记"></a>Qt笔记</h2><h3 id="Qt的几个基类"><a href="#Qt的几个基类" class="headerlink" title="Qt的几个基类"></a>Qt的几个基类</h3><ul>
<li><p>QObject：所有能够处理signal、slot和事件的Qt对象的基类</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QObject::<span class="built_in">Qobject</span>(Qobject* parent=<span class="number">0</span>, <span class="type">const</span> <span class="type">char</span>* name=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>QApplication：负责GUI应用程序的控制流和主要设置，包括主事件循环体，负责处理和调度来自窗口系统和其他资源的事件，并且处理应用程序的开始、结束及会话管理</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QApplication&gt;</span></span></span><br><span class="line">....</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Qt Creator提供的三个默认基类：</p>
<ul>
<li>QWidget：是所有用户接口对象的基类，继承了QObject的属性，窗口部件是用户界面的一个基本单元，从窗口系统接收鼠标、键盘和其他消息</li>
<li>QMainWIndow：提供一个带有菜单栏，工具栏和一个状态条的主应用程序窗口。</li>
<li>QDialog：是对话框窗口的基类，对话框窗口主要用于短期任务和用户进行短期通讯的顶级窗口，可以是模态对话框或非模态对话框，支持扩展并带有返回值</li>
</ul>
<h3 id="最简单的Qt应用程序"><a href="#最简单的Qt应用程序" class="headerlink" title="最简单的Qt应用程序"></a>最简单的Qt应用程序</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;widget.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QApplication&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">    Widget w;</span><br><span class="line">    w.<span class="built_in">show</span>();</span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Qt系统提供的类头文件没有.h后缀</li>
<li>Qt一个类对应一个头文件，类名和头文件名一致</li>
<li>在Qt生命中，包括Qt主消息循环，在其中完成来自窗口系统和其他资源的所有事件处理和销毁</li>
<li>对于任何一个Qt应用程序，都正好只存在一个QApplication对象</li>
</ul>
<h3 id="pro文件"><a href="#pro文件" class="headerlink" title=".pro文件"></a>.pro文件</h3><p>​    .pro文件就是工程文件，是qmake自动生成用于生成makeflie的配置文件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">QT       += core gui</span><br><span class="line"></span><br><span class="line"><span class="built_in">greaterThan</span>(QT_MAJOR_VERSION, <span class="number">4</span>): QT += widgets</span><br><span class="line"></span><br><span class="line">CONFIG += c++<span class="number">11</span></span><br><span class="line"></span><br><span class="line"># The following define makes your compiler emit warnings <span class="keyword">if</span> you use</span><br><span class="line"><span class="meta"># any Qt feature that has been marked deprecated (the exact warnings</span></span><br><span class="line"><span class="meta"># depend on your compiler). Please consult the documentation of the</span></span><br><span class="line"><span class="meta"># deprecated API in order to know how to port your code away from it.</span></span><br><span class="line">DEFINES += QT_DEPRECATED_WARNINGS</span><br><span class="line"></span><br><span class="line"># You can also make your code fail to compile <span class="keyword">if</span> it uses deprecated APIs.</span><br><span class="line"># In order to <span class="keyword">do</span> so, uncomment the following line.</span><br><span class="line"># You can also select to disable deprecated APIs only up to a certain version of Qt.</span><br><span class="line">#DEFINES += QT_DISABLE_DEPRECATED_BEFORE=<span class="number">0x060000</span>    <span class="meta"># disables all the APIs deprecated before Qt 6.0.0</span></span><br><span class="line"></span><br><span class="line">SOURCES += \</span><br><span class="line">    main.cpp \</span><br><span class="line">    newwindow.cpp \</span><br><span class="line">    widget.cpp</span><br><span class="line"></span><br><span class="line">HEADERS += \</span><br><span class="line">    newwindow.h \</span><br><span class="line">    widget.h</span><br><span class="line"></span><br><span class="line"># Default rules <span class="keyword">for</span> deployment.</span><br><span class="line">qnx: target.path = /tmp/$$&#123;TARGET&#125;/bin</span><br><span class="line"><span class="keyword">else</span>: unix:!android: target.path = /opt/$$&#123;TARGET&#125;/bin</span><br><span class="line">!<span class="built_in">isEmpty</span>(target.path): INSTALLS += target</span><br></pre></td></tr></table></figure>

<h3 id="QPushButton按钮"><a href="#QPushButton按钮" class="headerlink" title="QPushButton按钮"></a>QPushButton按钮</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QPushButton&gt;</span></span></span><br><span class="line">...</span><br><span class="line">    <span class="comment">// 第一种创建</span></span><br><span class="line">    QPushButton *btn1 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;button1&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    btn-&gt;<span class="built_in">move</span>(<span class="number">100</span>,<span class="number">100</span>);</span><br><span class="line">    <span class="comment">// 第二种创建</span></span><br><span class="line">    QPushButton *btn2 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>();</span><br><span class="line">    btn2-&gt;<span class="built_in">setParent</span>(<span class="keyword">this</span>);</span><br><span class="line">    btn2-&gt;<span class="built_in">setTitle</span>(<span class="string">&quot;button2&quot;</span>);</span><br><span class="line">    btn-&gt;<span class="built_in">move</span>(<span class="number">100</span>,<span class="number">100</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>​    创建按钮对象需要给他绑定一个父窗口（父亲对象），创建时绑定或者利用setParent绑定后就存在了父子关系，在有父窗口的情况下，窗口调用show会显示在父窗口中。</p>
<p>​    <strong>Qt的坐标是以左上角为(0,0)，以右为x轴正方向，以下为y轴正方向。</strong></p>
<h3 id="对象树模型"><a href="#对象树模型" class="headerlink" title="对象树模型"></a>对象树模型</h3><p>​    QObject是Qt中绝大部分类的根类，对象之间是以对象树的形式组织起来的：</p>
<ul>
<li>对象树能够自动、有效的组织和管理继承来组QObject的Qt对象</li>
<li>当两个对象建立父子关系时，子对象加入父对象的一个成员变量children的list中</li>
<li>当父对象析构时，这个列表中的所有对象也会被析构</li>
<li>当然也可由手动删除子对象，当子对象析构时会发出一个destroyed信号给父对象，父对象收到后会从children的list中删除这个子对象</li>
<li><strong>这种对象树保证了如果有孩子就自动delete每个孩子，并且保证没有任何QObject对象会被析构两次</strong></li>
<li><strong>在Qt中尽量在构造时就指定parent对象，并且大胆在堆上创建</strong></li>
</ul>
<h3 id="信号和槽机制"><a href="#信号和槽机制" class="headerlink" title="信号和槽机制"></a>信号和槽机制</h3><p>​    信号就是各类事件，槽（槽函数）为响应信号的动作。当某个事件发生后，会发送一个信号，某个对象接收到了这个信号，就会做一些相关的处理动作，也就是槽SLOT，但是这种关系是需要手动建立链接connect：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	sender:信号发送者</span></span><br><span class="line"><span class="comment">	singal:信号（函数指针）</span></span><br><span class="line"><span class="comment">	recevier:信号接收者</span></span><br><span class="line"><span class="comment">	slot:接收对象调用的槽函数（函数指针）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="built_in">connect</span>(sender, signal, recevier, slot);</span><br><span class="line">QObject::<span class="built_in">connecnt</span>(sender, <span class="built_in">SIGNAL</span>(signal), recevier, <span class="built_in">SLOT</span>(slot));</span><br><span class="line"><span class="comment">//Qt5中connect可以有第五个参数type，指明槽和信号的关联方式，决定了信号是立刻传送到一个槽还是稍后时间排队等待传送</span></span><br><span class="line"><span class="built_in">connect</span>(sender, signal, recevier, slot, Qt::ConnectionType type=Qt::AutoConnection);</span><br></pre></td></tr></table></figure>

<ul>
<li>一个信号可以连接多个槽，但是槽的调用顺序是不确定的</li>
<li>一个信号可以连接另一个信号</li>
<li>一个槽可以接收多个信号</li>
</ul>
<p>​    可以使用系统自带的信号和槽，也可以自定义信号和槽：</p>
<p>​    <strong>自定义信号的使用条件</strong>：</p>
<ul>
<li><p>声明在类的signals域下</p>
</li>
<li><p>没有返回值，void类型的函数</p>
</li>
<li><p>只有声明，没有定义</p>
</li>
<li><p>可以有参数，可以有重载</p>
</li>
<li><p>可以在成员函数中通过emit关键字来触发信号</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">send</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="function">emit <span class="title">testcall</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">testcall</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 可以通过QObject::sender()获取发送信号者</span></span><br><span class="line">QSpinBox *spinBox = qobject_cast&lt;QSpinBox*&gt;)(<span class="built_in">sender</span>());</span><br></pre></td></tr></table></figure></li>
</ul>
<p>​    <strong>自定义槽的使用条件：</strong></p>
<ul>
<li>qt4必须声明在public&#x2F;private&#x2F;protected slots域下面，qt5后可以声明在public下，同时可以是静态的成员函数，全局函数，lambda表达式</li>
<li>没有返回值，void类型的函数</li>
<li>不仅有声名，还需要定义实现</li>
<li>可以有参数，可以重载</li>
<li>自定义槽的类需要在类声明最开始处使用 <code>Q_OBJECT</code></li>
</ul>
<p>​    <strong>ps：信号函数的参数个数必须大于等于槽函数的参数个数；并且信号函数的参数类型和槽函数的参数类型必须一一对应。并且可以使用 <code>disconnect</code>函数取消链接</strong></p>
<h4 id="Qt中的槽函数与信号量五种连接方式"><a href="#Qt中的槽函数与信号量五种连接方式" class="headerlink" title="Qt中的槽函数与信号量五种连接方式"></a>Qt中的槽函数与信号量五种连接方式</h4><p>​    即Qt::ConnectionType的五种：</p>
<ul>
<li>Qt::DirectConnection直连方式（信号与槽函数关系类似于函数调用，同步执行）</li>
<li>Qt::QueuedConnection队列方式（此时信号被阻塞在消息队列中，信号与槽函数的关系类似于消息通信，异步执行）</li>
<li>Qt::AutoConnection自动方式（Qt默认的连接方式，如果信号发出与接受的对象处于同一线程则与直连方式相同，否则与队列方式相同）</li>
<li>Qt::BlockQueuedConnection阻塞队列方式（信号和槽必须在不同的线程中，否则会产生死锁）</li>
<li>Qt::UniqueConnection唯一方式（与默认工作方式相同，只是不能重复连接相同的信号和槽）</li>
</ul>
<h3 id="QMainWindow类"><a href="#QMainWindow类" class="headerlink" title="QMainWindow类"></a>QMainWindow类</h3><img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230329092549068.png" class="">

<p>​    QMainWindow为用户提供主窗口程序，包含：</p>
<ul>
<li>一个菜单栏</li>
<li>多个工具栏</li>
<li>多个停靠部件</li>
<li>一个状态栏</li>
<li>一个中心部件</li>
</ul>
<h4 id="菜单栏"><a href="#菜单栏" class="headerlink" title="菜单栏"></a>菜单栏</h4><p>​    一个主窗口最多只有一个菜单栏，位于主窗口顶部、主窗口标题栏下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">QMenuBar *mb = <span class="keyword">this</span>-&gt;<span class="built_in">menuBar</span>();                       <span class="comment">// 获取主窗口的菜单栏</span></span><br><span class="line">QMenu *menuFile = mb-&gt;<span class="built_in">addMenu</span>(<span class="string">&quot;文件&quot;</span>);                <span class="comment">// addMenu添加菜单</span></span><br><span class="line">QAction *actionCreate = menuFile-&gt;<span class="built_in">addAction</span>(<span class="string">&quot;新建&quot;</span>);  <span class="comment">// 向菜单中添加菜单项</span></span><br><span class="line">menuFile-&gt;<span class="built_in">addSeparator</span>();                             <span class="comment">// 添加分隔符</span></span><br><span class="line"><span class="comment">// 添加二级菜单</span></span><br><span class="line">QMenu *menuRecent = menuFile-&gt;<span class="built_in">addMenu</span>(<span class="string">&quot;最近打开的文件&quot;</span>);</span><br><span class="line">QAction *recentone = menuRecent-&gt;<span class="built_in">addAction</span>(<span class="string">&quot;1.txt&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>​    Qt没有专门的菜单项类，只是用QAction类抽象出公共的动作。</p>
<h4 id="工具栏"><a href="#工具栏" class="headerlink" title="工具栏"></a>工具栏</h4><p>​    主窗口的工具栏上可以有很多个工具条，通常采用一个菜单对应一个工具条的方式，也可以根据需要对工具条进行划分。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QToolBar *toolBar = <span class="keyword">this</span>-&gt;<span class="built_in">addToolBar</span>(<span class="string">&quot;工具栏&quot;</span>);  <span class="comment">// 创建一个新的工具栏</span></span><br><span class="line">toolBar-&gt;<span class="built_in">addAction</span>(actionCreate);                <span class="comment">// addAction插入属于工具栏的项</span></span><br><span class="line"><span class="comment">// 工具条是一个可以移动的窗口，由Qt::xxxToolBarAreas决定</span></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">addToolBar</span>(Qt::LeftToolBarAreas, toolBar); </span><br><span class="line"><span class="comment">// 可以使用setAllowAreas来限制工具条的位置范围</span></span><br><span class="line">toolBar-&gt;<span class="built_in">setAllowedAreas</span>(Qt::LeftToolBarArea | Qt::RightToolBarArea);</span><br><span class="line">toolBar-&gt;<span class="built_in">setFloatable</span>(<span class="literal">false</span>);                    <span class="comment">// 设置工具栏不可以浮动</span></span><br><span class="line">toolBar-&gt;<span class="built_in">setMoveable</span>(<span class="literal">false</span>);                     <span class="comment">// 设置工具栏不可以拖动</span></span><br></pre></td></tr></table></figure>

<h4 id="状态栏"><a href="#状态栏" class="headerlink" title="状态栏"></a>状态栏</h4><p>​    一个QMainWindow最多只有一个状态栏：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">QStatusBar *sb = <span class="keyword">this</span>-&gt;<span class="built_in">statucBar</span>();               <span class="comment">// 获取状态栏</span></span><br><span class="line">QLabel *labelLeft = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;左侧信息&quot;</span>,<span class="keyword">this</span>);  <span class="comment">// 创建信息</span></span><br><span class="line">sb-&gt;<span class="built_in">addWidget</span>(labelLeft);                         <span class="comment">// 左侧添加小部件</span></span><br><span class="line">QLabel *labelRight = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;右侧信息&quot;</span>,<span class="keyword">this</span>);</span><br><span class="line">sb-&gt;<span class="built_in">addPermanentWidget</span>(labelRight);               <span class="comment">// 右侧添加小部件</span></span><br></pre></td></tr></table></figure>

<h4 id="停靠部件（浮动窗口）"><a href="#停靠部件（浮动窗口）" class="headerlink" title="停靠部件（浮动窗口）"></a>停靠部件（浮动窗口）</h4><p>​    停靠部件QDockWidget可以有很多个：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">QDockWidget *dockWidget = <span class="keyword">new</span> <span class="built_in">QDockWidget</span>(<span class="string">&quot;停靠部件&quot;</span>, <span class="keyword">this</span>);  <span class="comment">// 创建停靠部件</span></span><br><span class="line"><span class="comment">// 添加到mainWindow中，设置默认在下</span></span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">addDockWidget</span>(Qt::BottomDockWidgetArea, dockWidghet);  </span><br><span class="line"><span class="comment">// 设置允许停靠的范围</span></span><br><span class="line">dickWidget-&gt;<span class="built_in">setAllowedAreas</span>(Qt::BottomDockWidgetArea | Qt::LeftDockWidgetArea | Qt::RightDockWidgetArea);</span><br></pre></td></tr></table></figure>

<h4 id="核心部件（中心部件）"><a href="#核心部件（中心部件）" class="headerlink" title="核心部件（中心部件）"></a>核心部件（中心部件）</h4><p>​    除了以上几个部件，中间显示的都可以称为核心部件，例如一个编辑框控件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QTextEdit *textEdte = <span class="keyword">new</span> <span class="built_in">QTextEdit</span>(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">this</span>-&gt;<span class="built_in">setCentralWidget</span>(textEdit);           <span class="comment">// 设置核心部件</span></span><br></pre></td></tr></table></figure>

<h3 id="Qt容器组件"><a href="#Qt容器组件" class="headerlink" title="Qt容器组件"></a>Qt容器组件</h3><p>​    Qt中有九种容器组件：</p>
<ul>
<li>组合框QGroupBox</li>
<li>滚动区QScrollArea</li>
<li>工具箱QToolBox</li>
<li>选项卡QTabWidget</li>
<li>控件栈QWidgetStack</li>
<li>框架QFrame</li>
<li>组件QWidget</li>
<li>MDI窗口显示区QMdiArea</li>
<li>停靠窗口QDockWidget</li>
</ul>
<h4 id="1-组合框QGroupBox"><a href="#1-组合框QGroupBox" class="headerlink" title="1.组合框QGroupBox"></a>1.组合框QGroupBox</h4><p>   构建分组框，通常带有一个边框和一个标题栏</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">QDialog dialog;</span><br><span class="line">QGroupBox *group = <span class="keyword">new</span> <span class="built_in">QGroupBox</span>(<span class="string">&quot;option&quot;</span>);</span><br><span class="line">group-&gt;<span class="built_in">setCheckable</span>(<span class="literal">true</span>);</span><br><span class="line">group-&gt;<span class="built_in">setChecked</span>(<span class="literal">true</span>);</span><br><span class="line">QRadioButton *radio1 = <span class="keyword">new</span> <span class="built_in">QRadioButton</span>(<span class="string">&quot;banana&quot;</span>);</span><br><span class="line">QRadioButton *radio2 = <span class="keyword">new</span> <span class="built_in">QRadioButton</span>(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">QRadioButton *radio3 = <span class="keyword">new</span> <span class="built_in">QRadioButton</span>(<span class="string">&quot;orange&quot;</span>);</span><br><span class="line">radio1-&gt;<span class="built_in">setChecked</span>(<span class="literal">true</span>);</span><br><span class="line">QCheckBox *check = <span class="keyword">new</span> <span class="built_in">QCheckBox</span>(<span class="string">&quot;rice&quot;</span>);</span><br><span class="line">check-&gt;<span class="built_in">setChecked</span>(<span class="literal">true</span>);</span><br><span class="line">QVBoxLayout *vbox = <span class="keyword">new</span> QVBoxLayout;</span><br><span class="line">vbox-&gt;<span class="built_in">addWidget</span>(radio1);</span><br><span class="line">vbox-&gt;<span class="built_in">addWidget</span>(radio2);</span><br><span class="line">vbox-&gt;<span class="built_in">addWidget</span>(radio3);</span><br><span class="line">vbox-&gt;<span class="built_in">addWidget</span>(check);</span><br><span class="line">group-&gt;<span class="built_in">setLayout</span>(vbox);</span><br><span class="line">dialog.<span class="built_in">setLayout</span>(vbox);</span><br><span class="line">dialog.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404081346416.png" class="">

<h4 id="2-QScrollArea滚动区"><a href="#2-QScrollArea滚动区" class="headerlink" title="2.QScrollArea滚动区"></a>2.QScrollArea滚动区</h4><p>​    用来显示子控件的内容的框架，如果子控件的尺寸超过了框架的大小，可以使用滚动条，方便查看整个子控件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">QScrollArea::<span class="built_in">QScrollArea</span>(QWidget *parent=<span class="number">0</span>);   <span class="comment">// 构造滚动区，父对象为parent</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QScrollArea::setWidget</span><span class="params">(QWidget *widget)</span></span>;  <span class="comment">// 设置widget为滚动区的子控件</span></span><br><span class="line"><span class="function">QWidget *<span class="title">QSrollArea::takeWidget</span><span class="params">()</span></span>;             <span class="comment">// 删除子控件</span></span><br><span class="line"><span class="function">QWidget *<span class="title">QScrollArea::widget</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">// 返回子空间</span></span><br><span class="line">...</span><br><span class="line">    Widget w;</span><br><span class="line">    QLabel *label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(&amp;w);</span><br><span class="line">    <span class="function">QImage <span class="title">image</span><span class="params">(<span class="string">&quot;C:\\Users\\zhuzhibo\\Pictures\\tupian2.jpg&quot;</span>)</span></span>;</span><br><span class="line">    QHBoxLayout *layout = <span class="keyword">new</span> <span class="built_in">QHBoxLayout</span>(&amp;w);</span><br><span class="line">    label-&gt;<span class="built_in">setPixmap</span>(QPixmap::<span class="built_in">fromImage</span>(image));</span><br><span class="line">    QScrollArea *scrollarea = <span class="keyword">new</span> <span class="built_in">QScrollArea</span>(&amp;w);</span><br><span class="line">    scrollarea-&gt;<span class="built_in">setWidget</span>(label);       <span class="comment">// 加入滚动区</span></span><br><span class="line">    scrollarea-&gt;<span class="built_in">setWidgetResizable</span>(<span class="number">1</span>);  <span class="comment">// 自动改变滚动区大小</span></span><br><span class="line">    scrollarea-&gt;<span class="built_in">setBackgroundRole</span>(QPalette::Dark);  <span class="comment">// 设置滚动区背景颜色</span></span><br><span class="line">    layout-&gt;<span class="built_in">addWidget</span>(scrollarea);</span><br><span class="line">    w.<span class="built_in">setLayout</span>(layout);</span><br><span class="line">    w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404081442226.png" class="">

<h4 id="3-QToolBox工具箱"><a href="#3-QToolBox工具箱" class="headerlink" title="3.QToolBox工具箱"></a>3.QToolBox工具箱</h4><p>​    提供了一系列的页和隔间，类似QToolBar：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QToolBox::<span class="built_in">QToolBox</span>(QWidget *parent=<span class="number">0</span>, <span class="type">const</span> <span class="type">char</span>* name=<span class="number">0</span>, QFlags f=<span class="number">0</span>);<span class="comment">// 创建ToolBox</span></span><br><span class="line"><span class="comment">// 增加一个item到ToolBox的底部，设置新增的itme的icon和label</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ToolBox::addItem</span><span class="params">(QWidget *item, <span class="type">const</span> QIconSet &amp;iconSet, <span class="type">const</span> QString &amp;label)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ToolBox::count</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 返回工具箱中的数目</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ToolBox::currentIndex</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 返回当前活动的索引</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ToolBox::currentItem</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 返回当前活动的item为空返回0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ToolBox</span> : <span class="keyword">public</span> QToolBox</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">ToolBox</span><span class="params">(QWidget *parent=<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QToolButton *button1;</span><br><span class="line">    QToolButton *button2;</span><br><span class="line">    QToolButton *button3;</span><br><span class="line">    QToolButton *button11;</span><br><span class="line">    QToolButton *button12;</span><br><span class="line">&#125;;</span><br><span class="line">ToolBox::<span class="built_in">ToolBox</span>(QWidget *parent) :</span><br><span class="line">    <span class="built_in">QToolBox</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">setWindowTitle</span>(<span class="string">&quot;ToolBox&quot;</span>);</span><br><span class="line">    <span class="comment">// 水果</span></span><br><span class="line">    button1 = <span class="keyword">new</span> QToolButton;</span><br><span class="line">    button1-&gt;<span class="built_in">setText</span>(<span class="string">&quot;apple&quot;</span>);</span><br><span class="line">    button1-&gt;<span class="built_in">setAutoRaise</span>(<span class="literal">true</span>);</span><br><span class="line">    button1-&gt;<span class="built_in">setToolButtonStyle</span>(Qt::ToolButtonFollowStyle);</span><br><span class="line">    button2 = <span class="keyword">new</span> QToolButton;</span><br><span class="line">    button2-&gt;<span class="built_in">setText</span>(<span class="string">&quot;banana&quot;</span>);</span><br><span class="line">    button2-&gt;<span class="built_in">setAutoRaise</span>(<span class="literal">true</span>);</span><br><span class="line">    button2-&gt;<span class="built_in">setToolButtonStyle</span>(Qt::ToolButtonTextBesideIcon);</span><br><span class="line">    button3 = <span class="keyword">new</span> QToolButton;</span><br><span class="line">    button3-&gt;<span class="built_in">setText</span>(<span class="string">&quot;orange&quot;</span>);</span><br><span class="line">    button3-&gt;<span class="built_in">setAutoRaise</span>(<span class="literal">true</span>);</span><br><span class="line">    button3-&gt;<span class="built_in">setToolButtonStyle</span>(Qt::ToolButtonTextBesideIcon);</span><br><span class="line">    <span class="comment">// 添加水果</span></span><br><span class="line">    QGroupBox *group = <span class="keyword">new</span> QGroupBox;</span><br><span class="line">    QVBoxLayout *layout = <span class="keyword">new</span> <span class="built_in">QVBoxLayout</span>(group);</span><br><span class="line">    layout-&gt;<span class="built_in">setMargin</span>(<span class="number">10</span>);</span><br><span class="line">    layout-&gt;<span class="built_in">setAlignment</span>(Qt::AlignHCenter);</span><br><span class="line">    layout-&gt;<span class="built_in">addWidget</span>(button1);</span><br><span class="line">    layout-&gt;<span class="built_in">addWidget</span>(button2);</span><br><span class="line">    layout-&gt;<span class="built_in">addWidget</span>(button3);</span><br><span class="line">    layout-&gt;<span class="built_in">addStretch</span>();  <span class="comment">// 增加伸缩量</span></span><br><span class="line">    <span class="comment">// 初始化电脑</span></span><br><span class="line">    button11 = <span class="keyword">new</span> QToolButton;</span><br><span class="line">    button11-&gt;<span class="built_in">setText</span>(<span class="string">&quot;HP&quot;</span>);</span><br><span class="line">    button11-&gt;<span class="built_in">setAutoRaise</span>(<span class="literal">true</span>);</span><br><span class="line">    button11-&gt;<span class="built_in">setToolButtonStyle</span>(Qt::ToolButtonTextBesideIcon);</span><br><span class="line">    button12 = <span class="keyword">new</span> QToolButton;</span><br><span class="line">    button12-&gt;<span class="built_in">setText</span>(<span class="string">&quot;Lenovo&quot;</span>);</span><br><span class="line">    button12-&gt;<span class="built_in">setAutoRaise</span>(<span class="literal">true</span>);</span><br><span class="line">    button12-&gt;<span class="built_in">setToolButtonStyle</span>(Qt::ToolButtonTextBesideIcon);</span><br><span class="line">    <span class="comment">// 添加电脑</span></span><br><span class="line">    QGroupBox *group2 = <span class="keyword">new</span> QGroupBox;</span><br><span class="line">    QVBoxLayout *layout2 = <span class="keyword">new</span> <span class="built_in">QVBoxLayout</span>(group2);</span><br><span class="line">    layout2-&gt;<span class="built_in">setMargin</span>(<span class="number">10</span>);</span><br><span class="line">    layout2-&gt;<span class="built_in">setAlignment</span>(Qt::AlignHCenter);</span><br><span class="line">    layout2-&gt;<span class="built_in">addWidget</span>(button11);</span><br><span class="line">    layout2-&gt;<span class="built_in">addWidget</span>(button12);</span><br><span class="line">    layout2-&gt;<span class="built_in">addStretch</span>();</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">addItem</span>((QWidget*)group, <span class="string">&quot;Fruits&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">addItem</span>((QWidget*)group2, <span class="string">&quot;Computer&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403105925525.png" class="">

<h4 id="4-QTabWidget选项卡"><a href="#4-QTabWidget选项卡" class="headerlink" title="4.QTabWidget选项卡"></a>4.QTabWidget选项卡</h4><p>​    QTabWidget选项卡组件顶部或底部有一个标签选项栏，每个标签选项都有一个页面，选择那个页面，只需要点击对应的标签即可，或者按指定ALT+字母快捷键组合即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QTabWidget::<span class="built_in">QTabWidget</span>(QWdiget *parent=<span class="number">0</span>, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>, WFlags=<span class="number">0</span>);  <span class="comment">// 构造</span></span><br><span class="line"><span class="comment">// 增加子页child到QTabWidget对象中</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTabWidget::addTab</span><span class="params">(QWidget *child, <span class="type">const</span> QString &amp;label)</span>[<span class="keyword">virtual</span>]</span>;</span><br><span class="line"><span class="comment">// 同上，多一个icon图标</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTabWidget::addTab</span><span class="params">(QWidget *child, <span class="type">const</span> QIconSet &amp;iconset, <span class="type">const</span> QString &amp;label)</span>[<span class="keyword">virtual</span>]</span>;</span><br><span class="line"><span class="comment">// 在index处插入新的子页，要确保新的label与QTabWidget中存在的子页名不同</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTabWidget::insertTab</span><span class="params">(QWidget *child, <span class="type">const</span> QString &amp;label, <span class="type">int</span> index=<span class="number">-1</span>)</span>[<span class="keyword">virtual</span>]</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTabWidget::removePage</span><span class="params">(QWidget *w)</span>[<span class="keyword">virtual</span> slot]</span>;  <span class="comment">//删除子页w</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">QWidget *w = <span class="keyword">new</span> <span class="built_in">QWidget</span>(tab);</span><br><span class="line">QPushButton *btn1 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;Ok&quot;</span>, w);</span><br><span class="line">QPushButton *btn2 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;No&quot;</span>, w);</span><br><span class="line">QHBoxLayout *layout = <span class="keyword">new</span> <span class="built_in">QHBoxLayout</span>(w);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(btn1);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(btn2);</span><br><span class="line">tab-&gt;<span class="built_in">addTab</span>(w, <span class="string">&quot;option1&quot;</span>);</span><br><span class="line"><span class="comment">// 第二页</span></span><br><span class="line">QLabel* label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;Qt&quot;</span>, tab);</span><br><span class="line">tab-&gt;<span class="built_in">addTab</span>(label, <span class="string">&quot;option2&quot;</span>);</span><br><span class="line">tab-&gt;<span class="built_in">setWindowTitle</span>(<span class="string">&quot;TabWidget&quot;</span>);</span><br><span class="line">tab-&gt;<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403110652975.png" class="">

<h4 id="5-QStackedWidget控件栈"><a href="#5-QStackedWidget控件栈" class="headerlink" title="5.QStackedWidget控件栈"></a>5.QStackedWidget控件栈</h4><p>​    QStackedWidget控件栈可以使开发人员使用栈管理控件，控件栈只会显示栈顶的控件，可以使用raiseWidget()把栈中任何其他控件移动到栈顶。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QWidgetStack::<span class="built_in">QWidgetStack</span>(QWidget *parent=<span class="number">0</span>, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>);  <span class="comment">// 构造</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">QWidgetStack::addWidget</span><span class="params">(QWidget *w, <span class="type">int</span> id=<span class="number">-1</span>)</span></span>;  <span class="comment">// 把w添加栈中，标识为id</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QWdigetStack::id</span><span class="params">(QWidget *w)</span> <span class="type">const</span></span>;  <span class="comment">// 返回w的标识</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QWidgetStack::raiseWidget</span><span class="params">(<span class="type">int</span> id)</span>[slot]</span>;  <span class="comment">// 把id的控件升到栈顶</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QWidgetStack::raiseWidget</span><span class="params">(QWidget *w)</span>[slot]</span>;  <span class="comment">// 把控件w升到栈顶</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QWidgetStack::removeWidget</span><span class="params">(QWidget *w)</span></span>;  <span class="comment">// 把控件w从栈中删除</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QWidgetStack::removeWidget</span><span class="params">(<span class="type">int</span> id)</span> <span class="type">const</span></span>;  <span class="comment">// 把id的控件从栈中删除</span></span><br><span class="line"><span class="function">QWidget *<span class="title">QWidgetStack::widget</span><span class="params">(<span class="type">int</span> id)</span> <span class="type">const</span></span>;  <span class="comment">// 返回id的控件</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">QDialog w;</span><br><span class="line">w.<span class="built_in">setWindowTitle</span>(<span class="string">&quot;StackedWidget&quot;</span>);</span><br><span class="line"><span class="comment">// 设置列表框</span></span><br><span class="line">QListWidget *leftlist = <span class="keyword">new</span> <span class="built_in">QListWidget</span>(&amp;w);</span><br><span class="line">leftlist-&gt;<span class="built_in">insertItem</span>(<span class="number">0</span>, <span class="string">&quot;window1&quot;</span>);</span><br><span class="line">leftlist-&gt;<span class="built_in">insertItem</span>(<span class="number">1</span>, <span class="string">&quot;window2&quot;</span>);</span><br><span class="line">leftlist-&gt;<span class="built_in">insertItem</span>(<span class="number">2</span>, <span class="string">&quot;window3&quot;</span>);</span><br><span class="line"><span class="comment">// 设置堆栈窗体</span></span><br><span class="line">QLabel *label1 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;WindowTest1\n\tby liming&quot;</span>);</span><br><span class="line">QLabel *label2 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;WindowTest2\n\tby liming&quot;</span>);</span><br><span class="line">QLabel *label3 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;WindowTest3\n\tby liming&quot;</span>);</span><br><span class="line">QStackedWidget *stack = <span class="keyword">new</span> <span class="built_in">QStackedWidget</span>(&amp;w);</span><br><span class="line">stack-&gt;<span class="built_in">addWidget</span>(label1);</span><br><span class="line">stack-&gt;<span class="built_in">addWidget</span>(label2);</span><br><span class="line">stack-&gt;<span class="built_in">addWidget</span>(label3);</span><br><span class="line"><span class="comment">// 设置主窗体布局</span></span><br><span class="line">QHBoxLayout *mainLayout = <span class="keyword">new</span> <span class="built_in">QHBoxLayout</span>(&amp;w);</span><br><span class="line">mainLayout-&gt;<span class="built_in">setMargin</span>(<span class="number">50</span>);  <span class="comment">// 相对左上角的偏移</span></span><br><span class="line">mainLayout-&gt;<span class="built_in">setSpacing</span>(<span class="number">5</span>);  <span class="comment">// 设置布局中每个部件的间隔</span></span><br><span class="line">mainLayout-&gt;<span class="built_in">addWidget</span>(leftlist);</span><br><span class="line">mainLayout-&gt;<span class="built_in">addWidget</span>(stack, <span class="number">0</span>, Qt::AlignCenter);</span><br><span class="line">mainLayout-&gt;<span class="built_in">setStretchFactor</span>(leftlist, <span class="number">1</span>);  <span class="comment">// 第二个参数大于0表示部件可伸缩</span></span><br><span class="line">mainLayout-&gt;<span class="built_in">setStretchFactor</span>(stack, <span class="number">3</span>);</span><br><span class="line">w.<span class="built_in">connect</span>(leftlist, &amp;QListWidget::currentRowChanged, stack, &amp;QStackedWidget::setCurrentIndex);</span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403141935545.png" class="">

<h4 id="6-QFrame框架"><a href="#6-QFrame框架" class="headerlink" title="6.QFrame框架"></a>6.QFrame框架</h4><p>​    QFrame是有框架的窗口部件的基类，用来存放其他控件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构建一个框架风格为NoFrame并且1像素框架宽度的框架窗口部件</span></span><br><span class="line">QFrame::<span class="built_in">QFrame</span>(QWidget *parent=<span class="number">0</span>, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>, WFlags f=<span class="number">0</span>); </span><br><span class="line"><span class="comment">// QFrame::Shadow枚举值如下</span></span><br><span class="line">QFrame::Plain 框架和内容看起来和周围一样高</span><br><span class="line">QFrame::Raised 框架和内容看起来突起</span><br><span class="line">QFrame::Sunken 框架和内容看起来凹陷</span><br><span class="line">QFrame::MShadow 内容的，对于阴影的掩码</span><br><span class="line"><span class="comment">// QFrame::Shape枚举值如下</span></span><br><span class="line">QFrame::NoFrame QFrame不画任何东西</span><br><span class="line">QFrame::Box 周围画一个框</span><br><span class="line">QFrame::Panel 画一个平板使内容看起来更凹陷或突起</span><br><span class="line">QFrame::WinPanel 和Panel差不多</span><br><span class="line">QFrame::HLine 绘制一个水平线，但是没有框任何东西</span><br><span class="line">QFrame::VLine 绘制一个竖直线，但是没有任何东西</span><br><span class="line">QFrame::StyledPanel 调用QStyle::<span class="built_in">drawPanel</span>()</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">QWidget *win = <span class="keyword">new</span> QWidget;</span><br><span class="line">QLabel *label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;Box&quot;</span>);</span><br><span class="line">label-&gt;<span class="built_in">setFrameStyle</span>(QFrame::Box | QFrame::Raised);</span><br><span class="line">QLabel *label1 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;Panel&quot;</span>);</span><br><span class="line">QLabel *label2 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;Winpanel&quot;</span>);</span><br><span class="line">QLabel *label3 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;H line&quot;</span>);</span><br><span class="line">QLabel *label4 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;V line&quot;</span>);</span><br><span class="line">QLabel *label5 = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;Styled Panel&quot;</span>);</span><br><span class="line">label-&gt;<span class="built_in">setFrameStyle</span>(QFrame::Box | QFrame::Raised);</span><br><span class="line">label-&gt;<span class="built_in">setLineWidth</span>(<span class="number">2</span>);</span><br><span class="line">label1-&gt;<span class="built_in">setFrameStyle</span>(QFrame::Panel | QFrame::Raised);</span><br><span class="line">label1-&gt;<span class="built_in">setLineWidth</span>(<span class="number">2</span>);</span><br><span class="line">label2-&gt;<span class="built_in">setFrameStyle</span>(QFrame::WinPanel | QFrame::Raised);</span><br><span class="line">label2-&gt;<span class="built_in">setLineWidth</span>(<span class="number">2</span>);</span><br><span class="line">label3-&gt;<span class="built_in">setFrameStyle</span>(QFrame::HLine | QFrame::Raised);</span><br><span class="line">label3-&gt;<span class="built_in">setLineWidth</span>(<span class="number">2</span>);</span><br><span class="line">label4-&gt;<span class="built_in">setFrameStyle</span>(QFrame::VLine | QFrame::Raised);</span><br><span class="line">label4-&gt;<span class="built_in">setLineWidth</span>(<span class="number">2</span>);</span><br><span class="line">label5-&gt;<span class="built_in">setFrameStyle</span>(QFrame::StyledPanel | QFrame::Sunken);</span><br><span class="line">label5-&gt;<span class="built_in">setLineWidth</span>(<span class="number">2</span>);</span><br><span class="line">QVBoxLayout *layout = <span class="keyword">new</span> QVBoxLayout;</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(label);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(label1);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(label2);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(label3);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(label4);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(label5);</span><br><span class="line">win-&gt;<span class="built_in">setLayout</span>(layout);</span><br><span class="line">win-&gt;<span class="built_in">showMaximized</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403143608657.png" class="">

<h4 id="7-QWidget组件"><a href="#7-QWidget组件" class="headerlink" title="7.QWidget组件"></a>7.QWidget组件</h4><p>​    QWidget类是所有用户界面对象的基类。</p>
<h4 id="8-QMdiArea多文档区域组件"><a href="#8-QMdiArea多文档区域组件" class="headerlink" title="8.QMdiArea多文档区域组件"></a>8.QMdiArea多文档区域组件</h4><p>​    又称作MDI窗口显示区（Multiple Document Interface），适用于完成一项工作时需要使用多个文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QMdiArea::<span class="built_in">QMdiArea</span>(QWidget *parent=<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QMdiArea::activateNextSubWindow</span><span class="params">()</span>[slot]</span>;  <span class="comment">// 激活下一个窗口</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QMdiArea::activatePreviousSubWindow</span><span class="params">()</span>[slot]</span>;  <span class="comment">// 激活上一个窗口</span></span><br><span class="line"><span class="function">QMdiAreaWindow *<span class="title">QMdiArea::activateSubWindow</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 返回当前活动窗口</span></span><br><span class="line"><span class="comment">// 添加一个新的子窗口事件</span></span><br><span class="line"><span class="function">QMdiAreaWindow *<span class="title">QMdiArea::addSubWindow</span><span class="params">(QWidget *widget, Qt::WindwoFlags windowFlags=<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QMdiArea::closeActiveSubWindow</span><span class="params">()</span>[slot]</span>;  <span class="comment">// 关闭当前活动窗口</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QMdiArea::closeAllSubWindow</span><span class="params">()</span>[slot]</span>;  <span class="comment">// 关闭所有活动窗口</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">QMdiArea *mdi = <span class="keyword">new</span> QMdiArea;</span><br><span class="line">QMdiSubWindow *sub = <span class="keyword">new</span> QMdiSubWindow;</span><br><span class="line">QLabel *label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;label&quot;</span>);</span><br><span class="line">sub-&gt;<span class="built_in">setWidget</span>(label);</span><br><span class="line">sub-&gt;<span class="built_in">setAttribute</span>(Qt::WA_DeleteOnClose);  <span class="comment">// 关闭窗口就将他删除</span></span><br><span class="line">mdi-&gt;<span class="built_in">addSubWindow</span>(sub);</span><br><span class="line">mdi-&gt;<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403145427690.png" class="">

<h4 id="9-QDockWidget停靠窗体"><a href="#9-QDockWidget停靠窗体" class="headerlink" title="9.QDockWidget停靠窗体"></a>9.QDockWidget停靠窗体</h4><p>​    <a href="####停靠部件（浮动窗口）">同这里</a></p>
<h3 id="Qt按钮事件"><a href="#Qt按钮事件" class="headerlink" title="Qt按钮事件"></a>Qt按钮事件</h3><p>​    Qt中一共有六种按钮事件，分别为：</p>
<ul>
<li>按压按钮QPushButton</li>
<li>工具按钮QToolButton</li>
<li>单选按钮QRadioButton</li>
<li>多选按钮QCheckBox</li>
<li>命令链接按钮QCommandLinkButton</li>
<li>按钮盒QButtonBox</li>
</ul>
<h4 id="1-QPushButton组件"><a href="#1-QPushButton组件" class="headerlink" title="1.QPushButton组件"></a>1.QPushButton组件</h4><p>​    <a href="###QPushButton按钮">同这里</a></p>
<h4 id="2-QRadioButton单选按钮组件"><a href="#2-QRadioButton单选按钮组件" class="headerlink" title="2.QRadioButton单选按钮组件"></a>2.QRadioButton单选按钮组件</h4><p>​    提供两个或多个互斥选项，一般配合QButtonGroup使用</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QRadioButton::<span class="built_in">QRadioButton</span>(<span class="type">const</span> QString &amp;text, QWidget *parent, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QRadioButton::isChecked</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 返回是否选中单选按钮</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QAbstracButton::setText</span><span class="params">(<span class="type">const</span> QString&amp;)</span></span>;  <span class="comment">// 设置组件上显示的文本</span></span><br><span class="line"><span class="function">QString <span class="title">QAbstractButton::tect</span><span class="params">()</span> <span class="type">const</span></span>; <span class="comment">// 返回按钮的文本</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QAbstractButton::stateChanged</span><span class="params">(<span class="type">int</span> state)</span>[signal]</span>;  <span class="comment">// checked被更改时发送信号</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QRadioButton::setChecked</span><span class="params">(<span class="type">bool</span> check)</span>[<span class="keyword">virtual</span> slot]</span>;  <span class="comment">// 设置单选按钮是否被选中</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> : <span class="keyword">public</span> QWidget</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Widget</span>(QWidget *parent = <span class="number">0</span>);</span><br><span class="line">    ~<span class="built_in">Widget</span>();</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QButtonGroup *group;</span><br><span class="line">    QRadioButton *appleradio;</span><br><span class="line">    QRadioButton *bananaradio;</span><br><span class="line">    QRadioButton *pearradio;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onRadioClick</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line">Widget::<span class="built_in">Widget</span>(QWidget *parent)</span><br><span class="line">    : <span class="built_in">QWidget</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    group = <span class="keyword">new</span> <span class="built_in">QButtonGroup</span>(<span class="keyword">this</span>);</span><br><span class="line">    appleradio = <span class="keyword">new</span> <span class="built_in">QRadioButton</span>(<span class="string">&quot;apple&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    appleradio-&gt;<span class="built_in">move</span>(<span class="number">5</span>, <span class="number">5</span>);</span><br><span class="line">    bananaradio = <span class="keyword">new</span> <span class="built_in">QRadioButton</span>(<span class="string">&quot;banana&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    bananaradio-&gt;<span class="built_in">move</span>(<span class="number">5</span>, <span class="number">25</span>);</span><br><span class="line">    pearradio = <span class="keyword">new</span> <span class="built_in">QRadioButton</span>(<span class="string">&quot;pear&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    pearradio-&gt;<span class="built_in">move</span>(<span class="number">5</span>, <span class="number">50</span>);</span><br><span class="line">    group-&gt;<span class="built_in">addButton</span>(appleradio, <span class="number">0</span>);</span><br><span class="line">    group-&gt;<span class="built_in">addButton</span>(bananaradio, <span class="number">1</span>);</span><br><span class="line">    group-&gt;<span class="built_in">addButton</span>(pearradio, <span class="number">2</span>);</span><br><span class="line">    appleradio-&gt;<span class="built_in">setChecked</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//多个QRadioButton连接到onRadioClick()</span></span><br><span class="line">    <span class="built_in">connect</span>(appleradio, <span class="built_in">SIGNAL</span>(<span class="built_in">clicked</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">onRadioClick</span>()));</span><br><span class="line">    <span class="built_in">connect</span>(bananaradio, <span class="built_in">SIGNAL</span>(<span class="built_in">clicked</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">onRadioClick</span>()));</span><br><span class="line">    <span class="built_in">connect</span>(pearradio, <span class="built_in">SIGNAL</span>(<span class="built_in">clicked</span>()), <span class="keyword">this</span>, <span class="built_in">SLOT</span>(<span class="built_in">onRadioClick</span>()));</span><br><span class="line">&#125;</span><br><span class="line">Widget::~<span class="built_in">Widget</span>()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Widget::onRadioClick</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(group-&gt;<span class="built_in">checkedId</span>())</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;apple&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;banana&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;pear&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403151848357.png" class="">

<h4 id="3-QCheckBox多选按钮组件"><a href="#3-QCheckBox多选按钮组件" class="headerlink" title="3.QCheckBox多选按钮组件"></a>3.QCheckBox多选按钮组件</h4><p>​    复选框可以提供多选多，有三种状态：checked、unchecked和PartiallyChecked。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QCheckBox::<span class="built_in">QCheckBox</span>(<span class="type">const</span> QString &amp;text, QWidget *parent, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QCheckBox::isChecked</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 是否选中复选框</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QAbstractButton::setText</span><span class="params">(<span class="type">const</span> QString &amp;)</span></span>;</span><br><span class="line"><span class="function">QString <span class="title">QAbstractButton::text</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QAbstractButton::stateChanged</span><span class="params">(<span class="type">int</span> state)</span>[signal]</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QCheckBox::setChecked</span><span class="params">(<span class="type">bool</span> check)</span>[<span class="keyword">virtual</span> slot]</span>; <span class="comment">//设置复选框是否选中，状态为check</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QVBoxLayout *vlayout = <span class="keyword">new</span> <span class="built_in">QVBoxLayout</span>(&amp;w);</span><br><span class="line">QCheckBox *check1 = <span class="keyword">new</span> <span class="built_in">QCheckBox</span>(<span class="string">&quot;check1&quot;</span>, &amp;w);</span><br><span class="line">QCheckBox *check2 = <span class="keyword">new</span> <span class="built_in">QCheckBox</span>(<span class="string">&quot;check2&quot;</span>, &amp;w);</span><br><span class="line">QCheckBox *check3 = <span class="keyword">new</span> <span class="built_in">QCheckBox</span>(<span class="string">&quot;check3&quot;</span>, &amp;w);</span><br><span class="line">vlayout-&gt;<span class="built_in">addWidget</span>(check1);</span><br><span class="line">vlayout-&gt;<span class="built_in">addWidget</span>(check2);</span><br><span class="line">vlayout-&gt;<span class="built_in">addWidget</span>(check3);</span><br><span class="line">w.<span class="built_in">setLayout</span>(vlayout);</span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403152533080.png" class="">

<h4 id="4-QToolButton工具按钮组件"><a href="#4-QToolButton工具按钮组件" class="headerlink" title="4.QToolButton工具按钮组件"></a>4.QToolButton工具按钮组件</h4><p>​    一种用于命令或者选项的可以快速访问的按钮，通常用在Toolbar里面，工具按钮通常显示的是图标，而不是文本标签，ToolButton支持自动浮起，在自动浮起模式中，按钮只有在鼠标指向它的时候才绘制三维的框架。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">QPoolButton::<span class="built_in">QToolButton</span>(QWidget *parent, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>);</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">构造一个名为name，父对象为parent(必须为QToolbar)的工具按钮</span></span><br><span class="line"><span class="comment">工具按钮显示iconSet，工具提示为textLabel</span></span><br><span class="line"><span class="comment">状态条信息为grouptext，同时将工具按钮连接到receiver对象的槽函数上</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">QToolButton::<span class="built_in">QToolButton</span>(<span class="type">const</span> QIconset &amp;iconSet, <span class="type">const</span> QString &amp;textLabel, <span class="type">const</span> QString &amp;grouptext, QObject *reciver, <span class="type">const</span> <span class="type">char</span> *slot, QToolBar *parent, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 把工具按钮构造成箭头按钮，type为箭头方向:LeftArrow\RightArrow\UpArrow\DownArrow</span></span><br><span class="line">QToolButton::<span class="built_in">QToolButton</span>(ArrowType type, QWidget *parent, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QToolButton::setAutoRaise</span><span class="params">(<span class="type">bool</span> enable)</span></span>;  <span class="comment">// 设置是否自动浮起</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">设置ToolButton的样式，style有以下样式</span></span><br><span class="line"><span class="comment">Qt::ToolButtonIconOnly 只显示图标</span></span><br><span class="line"><span class="comment">Qt::ToolButtonTextOnly 只显示文本</span></span><br><span class="line"><span class="comment">Qt::ToolButtonTextBesideIcon 文本在图标旁边</span></span><br><span class="line"><span class="comment">Qt::ToolButtonTextUnderIcon 文本显示在图标下面</span></span><br><span class="line"><span class="comment">Qt::ToolButtonFollowStyle 根据QStyle::StyleHint进行设置</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QToolButton::setToolButtonStyle</span><span class="params">(Qt::ToolButtonStyle style)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">设置ToolButton的菜单淡出方式ToolButtonPopupMode，有以下方式：</span></span><br><span class="line"><span class="comment">QToolButton::DelayedPopup 延迟弹出</span></span><br><span class="line"><span class="comment">QToolButton::MenuButtonPopup 菜单弹出</span></span><br><span class="line"><span class="comment">QToolButton::InstantPopup 点击立刻弹出</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setPopupMode</span><span class="params">(ToolButtonPopupMode mode)</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">QToolButton *btn = <span class="keyword">new</span> <span class="built_in">QToolButton</span>(<span class="keyword">this</span>);</span><br><span class="line">btn-&gt;<span class="built_in">setText</span>(<span class="string">&quot;ToolButton&quot;</span>);</span><br><span class="line">QMenu *menu = <span class="keyword">new</span> <span class="built_in">QMenu</span>();</span><br><span class="line">menu-&gt;<span class="built_in">addMenu</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">menu-&gt;<span class="built_in">addMenu</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">menu-&gt;<span class="built_in">addMenu</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">btn-&gt;<span class="built_in">setToolButtonStyle</span>(Qt::ToolButtonTextOnly);</span><br><span class="line">btn-&gt;<span class="built_in">setPopupMode</span>(QToolButton::InstantPopup);</span><br><span class="line">btn-&gt;<span class="built_in">setMenu</span>(menu);</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403155309303.png" class="">

<h4 id="5-QCommandLinkButton命令链接按钮组件"><a href="#5-QCommandLinkButton命令链接按钮组件" class="headerlink" title="5.QCommandLinkButton命令链接按钮组件"></a>5.QCommandLinkButton命令链接按钮组件</h4><p>​    继承自QPushButton，用于在互斥选项中选择一项，QCommandLinkButton除带有正常的按钮上的文字描述文本外，默认情况下，将携带一个箭头图标，表明按下按钮将打开另一个窗口或页面。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QCommandLinkButton::<span class="built_in">QCommandLinkButton</span>(<span class="type">const</span> QString &amp;text, QWidget *parenr=<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 构造一个描述文本为description的命令链接按钮</span></span><br><span class="line">QCommandLinkButton::<span class="built_in">QCommandLinkButton</span>(<span class="type">const</span> QString &amp;text, <span class="type">const</span> QString &amp;description, QWidget *parent=<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QButton::clicked</span><span class="params">()</span>[signal]</span>;  <span class="comment">// 点击发送信号</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QButton::pressed</span><span class="params">()</span>[signal]  <span class="comment">// 按下发送信号</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QButton::released</span><span class="params">()</span>[signal]</span>;  <span class="comment">// 松开发送信号</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QButton::setText</span><span class="params">(<span class="type">const</span> QString&amp;)</span></span>;  <span class="comment">// 设置显示文本</span></span><br><span class="line"><span class="function">QString <span class="title">QButton::text</span><span class="params">()</span> <span class="type">const</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="6-QDialogButtonBox按钮盒组件"><a href="#6-QDialogButtonBox按钮盒组件" class="headerlink" title="6.QDialogButtonBox按钮盒组件"></a>6.QDialogButtonBox按钮盒组件</h4><p>​    可以快速地布置一组按钮，有水平和垂直样式。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造一个按钮盒，排列方向为orinatation</span></span><br><span class="line">QDialogButtonBox::<span class="built_in">QDialogButtonBox</span>(Qt::Orientation orientation, QWidget *parent=<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QDialogButtonBox::accepted</span><span class="params">()</span>[signal]</span>;  <span class="comment">// 点击发送信号</span></span><br><span class="line"><span class="comment">// 向按钮盒中添加按钮，定义按钮的角色为role</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QDialogButtonBox::addButton</span><span class="params">(QAbstracButton *button, ButtonRole role)</span></span>;</span><br><span class="line"><span class="function">QPushButton *<span class="title">QDialogButtonBox::addButton</span><span class="params">(StandarButton button)</span></span>;  <span class="comment">// 添加标准按钮</span></span><br><span class="line"><span class="comment">// 创建一个文本为text的的按钮，以指定角色添加到按钮盒，如果role无效则不创建</span></span><br><span class="line"><span class="function">QPushButton *<span class="title">QDialogButtonBox::addButton</span><span class="params">(<span class="type">const</span> QString &amp;text, ButtonRole role)</span></span>; </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QDialogButtonBox::clear</span><span class="params">()</span></span>;  <span class="comment">// 清空按钮盒</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QDialogButtonBox *button = <span class="keyword">new</span> <span class="built_in">QDialogButtonBox</span>(&amp;w);</span><br><span class="line">button-&gt;<span class="built_in">setStandardButtons</span>(QDialogButtonBox::Apply|QDialogButtonBox::Cancel|QDialogButtonBox::Ok);</span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230403165714930.png" class="">

<h3 id="Model-x2F-View框架"><a href="#Model-x2F-View框架" class="headerlink" title="Model&#x2F;View框架"></a>Model&#x2F;View框架</h3><img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230418110843184.png" class="">

<p>​    model&#x2F;view是一种从视图中分离数据的技术。可以允许使用不同界面显示同一数据，也能够在不改变数据的情况下添加新的显示界面，引入了委托，可以为编辑渲染数据提供编辑器。视图是显示和编辑数据的界面组件，模型是视图与原始数据之间的接口，代理为编辑数据提供编辑器。</p>
<h3 id="Qt模型"><a href="#Qt模型" class="headerlink" title="Qt模型"></a>Qt模型</h3><img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230418110721945.png" class="">

<p>​    所有的模型都是QAbstractItemModel的子类QAbstractItemModel类定义了供视图和委托访问数据的接口，Qt内置了多种标准模型：</p>
<ul>
<li>QStringListModel：继承自QAbstractListModel，存储简单的字符串列表</li>
<li>QStandardItemModel：可以用于树结构的存储，提供了层次数据</li>
<li>QFileSystemModel：本地系统的文件与目录信息</li>
<li>QSqlQueryModel、QSqlTableModel、QSqlRelationalTableModel：存取数据库数据</li>
</ul>
<p>​    为了使数据的显示同存储分离，引入了索引模型，通过索引模型可以访问模型的特定元素的特定部分，视图和委托使用模型索引来请求所需要的数据；索引又分为持久索引(QPersistentModeIndex)与临时索引(QModelIndex)为了定位模型中的数据，需要三个属性：行号、列号、父索引。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QModelIndex index = model-&gt;<span class="built_in">index</span>(row, column, parent);</span><br></pre></td></tr></table></figure>

<h4 id="1-QFileSystemModel"><a href="#1-QFileSystemModel" class="headerlink" title="1.QFileSystemModel"></a>1.QFileSystemModel</h4><p>​    提供一个可用于访问本机系统的数据模型</p>
<h4 id="2-QStringListModel"><a href="#2-QStringListModel" class="headerlink" title="2.QStringListModel"></a>2.QStringListModel</h4><p>​    用于处理字符串列表的数据模型</p>
<h4 id="3-QStandardItemModel"><a href="#3-QStandardItemModel" class="headerlink" title="3.QStandardItemModel"></a>3.QStandardItemModel</h4><p>​    标准的以项数据为基础的标准数据模型类</p>
<h3 id="Delegate代理类"><a href="#Delegate代理类" class="headerlink" title="Delegate代理类"></a>Delegate代理类</h3><p>​    代理一般实现标准模型做不到的事情，将需要的控件委托给模型代理，然后再在视图上显示出来。代理类通常都要继承 <code>QItemDelegate</code> 或 <code>QStyledItemDelegate</code>，二者之间的差距就是后者可以使用当前的样式表来绘制组件。自定义的代理类必须重写父类中的以下四个函数：</p>
<ul>
<li><pre><code class="c++">  // 创建需要的编辑组件并返回
  QWidget *createEditor(QWidget *parent, 
                        const QStyleOptionViewItem &amp;option,
                        const QModelIndex &amp;index) const Q_DECL_OVERRIDE;
  // 从数据模型中获取数值，显示到代理组件中
  void setEditorData(QWidget *editor,
                     const QModelIndex &amp;index) const Q_DECL_OVERRIDE;
  // 将代理编辑器上的值更新给数据模型
  void setModelData(QWidget *editor,
                    QAbstractItemModel *model,
                    const QModelIndex &amp;index) const Q_DECL_OVERRIDE;
  // 为代理组件设置一个合适的大小
  void updateEditorGometry(QWdiget *editor,
                           const QStyleOptionViewItem &amp;option,
                           const ModelIndex &amp;index) const Q_DECL_OVERRIDE;
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">### Qt单元视图组件</span><br><span class="line"></span><br><span class="line">​    Qt中有五种单元视图组件：</span><br><span class="line"></span><br><span class="line">- 列表视图QListView</span><br><span class="line">- 树状视图QTreeView</span><br><span class="line">- 表格视图QTableView</span><br><span class="line">- 列视图QColumnView</span><br><span class="line">- 表头视图QHeaderView</span><br><span class="line"></span><br><span class="line">#### 1.QListView列表视图</span><br><span class="line"></span><br><span class="line">​    基于模型的列表/图标视图，不显示表头和表框：</span><br><span class="line"></span><br><span class="line">```c++</span><br><span class="line">class Widget : public QWidget</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    Widget(const QStringList &amp;leaders, QWidget *parent = nullptr);</span><br><span class="line">    ~Widget();</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    QStringListModel *model;</span><br><span class="line">    QListView *listView;</span><br><span class="line">    QDialogButtonBox *buttonBox;</span><br><span class="line"></span><br><span class="line">private slots:</span><br><span class="line">    void onDelete();</span><br><span class="line">    void onInsert();</span><br><span class="line">&#125;;</span><br><span class="line">Widget::Widget(const QStringList &amp;leaders, QWidget *parent)</span><br><span class="line">    : QWidget(parent)</span><br><span class="line">&#123;</span><br><span class="line">    model = new QStringListModel(this);</span><br><span class="line">    model-&gt;setStringList(leaders);</span><br><span class="line">    listView = new QListView;</span><br><span class="line">    listView-&gt;setModel(model);</span><br><span class="line">    // 设置触发编辑的条件</span><br><span class="line">    listView-&gt;setEditTriggers(QAbstractItemView::AnyKeyPressed</span><br><span class="line">                              | QAbstractItemView::DoubleClicked);</span><br><span class="line">    buttonBox = new QDialogButtonBox;</span><br><span class="line">    QPushButton *insertButton = buttonBox-&gt;addButton(</span><br><span class="line">                tr(&quot;&amp;Insert&quot;),QDialogButtonBox::ActionRole);</span><br><span class="line">    QPushButton *deleteButton = buttonBox-&gt;addButton(</span><br><span class="line">                tr(&quot;&amp;Delete&quot;), QDialogButtonBox::ActionRole);</span><br><span class="line">    connect(insertButton, SIGNAL(clicked()), this, SLOT(onInsert()));</span><br><span class="line">    connect(deleteButton, SIGNAL(clicked()), this, SLOT(onDelete()));</span><br><span class="line">    QVBoxLayout *layout = new QVBoxLayout;</span><br><span class="line">    layout-&gt;addWidget(listView);</span><br><span class="line">    layout-&gt;addWidget(buttonBox);</span><br><span class="line">    setLayout(layout);</span><br><span class="line">    setWindowTitle(tr(&quot;QStringListModel&quot;));</span><br><span class="line">&#125;</span><br><span class="line">void Widget::onDelete()</span><br><span class="line">&#123;</span><br><span class="line">    // 删除当前行</span><br><span class="line">    model-&gt;removeRows(listView-&gt;currentIndex().row(), 1);</span><br><span class="line">&#125;</span><br><span class="line">void Widget::onInsert()</span><br><span class="line">&#123;</span><br><span class="line">    int row = listView-&gt;currentIndex().row();</span><br><span class="line">    model-&gt;insertRows(row, 1);</span><br><span class="line">    QModelIndex index = model-&gt;index(row);</span><br><span class="line">    listView-&gt;setCurrentIndex(index);</span><br><span class="line">    listView-&gt;edit(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404083756051.png" class="">

<h4 id="2-QTreeView树形视图"><a href="#2-QTreeView树形视图" class="headerlink" title="2.QTreeView树形视图"></a>2.QTreeView树形视图</h4><p>​    也是基于模型的列表&#x2F;视图：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">QSplitter *spliter = <span class="keyword">new</span> QSplitter;</span><br><span class="line">QDirModel *model = <span class="keyword">new</span> QDirModel;</span><br><span class="line"><span class="comment">// 从缺省目录创建数据</span></span><br><span class="line">QTreeView *tree = <span class="keyword">new</span> <span class="built_in">QTreeView</span>(spliter);</span><br><span class="line">tree-&gt;<span class="built_in">setModel</span>(model);</span><br><span class="line">tree-&gt;<span class="built_in">setRootIndex</span>(model-&gt;<span class="built_in">index</span>(<span class="string">&quot;d:\\&quot;</span>));</span><br><span class="line"><span class="comment">// Qt5中采用以下方式解决中文乱码</span></span><br><span class="line">QTextCodec *codec = QTextCodec::<span class="built_in">codecForName</span>(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">QString name = codec-&gt;<span class="built_in">toUnicode</span>(<span class="string">&quot;目录&quot;</span>);</span><br><span class="line">spliter-&gt;<span class="built_in">setWindowTitle</span>(name);</span><br><span class="line">spliter-&gt;<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404085153899.png" class="">

<h4 id="3-QTableView表格视图"><a href="#3-QTableView表格视图" class="headerlink" title="3.QTableView表格视图"></a>3.QTableView表格视图</h4><p>​    是一个模型&#x2F;视图结构的表视图实现：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">QStandardItemModel *model = <span class="keyword">new</span> QStandardItemModel;</span><br><span class="line">model-&gt;<span class="built_in">setColumnCount</span>(<span class="number">2</span>);</span><br><span class="line">model-&gt;<span class="built_in">setHeaderData</span>(<span class="number">0</span>, Qt::Horizontal, QTextCodec::<span class="built_in">codecForName</span>(<span class="string">&quot;utf-8&quot;</span>)-&gt;<span class="built_in">toUnicode</span>(<span class="string">&quot;卡号&quot;</span>));</span><br><span class="line">model-&gt;<span class="built_in">setHeaderData</span>(<span class="number">1</span>, Qt::Horizontal, QTextCodec::<span class="built_in">codecForName</span>(<span class="string">&quot;utf-8&quot;</span>)-&gt;<span class="built_in">toUnicode</span>(<span class="string">&quot;姓名&quot;</span>));</span><br><span class="line">QTableView *tableview = <span class="keyword">new</span> QTableView;</span><br><span class="line">tableview-&gt;<span class="built_in">setModel</span>(model);</span><br><span class="line">tableview-&gt;<span class="built_in">horizontalHeader</span>()-&gt;<span class="built_in">setDefaultAlignment</span>(Qt::AlignLeft);  <span class="comment">// 靠左</span></span><br><span class="line"><span class="comment">// QHeaderView::Fixed表示用户调节不了大小</span></span><br><span class="line">tableview-&gt;<span class="built_in">horizontalHeader</span>()-&gt;<span class="built_in">setSectionResizeMode</span>(<span class="number">0</span>,QHeaderView::Fixed);</span><br><span class="line">tableview-&gt;<span class="built_in">horizontalHeader</span>()-&gt;<span class="built_in">setSectionResizeMode</span>(<span class="number">1</span>, QHeaderView::Fixed);</span><br><span class="line">tableview-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">tableview-&gt;<span class="built_in">setColumnWidth</span>(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line"><span class="comment">// 循环插入数据</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">     model-&gt;<span class="built_in">setItem</span>(i,<span class="number">0</span>,<span class="keyword">new</span> <span class="built_in">QStandardItem</span>(<span class="string">&quot;20211105238&quot;</span>));</span><br><span class="line">     <span class="comment">//设置字符颜色</span></span><br><span class="line">     model-&gt;<span class="built_in">item</span>(i,<span class="number">0</span>)-&gt;<span class="built_in">setForeground</span>(<span class="built_in">QBrush</span>(<span class="built_in">QColor</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>)));</span><br><span class="line">     <span class="comment">//设置字符位置</span></span><br><span class="line">     model-&gt;<span class="built_in">item</span>(i,<span class="number">0</span>)-&gt;<span class="built_in">setTextAlignment</span>(Qt::AlignCenter);</span><br><span class="line">     model-&gt;<span class="built_in">setItem</span>(i,<span class="number">1</span>,<span class="keyword">new</span> <span class="built_in">QStandardItem</span>(QTextCodec::<span class="built_in">codecForName</span>(<span class="string">&quot;utf-8&quot;</span>)-&gt;<span class="built_in">toUnicode</span>(<span class="string">&quot;哈哈&quot;</span>)));</span><br><span class="line"> &#125;</span><br><span class="line">tableview-&gt;<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404091853455.png" class="">

<h4 id="4-QColumnView列视图"><a href="#4-QColumnView列视图" class="headerlink" title="4.QColumnView列视图"></a>4.QColumnView列视图</h4><p>​    提供了一个模型&#x2F;视图的列视图实现，提供了多级视图：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MainWindow w;</span><br><span class="line">QColumnView *cview = <span class="keyword">new</span> <span class="built_in">QColumnView</span>(&amp;w);</span><br><span class="line">w.<span class="built_in">setCentralWidget</span>(cview);</span><br><span class="line">QStandardItemModel model;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> groupnum = <span class="number">0</span>; groupnum &lt; <span class="number">3</span>; ++groupnum) &#123;</span><br><span class="line">    QStandardItem *group = <span class="keyword">new</span> <span class="built_in">QStandardItem</span>(<span class="built_in">QString</span>(<span class="string">&quot;Group %1&quot;</span>).<span class="built_in">arg</span>(groupnum));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> personnum = <span class="number">0</span>; personnum &lt; <span class="number">5</span>; ++personnum) &#123;</span><br><span class="line">        QStandardItem *person = <span class="keyword">new</span> <span class="built_in">QStandardItem</span>(<span class="built_in">QString</span>(<span class="string">&quot;Person %1 (group %2)&quot;</span>).<span class="built_in">arg</span>(personnum).<span class="built_in">arg</span>(groupnum));</span><br><span class="line">        group-&gt;<span class="built_in">appendRow</span>(person);</span><br><span class="line">    &#125;</span><br><span class="line">    model.<span class="built_in">appendRow</span>(group);</span><br><span class="line">&#125;</span><br><span class="line">cview-&gt;<span class="built_in">setModel</span>(&amp;model);</span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404093203445.png" class="">

<h4 id="5-QHeaderView表头视图"><a href="#5-QHeaderView表头视图" class="headerlink" title="5.QHeaderView表头视图"></a>5.QHeaderView表头视图</h4><p>​    提供行表头或列表头视图组件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造，orientation表示为行或列</span></span><br><span class="line">QHeaderView::<span class="built_in">QHeaderView</span>(Qt::Orientation orientation表示为行或列, QWidget *parent=<span class="literal">nullptr</span>);</span><br><span class="line"><span class="comment">// ResizeMode为调整大小模式</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">QHeaderView</span>::ResizeMode&#123;</span><br><span class="line">    QHeaderView::Interactive;       <span class="comment">// 用户可以调整大小，也可以使用resizeSection()调整</span></span><br><span class="line">    QHeaderView::Fixed;             <span class="comment">// 用户无法调整，只能以resizeSection()调整</span></span><br><span class="line">    QHeaderView::Stretch;           <span class="comment">// 自动调整大小以填充可用空间，用户无法调整</span></span><br><span class="line">    QHeaderView::ResizeToContents;  <span class="comment">// 自动调节，用户无法调整</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Qt单元组件（便利类）"><a href="#Qt单元组件（便利类）" class="headerlink" title="Qt单元组件（便利类）"></a>Qt单元组件（便利类）</h3><p>​    Qt有三种单元组件：</p>
<ul>
<li>列表单元组件QListWidget</li>
<li>树形单元组件QTreeWidget</li>
<li>表格单元组件QTableWidget</li>
</ul>
<h4 id="1-QListWidget列表单元组件"><a href="#1-QListWidget列表单元组件" class="headerlink" title="1.QListWidget列表单元组件"></a>1.QListWidget列表单元组件</h4><p>​    继承自QListView，是基于单元的列表组件，可以显示一个清单，清单中每个项目是QListWidgetItem的一个实例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Widget w;</span><br><span class="line">QListWidget *listWidget = <span class="keyword">new</span> <span class="built_in">QListWidget</span>(&amp;w);</span><br><span class="line">QVBoxLayout *layout = <span class="keyword">new</span> QVBoxLayout;</span><br><span class="line">QListWidgetItem* lst1 = <span class="keyword">new</span> <span class="built_in">QListWidgetItem</span>(<span class="string">&quot;data&quot;</span>, listWidget);</span><br><span class="line">QListWidgetItem* lst2 = <span class="keyword">new</span> <span class="built_in">QListWidgetItem</span>(<span class="string">&quot;decision&quot;</span>, listWidget);</span><br><span class="line">QListWidgetItem* lst3 = <span class="keyword">new</span> <span class="built_in">QListWidgetItem</span>(<span class="string">&quot;document&quot;</span>, listWidget);</span><br><span class="line">QListWidgetItem* lst4 = <span class="keyword">new</span> <span class="built_in">QListWidgetItem</span>(<span class="string">&quot;process&quot;</span>, listWidget);</span><br><span class="line">QListWidgetItem* lst5 = <span class="keyword">new</span> <span class="built_in">QListWidgetItem</span>(<span class="string">&quot;printer&quot;</span>, listWidget);</span><br><span class="line">listWidget-&gt;<span class="built_in">insertItem</span>(<span class="number">1</span>, lst1);  <span class="comment">// 在第1行插入项目item</span></span><br><span class="line">listWidget-&gt;<span class="built_in">insertItem</span>(<span class="number">2</span>, lst2);</span><br><span class="line">listWidget-&gt;<span class="built_in">insertItem</span>(<span class="number">3</span>, lst3);</span><br><span class="line">listWidget-&gt;<span class="built_in">insertItem</span>(<span class="number">4</span>, lst4);</span><br><span class="line">listWidget-&gt;<span class="built_in">insertItem</span>(<span class="number">5</span>, lst5);</span><br><span class="line">listWidget-&gt;<span class="built_in">show</span>();</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(listWidget);</span><br><span class="line">w.<span class="built_in">setLayout</span>(layout);</span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404094008174.png" class="">

<h4 id="2-QTreeWidget树形单元组件"><a href="#2-QTreeWidget树形单元组件" class="headerlink" title="2.QTreeWidget树形单元组件"></a>2.QTreeWidget树形单元组件</h4><p>​    继承自QTreeView，是树形视图的使用预定义模型，也是基于模型&#x2F;视图结构的组件，通过QTreeWidgetItem添加节点：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Widget w;</span><br><span class="line">QTreeWidget *treeWidget = <span class="keyword">new</span> <span class="built_in">QTreeWidget</span>(&amp;w);</span><br><span class="line">treeWidget-&gt;<span class="built_in">setColumnCount</span>(<span class="number">1</span>);  <span class="comment">// 设置列数</span></span><br><span class="line">treeWidget-&gt;<span class="built_in">setHeaderLabel</span>(<span class="string">&quot;图像选择&quot;</span>);  <span class="comment">// 设置头的标题</span></span><br><span class="line">QTreeWidgetItem *Item1 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(treeWidget, <span class="built_in">QStringList</span>(<span class="string">&quot;图像1&quot;</span>));</span><br><span class="line">QTreeWidgetItem *Item11 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(Item1, <span class="built_in">QStringList</span>(<span class="string">&quot;Band1&quot;</span>));  <span class="comment">// 子节点1</span></span><br><span class="line">Item1-&gt;<span class="built_in">addChild</span>(Item11);</span><br><span class="line">QTreeWidgetItem *Item2 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(treeWidget, <span class="built_in">QStringList</span>(<span class="string">&quot;图像2&quot;</span>));</span><br><span class="line">QTreeWidgetItem *Item21 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(Item2, <span class="built_in">QStringList</span>(<span class="string">&quot;Band1&quot;</span>));  <span class="comment">// 子节点1</span></span><br><span class="line">QTreeWidgetItem *Item22 = <span class="keyword">new</span> <span class="built_in">QTreeWidgetItem</span>(Item2, <span class="built_in">QStringList</span>(<span class="string">&quot;Band2&quot;</span>));  <span class="comment">// 子节点2 </span></span><br><span class="line">Item2-&gt;<span class="built_in">addChild</span>(Item21);  <span class="comment">// 添加子节点</span></span><br><span class="line">Item2-&gt;<span class="built_in">addChild</span>(Item22);</span><br><span class="line">treeWidget-&gt;<span class="built_in">expandAll</span>();  <span class="comment">// 节点全部展开</span></span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404095429564.png" class="">

<h4 id="3-QTableWidget表格单元组件"><a href="#3-QTableWidget表格单元组件" class="headerlink" title="3.QTableWidget表格单元组件"></a>3.QTableWidget表格单元组件</h4><p>​    继承自QTableView，QTbaleView可以使用自定义的数据来显示内容，而QTableWidget只能使用标准的数据模型，并且其单元数据是QTableWidgetItem对象来实现的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">QTableWidget *tablewidget = <span class="keyword">new</span> <span class="built_in">QTableWidget</span>(<span class="number">10</span>,<span class="number">5</span>);</span><br><span class="line">tablewidget-&gt;<span class="built_in">resize</span>(<span class="number">350</span>, <span class="number">200</span>);  <span class="comment">//设置表格</span></span><br><span class="line">QStringList header;</span><br><span class="line">header&lt;&lt;<span class="string">&quot;Month&quot;</span>&lt;&lt;<span class="string">&quot;Description&quot;</span>;</span><br><span class="line">tablewidget-&gt;<span class="built_in">setHorizontalHeaderLabels</span>(header);  <span class="comment">// 设置表头</span></span><br><span class="line">tablewidget-&gt;<span class="built_in">setItem</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;Jan&quot;</span>));  <span class="comment">// 插入数据</span></span><br><span class="line">tablewidget-&gt;<span class="built_in">setItem</span>(<span class="number">1</span>,<span class="number">0</span>,<span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;Feb&quot;</span>));</span><br><span class="line">tablewidget-&gt;<span class="built_in">setItem</span>(<span class="number">2</span>,<span class="number">0</span>,<span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;Mar&quot;</span>));</span><br><span class="line">tablewidget-&gt;<span class="built_in">setItem</span>(<span class="number">0</span>,<span class="number">1</span>,<span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;Jan&#x27;s month&quot;</span>));</span><br><span class="line">tablewidget-&gt;<span class="built_in">setItem</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;Feb&#x27;s month&quot;</span>));</span><br><span class="line">tablewidget-&gt;<span class="built_in">setItem</span>(<span class="number">2</span>,<span class="number">1</span>,<span class="keyword">new</span> <span class="built_in">QTableWidgetItem</span>(<span class="string">&quot;Mar&#x27;s month&quot;</span>));</span><br><span class="line">tablewidget-&gt;<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404100058691.png" class="">

<h3 id="Qt输入组件"><a href="#Qt输入组件" class="headerlink" title="Qt输入组件"></a>Qt输入组件</h3><p>​    Qt中一共有13种输入组件：</p>
<ul>
<li>下拉列表框QComboBox</li>
<li>字体组合框QFontComboBox</li>
<li>行编辑框QLineEdit</li>
<li>文版编辑框QTextEdit</li>
<li>无格式文本编辑框QPlainTextEdit</li>
<li>整数计数器QSpinBox</li>
<li>小数计数器QDoubleSpinBox</li>
<li>时间编辑框QTimeEdit</li>
<li>日期编辑框QDateEdit</li>
<li>日期时间编辑框QDateTimeEdit</li>
<li>表盘QDial</li>
<li>滚动条QScrollBar（水平+竖直）</li>
<li>滑动条QSlider（水平+竖直）</li>
</ul>
<h4 id="1-QComboBox下拉列表框"><a href="#1-QComboBox下拉列表框" class="headerlink" title="1.QComboBox下拉列表框"></a>1.QComboBox下拉列表框</h4><p>​    继承自QWidget，用于有多个选项的下拉框：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QComboBox *comboBox = new QComboBox(&amp;w);</span><br><span class="line">comboBox-&gt;addItem(&quot;1&quot;);  // 在下拉框最后添加一项</span><br><span class="line">comboBox-&gt;addItem(&quot;2&quot;);</span><br><span class="line">comboBox-&gt;insertItem(0, &quot;3&quot;);  // 给定索引插入一项，如果索引为0或-1，则在添加到现有项目的列表最前</span><br><span class="line">w.show();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404102831789.png" class="">

<h4 id="2-QFontComboBox字体组合框组件"><a href="#2-QFontComboBox字体组合框组件" class="headerlink" title="2.QFontComboBox字体组合框组件"></a>2.QFontComboBox字体组合框组件</h4><p>​    继承于QComboBox，QFontComboBox字体组合框分为两部分显示：顶部是一个允许输入文本的文本框，下面的列表框则显示字体列表项，但只能单选，专门用于选择字体：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QFontComboBox *fontcom = <span class="keyword">new</span> <span class="built_in">QFontComboBox</span>(&amp;w);</span><br><span class="line">QFont font = fontcom-&gt;<span class="built_in">currentFont</span>();  <span class="comment">// 返回当前选择字体</span></span><br><span class="line"><span class="built_in">qDebug</span>() &lt;&lt; font; <span class="comment">//QFont(SimSun,9,-1,5,50,0,0,0,0,0)</span></span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404103515990.png" class="">

<h4 id="3-QLineEdit行编辑组件"><a href="#3-QLineEdit行编辑组件" class="headerlink" title="3.QLineEdit行编辑组件"></a>3.QLineEdit行编辑组件</h4><p>​    主要用它来接受输入文字信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QLineEdit *lineEdit = <span class="keyword">new</span> <span class="built_in">QLineEdit</span>(&amp;w);</span><br><span class="line">lineEdit-&gt;<span class="built_in">setText</span>(<span class="string">&quot;zhuzhibo&quot;</span>);  <span class="comment">// 设置行编辑文本</span></span><br><span class="line"><span class="built_in">qDebug</span>() &lt;&lt; lineEdit-&gt;<span class="built_in">text</span>();  <span class="comment">// 返回行编辑文本&quot;zhuzhibo&quot;</span></span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404103947645.png" class="">

<h4 id="4-QTextEdit文本编辑组件"><a href="#4-QTextEdit文本编辑组件" class="headerlink" title="4.QTextEdit文本编辑组件"></a>4.QTextEdit文本编辑组件</h4><p>​    主要用于输入文本信息或显示文本信息，支持富文本</p>
<h4 id="5-QPlainTextEdit无格式文本编辑组件"><a href="#5-QPlainTextEdit无格式文本编辑组件" class="headerlink" title="5.QPlainTextEdit无格式文本编辑组件"></a>5.QPlainTextEdit无格式文本编辑组件</h4><p>​    和QTextEdit只是样式不同，可以通过设置属性改变样式。</p>
<h4 id="6-QSPinBox整数计数器组件"><a href="#6-QSPinBox整数计数器组件" class="headerlink" title="6.QSPinBox整数计数器组件"></a>6.QSPinBox整数计数器组件</h4><p>​    继承自QAbstractSpinBox，允许用户通过点击向上&#x2F;向下按钮来增加&#x2F;减少当前显示的值，也可以直接输入选择框的值，如果值是直接输入选择框，一般需要按Enter键确认新值：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QSpinBox *spinBox = <span class="keyword">new</span> <span class="built_in">QSpinBox</span>(&amp;w);</span><br><span class="line">spinBox-&gt;<span class="built_in">setSingleStep</span>(<span class="number">2</span>);</span><br><span class="line">spinBox-&gt;<span class="built_in">setRange</span>(<span class="number">0</span>,<span class="number">100</span>);  <span class="comment">// 设置变化范围</span></span><br><span class="line">spinBox-&gt;<span class="built_in">setSuffix</span>(<span class="string">&quot; km&quot;</span>);  <span class="comment">// 设置显示后缀</span></span><br><span class="line">spinBox-&gt;<span class="built_in">setPrefix</span>(<span class="string">&quot;distance &quot;</span>);  <span class="comment">// 设置显示前缀</span></span><br><span class="line">spinBox-&gt;<span class="built_in">resize</span>(<span class="number">200</span>, <span class="number">40</span>);  <span class="comment">// 设置大小</span></span><br><span class="line">spinBox-&gt;<span class="built_in">setValue</span>(<span class="number">50</span>);  <span class="comment">// 设置初始值</span></span><br><span class="line">spinBox-&gt;<span class="built_in">setSingleStep</span>(<span class="number">1</span>);  <span class="comment">// 设置计数器步长值</span></span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404105743783.png" class="">

<h4 id="7-QDoubleSpinBox"><a href="#7-QDoubleSpinBox" class="headerlink" title="7.QDoubleSpinBox"></a>7.QDoubleSpinBox</h4><p>​    小数计数器组件，继承自QSpinBox，可以表示小数，其他功能与QSpinBox相同</p>
<h4 id="8-QSlider滑动条组件"><a href="#8-QSlider滑动条组件" class="headerlink" title="8.QSlider滑动条组件"></a>8.QSlider滑动条组件</h4><p>​    继承自QAbstractSlider，有Horizontal&#x2F;Vertical Slider两种布局，两种布局样式之间可以相互转换，只需要改变orientation属性即可：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QHBoxLayout *layout = <span class="keyword">new</span> QHBoxLayout;</span><br><span class="line">QSlider *vslider = <span class="keyword">new</span> <span class="built_in">QSlider</span>(&amp;w);  <span class="comment">// 默认为竖直Vertical</span></span><br><span class="line">vslider-&gt;<span class="built_in">setMaximum</span>(<span class="number">100</span>);  <span class="comment">// 设置最大值</span></span><br><span class="line">vslider-&gt;<span class="built_in">setMinimum</span>(<span class="number">0</span>);  <span class="comment">// 设置最小值</span></span><br><span class="line">vslider-&gt;<span class="built_in">setValue</span>(<span class="number">50</span>);  <span class="comment">// 设置默认值</span></span><br><span class="line">QSlider *hslider = <span class="keyword">new</span> <span class="built_in">QSlider</span>(Qt::Horizontal, &amp;w);  <span class="comment">// 创建水平滑动条</span></span><br><span class="line">hslider-&gt;<span class="built_in">setMaximum</span>(<span class="number">100</span>);</span><br><span class="line">hslider-&gt;<span class="built_in">setMinimum</span>(<span class="number">0</span>);</span><br><span class="line">hslider-&gt;<span class="built_in">setValue</span>(<span class="number">50</span>);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(vslider);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(hslider);</span><br><span class="line">w.<span class="built_in">setLayout</span>(layout);</span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404111249348.png" class="">

<h4 id="9-QDial表盘组件"><a href="#9-QDial表盘组件" class="headerlink" title="9.QDial表盘组件"></a>9.QDial表盘组件</h4><p>​    继承自QAbstractSlider，可用来描述各式各样的仪表盘样式：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QDial *dial = <span class="keyword">new</span> <span class="built_in">QDial</span>(&amp;w);</span><br><span class="line">dial-&gt;<span class="built_in">setMinimum</span>(<span class="number">0</span>);  <span class="comment">// 设置最小值</span></span><br><span class="line">dial-&gt;<span class="built_in">setMaximum</span>(<span class="number">100</span>);  <span class="comment">// 设置最大值</span></span><br><span class="line">dial-&gt;<span class="built_in">setValue</span>(<span class="number">20</span>);  <span class="comment">// 设置表盘值</span></span><br><span class="line">dial-&gt;<span class="built_in">setNotchesVisible</span>(<span class="literal">true</span>);  <span class="comment">// 设置表盘是否可见</span></span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404111741191.png" class="">

<h4 id="10-QScrollBar滚动条组件"><a href="#10-QScrollBar滚动条组件" class="headerlink" title="10.QScrollBar滚动条组件"></a>10.QScrollBar滚动条组件</h4><p>​    继承自QAbstractSlider，提供垂直和水平布局样式，滚动条可以使用户能够查看比窗口组件显示较多的内容：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QHBoxLayout *layout = <span class="keyword">new</span> QHBoxLayout;</span><br><span class="line">QScrollBar *vscroll = <span class="keyword">new</span> <span class="built_in">QScrollBar</span>(&amp;w);</span><br><span class="line">vscroll-&gt;<span class="built_in">setMaximum</span>(<span class="number">100</span>);</span><br><span class="line">vscroll-&gt;<span class="built_in">setMinimum</span>(<span class="number">0</span>);</span><br><span class="line">vscroll-&gt;<span class="built_in">setValue</span>(<span class="number">20</span>);</span><br><span class="line">QScrollBar *hscroll = <span class="keyword">new</span> <span class="built_in">QScrollBar</span>(Qt::Horizontal, &amp;w);</span><br><span class="line">hscroll-&gt;<span class="built_in">setMaximum</span>(<span class="number">100</span>);</span><br><span class="line">hscroll-&gt;<span class="built_in">setMinimum</span>(<span class="number">0</span>);</span><br><span class="line">hscroll-&gt;<span class="built_in">setValue</span>(<span class="number">20</span>);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(vscroll);</span><br><span class="line">layout-&gt;<span class="built_in">addWidget</span>(hscroll);</span><br><span class="line">w.<span class="built_in">setLayout</span>(layout);</span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404112330194.png" class="">

<h4 id="11-QDateTimeEdit日期事件编辑框组件"><a href="#11-QDateTimeEdit日期事件编辑框组件" class="headerlink" title="11.QDateTimeEdit日期事件编辑框组件"></a>11.QDateTimeEdit日期事件编辑框组件</h4><p>​    用来编辑和显示时间与日期的组件，继承自QAbstractSpinBox：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QDateTimeEdit *datetime = <span class="keyword">new</span> <span class="built_in">QDateTimeEdit</span>(&amp;w);</span><br><span class="line">datetime-&gt;<span class="built_in">setTime</span>(QTime::<span class="built_in">currentTime</span>());  <span class="comment">// 设置时间</span></span><br><span class="line">datetime-&gt;<span class="built_in">setDate</span>(QDate::<span class="built_in">currentDate</span>());  <span class="comment">// 设置日期</span></span><br><span class="line">datetime-&gt;<span class="built_in">setDisplayFormat</span>(<span class="built_in">QString</span>(<span class="string">&quot;yyyy/MM/dd hh:mm&quot;</span>));  <span class="comment">// 设置时间格式</span></span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404113242197.png" class="">

<h4 id="12-QDateEdit日期编辑框组件"><a href="#12-QDateEdit日期编辑框组件" class="headerlink" title="12.QDateEdit日期编辑框组件"></a>12.QDateEdit日期编辑框组件</h4><p>​    继承自QDateTimeEdit，用于编辑和显示日期</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">QDateEdit::setDay</span><span class="params">(<span class="type">int</span> day)</span>[<span class="keyword">virtual</span> <span class="keyword">protected</span>]</span>;  <span class="comment">// 设置Day，确保day为有效值</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QDateEdit::setDMonth</span><span class="params">(<span class="type">int</span> month)</span>[<span class="keyword">virtual</span> <span class="keyword">protected</span>]</span>;  <span class="comment">// 设置Mouth，同上</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QDateEdit::setYear</span><span class="params">(<span class="type">int</span> year)</span>[<span class="keyword">virtual</span> <span class="keyword">protected</span>]</span>;  <span class="comment">// 设置Year，同上</span></span><br></pre></td></tr></table></figure>

<h4 id="13-QTimeEdit时间编辑框组件"><a href="#13-QTimeEdit时间编辑框组件" class="headerlink" title="13.QTimeEdit时间编辑框组件"></a>13.QTimeEdit时间编辑框组件</h4><p>​    继承自QTimeEdit，用于编辑和显示时间</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTimeEdit::setHour</span><span class="params">(<span class="type">int</span> h)</span>[<span class="keyword">virtual</span> <span class="keyword">protected</span>]</span>;  <span class="comment">// 设置Hour，确保h为有效值</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTimeEdit::setMinute</span><span class="params">(<span class="type">int</span> m)</span>[<span class="keyword">virtual</span> <span class="keyword">protected</span>]</span>;  <span class="comment">// 设置Minute，同上</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTimeEdit::setSecond</span><span class="params">(<span class="type">int</span> s)</span>[<span class="keyword">virtual</span> <span class="keyword">protected</span>]</span>;  <span class="comment">// 设置Second，同上</span></span><br></pre></td></tr></table></figure>

<h3 id="Qt显示组件"><a href="#Qt显示组件" class="headerlink" title="Qt显示组件"></a>Qt显示组件</h3><p>​    Qt一共有七种显示组件：</p>
<ul>
<li>标签QLabel</li>
<li>文本浏览器QTextBrowser</li>
<li>绘图视图QGraphicsView</li>
<li>日历组件QCalendarWidget</li>
<li>LCD数字显示框QLCDNumber</li>
<li>进度条QProgressBar</li>
<li>线条QLine</li>
</ul>
<h4 id="1-QLabel标签组件"><a href="#1-QLabel标签组件" class="headerlink" title="1.QLabel标签组件"></a>1.QLabel标签组件</h4><p>​    继承自QFrame，用于显示文本或图像，具体见<a href="###常用控件QLabel">这里</a></p>
<h4 id="2-QTextBrowser文本浏览器组件"><a href="#2-QTextBrowser文本浏览器组件" class="headerlink" title="2.QTextBrowser文本浏览器组件"></a>2.QTextBrowser文本浏览器组件</h4><p>​    继承自QTextEdit，是只读的，不允许对内容进行更改，但还具有链接文本的作用：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">QTextBrowser::<span class="built_in">QTextBrowser</span>(QWidget *parent=<span class="number">0</span>, <span class="type">const</span> <span class="type">char</span> *name=<span class="number">0</span>);  <span class="comment">// 构造</span></span><br><span class="line"><span class="comment">// 更改内置导航链接的文件清单为显示当前一个文档，如果没有以前的文档，就什么都不做，可以实现向前翻页的功能</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTextBrowser::backward</span><span class="params">()</span>[<span class="keyword">virtual</span> slot]</span>;</span><br><span class="line"><span class="comment">// 更改内置导航链接的文件清单为显示下一个文档，如果没有以前的文档，就什么都不做，可以实现向后翻页的功能</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTextBrowser::forward</span><span class="params">()</span>[<span class="keyword">virtual</span> slot]</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTextBrowser::home</span><span class="params">()</span>[<span class="keyword">virtual</span> slot]</span>;  <span class="comment">//更改显示的文件浏览器中的链接，显示第一个文件</span></span><br><span class="line"><span class="comment">// 点击链接时发送该信号</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTextBrowser::linkClicked</span><span class="params">(<span class="type">const</span> QString &amp;name)</span>[<span class="keyword">virtual</span> slot]</span>;</span><br><span class="line"><span class="comment">// 重新载入当前的设置源</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QTextBrowser::reload</span><span class="params">()</span>[<span class="keyword">virtual</span> slot]</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-QGraphicsView绘图视图组件"><a href="#3-QGraphicsView绘图视图组件" class="headerlink" title="3.QGraphicsView绘图视图组件"></a>3.QGraphicsView绘图视图组件</h4><p>​    用于显示QGraphicsScene内容的控件，为2D绘图提供一个解决方案，主要由三部分组成：QGraphicsItem用来定义图元、QGraphicsScene定义场景并包含所有需要绘制的图元和QGraphicsView定义观察场景的视窗（视图）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">QGraphicsScene scene;  <span class="comment">// 创建场景</span></span><br><span class="line">scene.<span class="built_in">setBackgroundBrush</span>(Qt::red);  <span class="comment">// 设定场景背景</span></span><br><span class="line">QPen pen;  <span class="comment">// 创建画笔</span></span><br><span class="line">pen.<span class="built_in">setColor</span>(<span class="built_in">QColor</span>(<span class="number">0</span>, <span class="number">160</span>, <span class="number">230</span>));  <span class="comment">// 画笔颜色</span></span><br><span class="line">pen.<span class="built_in">setWidth</span>(<span class="number">10</span>);  <span class="comment">// 画笔宽度</span></span><br><span class="line">QGraphicsRectItem *item = <span class="keyword">new</span> <span class="built_in">QGraphicsRectItem</span>();  <span class="comment">// 创建矩形图元对象</span></span><br><span class="line">item-&gt;<span class="built_in">setRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">50</span>);  <span class="comment">// 设置矩形坐标</span></span><br><span class="line">item-&gt;<span class="built_in">setPen</span>(pen);</span><br><span class="line">item-&gt;<span class="built_in">setBrush</span>(<span class="built_in">QBrush</span>(<span class="built_in">QColor</span>(<span class="number">255</span>,<span class="number">0</span>,<span class="number">255</span>)));  <span class="comment">// QBrush用颜色填充区域</span></span><br><span class="line">item-&gt;<span class="built_in">setFlag</span>(QGraphicsItem::ItemIsMovable);  <span class="comment">// 设置可拖动</span></span><br><span class="line">scene.<span class="built_in">addItem</span>(item);  <span class="comment">// 添加到场景中</span></span><br><span class="line">QGraphicsView *view = <span class="keyword">new</span> <span class="built_in">QGraphicsView</span>(&amp;scene);  <span class="comment">// 绑定视图</span></span><br><span class="line">view-&gt;<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404162444280.png" class="">

<h4 id="4-QCalendarWidget日历组件"><a href="#4-QCalendarWidget日历组件" class="headerlink" title="4.QCalendarWidget日历组件"></a>4.QCalendarWidget日历组件</h4><p>​    继承自QWidget，用于提供简易的日历界面，用于选择日期。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QCalendarWidget *calendar = <span class="keyword">new</span> <span class="built_in">QCalendarWidget</span>(&amp;w);</span><br><span class="line">calendar-&gt;<span class="built_in">setSelectedDate</span>(<span class="built_in">QDate</span>(<span class="number">2023</span>, <span class="number">4</span>, <span class="number">4</span>));  <span class="comment">// 设置显示日期</span></span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404163727442.png" class="">

<h4 id="5-QLCDNumber-LAD数字显示框组件"><a href="#5-QLCDNumber-LAD数字显示框组件" class="headerlink" title="5.QLCDNumber LAD数字显示框组件"></a>5.QLCDNumber LAD数字显示框组件</h4><p>​    继承自QFrame，LCD数字显示框可以显示16进制、十进制、八进制或二进制：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QWidget w;</span><br><span class="line">QLCDNumber *number = <span class="keyword">new</span> <span class="built_in">QLCDNumber</span>(&amp;w);  <span class="comment">// 创建QLCDNumber对象</span></span><br><span class="line">number-&gt;<span class="built_in">setDigitCount</span>(<span class="number">20</span>);  <span class="comment">// 设置一共可以显示多少位数字</span></span><br><span class="line">number-&gt;<span class="built_in">setSegmentStyle</span>(QLCDNumber::Flat);  <span class="comment">// 设置内容扁平化显示，颜色与窗口颜色相同</span></span><br><span class="line">number-&gt;<span class="built_in">display</span>(QDateTime::<span class="built_in">currentDateTime</span>().<span class="built_in">toString</span>(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404164621851.png" class="">

<h4 id="6-QProgressBar进度条组件"><a href="#6-QProgressBar进度条组件" class="headerlink" title="6.QProgressBar进度条组件"></a>6.QProgressBar进度条组件</h4><p>​    显示一个水平进度条组件，进度条是用来给用于显示操作进度的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Widget w;</span><br><span class="line">QProgressBar *pbar = <span class="keyword">new</span> <span class="built_in">QProgressBar</span>(&amp;w);</span><br><span class="line">pbar-&gt;<span class="built_in">setRange</span>(<span class="number">0</span>, <span class="number">1000</span>);  <span class="comment">// 设置范围值</span></span><br><span class="line">pbar-&gt;<span class="built_in">setValue</span>(<span class="number">100</span>);  <span class="comment">// 设置当前值</span></span><br><span class="line">pbar-&gt;<span class="built_in">setFormat</span>(<span class="string">&quot;%p%&quot;</span>);  <span class="comment">// 设置显示内容%p%为显示百分比，为默认方式</span></span><br><span class="line">w.<span class="built_in">show</span>();</span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230404165341816.png" class="">

<h4 id="7-QLine线条组件"><a href="#7-QLine线条组件" class="headerlink" title="7.QLine线条组件"></a>7.QLine线条组件</h4><p>​    表示平面上整数精度得二维向量，用于描述有限长度得直线也就是线段，起点和重点只具有整数精度。有一个特殊类QLineF继承自QLine，可以使用浮点精度。</p>
<h3 id="UI界面"><a href="#UI界面" class="headerlink" title="UI界面"></a>UI界面</h3><img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230329092940730.png" class="">

<h3 id="QDialog对话框"><a href="#QDialog对话框" class="headerlink" title="QDialog对话框"></a>QDialog对话框</h3><p>​    对话框通常会是一个顶层窗口，出现在程序最上层，用于实现短期任务或者简洁的用户交互。分为模态对话框和非模态对话框：</p>
<ul>
<li>模态对话框，当对话框打开时，不能操作同一个应用程序的其他窗口，只有当对话框关闭的时候才可以操作</li>
<li>非模态对话框，即可以操作其他窗口。使用 <code>QDialog::show()</code> 实现非模态对话框</li>
</ul>
<p>​    模态对话框又分为两种级别：</p>
<ul>
<li><p>应用程序级别的模态：</p>
<p>  当这种模态的对话框出现时，用户必须先对对话框进行交互，直到关闭对话框，然后才能访问程序中的其他窗口。使用 <code>QDialog::exec()</code> 实现应用程序级别的模态对话框</p>
</li>
<li><p>窗口级别的模态</p>
<p>  该模态仅仅阻塞了与对话框关联的窗口，但是依然允许用户与程序中其他串口的交互，适用于多窗口模式。使用 <code>QDialog::open()</code> 实现窗口级别的模态对话框</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">	...</span><br><span class="line">    <span class="comment">// MainWindow声明了dialog成员变量</span></span><br><span class="line">	dialog = <span class="keyword">new</span> <span class="built_in">QDialog</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>-&gt;dialog-&gt;<span class="built_in">setWindowTitle</span>(<span class="built_in">tr</span>(<span class="string">&quot;hello world&quot;</span>));     <span class="comment">// 设置标题</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;dialog-&gt;<span class="built_in">setAttribute</span>(Qt::WA_DeleteOnClose);    <span class="comment">// 设置关闭窗口自动析构</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;dialog-&gt;<span class="built_in">setMinimumSize</span>(<span class="built_in">QSize</span>(<span class="number">400</span>,<span class="number">400</span>));        <span class="comment">// 设置最小尺寸</span></span><br><span class="line">    QPushButton *btn = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;hello world&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">connect</span>(btn,&amp;QPushButton::clicked, <span class="keyword">this</span>, &amp;MainWindow::showDialog);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::showDialog</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//this-&gt;dialog-&gt;show();</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;dialog-&gt;<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Qt标准对话框"><a href="#Qt标准对话框" class="headerlink" title="Qt标准对话框"></a>Qt标准对话框</h3><p>​    Qt内置了一系列对话框，用于简化开发：</p>
<ul>
<li><p>QMessageBox：模态对话框</p>
</li>
<li><p>QColorDialog：选择颜色</p>
</li>
<li><p>QFontDialog：选择字体</p>
</li>
<li><p>QFileDialog：选择文件或目录</p>
</li>
<li><p>QInputDialog：允许用户输入一个值并将其返回</p>
<p>  …</p>
</li>
</ul>
<h3 id="消息对话框QMessageBox："><a href="#消息对话框QMessageBox：" class="headerlink" title="消息对话框QMessageBox："></a>消息对话框QMessageBox：</h3><p>​    下面是几个static函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关于对话框</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">about</span><span class="params">(QWidget* parent, <span class="type">const</span> QString&amp; title, <span class="type">const</span> QString&amp; text)</span></span>;</span><br><span class="line"><span class="comment">// 关于Qt对话框，显示Qt有关的信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">aboutQt</span><span class="params">((QWidget* parent, <span class="type">const</span> QString&amp; title = QString());</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">// 显示严重错误的对话框，显示一个红色错误符号</span></span></span></span><br><span class="line"><span class="params"><span class="function">StandardButton cirtical(QWidget *parent,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> QString &amp;title,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> QString &amp;text,</span></span></span><br><span class="line"><span class="params"><span class="function">                       	StandardButtons buttons = OK,</span></span></span><br><span class="line"><span class="params"><span class="function">                        StandardButton defaultButton = NoButton);</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">// 显示一个黄色感叹号信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">StandardButton warning(同上);             </span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">// 显示一个普通信息图标</span></span></span></span><br><span class="line"><span class="params"><span class="function">StandardButton information(同上);</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">// Question，提供一个问号图标并且显示按钮“是”和“否”</span></span></span></span><br><span class="line"><span class="params"><span class="function">StandardButton question(QWidget *parent,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> QString &amp;title,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> QString &amp;text,</span></span></span><br><span class="line"><span class="params"><span class="function">                       	StandardButtons buttons = StandardButtons(YES|NO),</span></span></span><br><span class="line"><span class="params"><span class="function">                        StandardButton defaultButton = NoButton);</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">// 比如如下使用：</span></span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">if</span> (QMessageBox::Yes == QMessageBox::question(</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">this</span>, tr(<span class="string">&quot;QUESTION&quot;</span>), tr(<span class="string">&quot;Yes or NO&quot;</span>), QMessageBox::Yes | QMessageBox::No, QMessageBox::Yes)) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        QMessageBox::information(<span class="keyword">this</span>, tr(<span class="string">&quot;Hmmm&quot;</span>), tr(<span class="string">&quot;I am glad to here thar&quot;</span>));</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;<span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        QMessageBox::information(<span class="keyword">this</span>, tr(<span class="string">&quot;Hmmm&quot;</span>), tr(<span class="string">&quot;I am sorry&quot;</span>));</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;          </span></span></span><br></pre></td></tr></table></figure>

<img src="/2023/05/06/Qt%E7%9F%A5%E8%AF%86%E7%82%B9/image-20230331103410533.png" class="">



<h3 id="标准对话框QFileDialog"><a href="#标准对话框QFileDialog" class="headerlink" title="标准对话框QFileDialog"></a>标准对话框QFileDialog</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">    ...</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setWindowTitle</span>(<span class="string">&quot;记事本&quot;</span>);</span><br><span class="line">    textEdit = <span class="keyword">new</span> <span class="built_in">QTextEdit</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">setCentralWidget</span>(textEdit);</span><br><span class="line"></span><br><span class="line">    QMenuBar *menuBar = <span class="keyword">this</span>-&gt;<span class="built_in">menuBar</span>();</span><br><span class="line">    QMenu *menu = menuBar-&gt;<span class="built_in">addMenu</span>(<span class="string">&quot;文件&quot;</span>);</span><br><span class="line">    QAction *actionOpen = menu-&gt;<span class="built_in">addAction</span>(<span class="string">&quot;打开&quot;</span>);</span><br><span class="line">    QAction *actionSave = menu-&gt;<span class="built_in">addAction</span>(<span class="string">&quot;保存&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(actionOpen, &amp;QAction::triggered, <span class="keyword">this</span>, &amp;MainWindow::openFile);</span><br><span class="line">    <span class="built_in">connect</span>(actionSave, &amp;QAction::triggered, <span class="keyword">this</span>, &amp;MainWindow::saveFile);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// openFile槽函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::openFile</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    QString getOpenFileName(QWidget *parent = 0,                // 父窗口</span></span><br><span class="line"><span class="comment">                            const QString &amp;caption=QString(),   // 对话框标题</span></span><br><span class="line"><span class="comment">                            const QString &amp;dir = QString(),     // 对话框打开的默认目录 &quot;.&quot;表示程序运行目录 &quot;/&quot;代表当前盘的根目录</span></span><br><span class="line"><span class="comment">                            const QString &amp;filter = QString(),  // 过滤器，用于过率特定的后缀名，多个用;隔开：&quot;Text File(*.txt);JPEG File(*.jpg)&quot;</span></span><br><span class="line"><span class="comment">                            Options options = 0);               // 对话框的一些参数设定</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    QString path = QFileDialog::<span class="built_in">getOpenFileName</span>(<span class="keyword">this</span>, <span class="string">&quot;Open File&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;Text File(*.txt)&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!path.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">        <span class="function">QFile <span class="title">file</span><span class="params">(path)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (!file.<span class="built_in">open</span>(QIODevice::ReadOnly|QIODevice::Text)) &#123;</span><br><span class="line">            QMessageBox::<span class="built_in">warning</span>(<span class="keyword">this</span>, <span class="string">&quot;Read File&quot;</span>, <span class="built_in">tr</span>(<span class="string">&quot;Cannot open file:\n%1&quot;</span>).<span class="built_in">arg</span>(path));</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">QTextStream <span class="title">in</span><span class="params">(&amp;file)</span></span>;</span><br><span class="line">        textEdit-&gt;<span class="built_in">setText</span>(in.<span class="built_in">readAll</span>());</span><br><span class="line">        file.<span class="built_in">close</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        QMessageBox::<span class="built_in">warning</span>(<span class="keyword">this</span>, <span class="string">&quot;Path&quot;</span>, <span class="built_in">tr</span>(<span class="string">&quot;You did not select any file&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// saveFile槽函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::saveFile</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QString path = QFileDialog::<span class="built_in">getSaveFileName</span>(<span class="keyword">this</span>, <span class="string">&quot;Save File&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;Text File(*.txt)&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!path.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">        <span class="function">QFile <span class="title">file</span><span class="params">(path)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (!file.<span class="built_in">open</span>(QIODevice::WriteOnly|QIODevice::Text)) &#123;</span><br><span class="line">            QMessageBox::<span class="built_in">warning</span>(<span class="keyword">this</span>, <span class="string">&quot;Write File&quot;</span>, <span class="built_in">tr</span>(<span class="string">&quot;Cannot open file:\n%1&quot;</span>).<span class="built_in">arg</span>(path));</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">QTextStream <span class="title">out</span><span class="params">(&amp;file)</span></span>;</span><br><span class="line">        out &lt;&lt; textEdit-&gt;<span class="built_in">toPlainText</span>();</span><br><span class="line">        file.<span class="built_in">close</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        QMessageBox::<span class="built_in">warning</span>(<span class="keyword">this</span>, <span class="string">&quot;Path&quot;</span>, <span class="built_in">tr</span>(<span class="string">&quot;You did not select any file&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h3><p>​    Qt提供两种布局定位机制：静态布局与动态布局</p>
<ul>
<li><p>静态布局：给出这个组件的坐标和长宽值</p>
</li>
<li><p>动态布局：只要把组件放入某一种布局中，布局由专门的布局管理器进行管理</p>
<ul>
<li><p>QHBoxLayout：按照水平方向从左到右布局</p>
</li>
<li><p>QVBoxLayout：按照竖直方向从上到下布局</p>
</li>
<li><p>QGridLayout：在一个网格中进行布局</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">QGridLayout *gLayout = <span class="keyword">new</span> QGridLayout;</span><br><span class="line">QPushButton *button1 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;button1&quot;</span>,<span class="keyword">this</span>);</span><br><span class="line">QPushButton *button2 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;button2&quot;</span>,<span class="keyword">this</span>);</span><br><span class="line">QPushButton *button3 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;button3&quot;</span>,<span class="keyword">this</span>);</span><br><span class="line">QPushButton *button4 = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;button4&quot;</span>,<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 设置每个组件的尺寸策略</span></span><br><span class="line">button1-&gt;<span class="built_in">setSizePolicy</span>(QSizePolicy::Expanding, QSizePolicy::Expanding);</span><br><span class="line">button2-&gt;<span class="built_in">setSizePolicy</span>(QSizePolicy::Expanding, QSizePolicy::Expanding);</span><br><span class="line">button3-&gt;<span class="built_in">setSizePolicy</span>(QSizePolicy::Expanding, QSizePolicy::Expanding);</span><br><span class="line">button4-&gt;<span class="built_in">setSizePolicy</span>(QSizePolicy::Expanding, QSizePolicy::Expanding);</span><br><span class="line"><span class="comment">// 设置组件的最小尺寸</span></span><br><span class="line">button1-&gt;<span class="built_in">setMinimumSize</span>(<span class="number">60</span>,<span class="number">60</span>);</span><br><span class="line">button2-&gt;<span class="built_in">setMinimumSize</span>(<span class="number">60</span>,<span class="number">60</span>);</span><br><span class="line">button3-&gt;<span class="built_in">setMinimumSize</span>(<span class="number">60</span>,<span class="number">60</span>);</span><br><span class="line">button4-&gt;<span class="built_in">setMinimumSize</span>(<span class="number">60</span>,<span class="number">60</span>);</span><br><span class="line"><span class="comment">// 添加组件到网格布局管理器</span></span><br><span class="line">gLayout-&gt;<span class="built_in">addWidget</span>(button1, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">gLayout-&gt;<span class="built_in">addWidget</span>(button2, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">gLayout-&gt;<span class="built_in">addWidget</span>(button3, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">gLayout-&gt;<span class="built_in">addWidget</span>(button4, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 设置行和列的比例系数</span></span><br><span class="line">gLayout-&gt;<span class="built_in">setColumnStretch</span>(<span class="number">0</span>, <span class="number">1</span>);  <span class="comment">// 第0列占有空间比例1倍</span></span><br><span class="line">gLayout-&gt;<span class="built_in">setColumnStretch</span>(<span class="number">1</span>, <span class="number">2</span>);  <span class="comment">// 第1列占有控件比例2倍，所有0，1列的比例为1：2</span></span><br><span class="line">gLayout-&gt;<span class="built_in">setRowStretch</span>(<span class="number">0</span>, <span class="number">1</span>);  <span class="comment">// 第0行占有空间比例1倍</span></span><br><span class="line">gLayout-&gt;<span class="built_in">setRowStretch</span>(<span class="number">1</span>, <span class="number">3</span>);  <span class="comment">// 第1行占有空间比例3倍，所以0，1行的比例为1：3</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="常用控件QLabel"><a href="#常用控件QLabel" class="headerlink" title="常用控件QLabel"></a>常用控件QLabel</h3><h4 id="显示文字"><a href="#显示文字" class="headerlink" title="显示文字"></a>显示文字</h4><ul>
<li><p>显示普通文本字符串</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QLabel *label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="keyword">this</span>);</span><br><span class="line">label-&gt;<span class="built_in">setText</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示HTML格式字符串</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">QLabel *label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="keyword">this</span>);</span><br><span class="line">label-&gt;<span class="built_in">setText</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">label-&gt;<span class="built_in">setText</span>(<span class="string">&quot;&lt;h1&gt;&lt;a href=\&quot;https://www.baidu.com\&quot;&gt;百度一下&lt;/a&gt;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">label-&gt;<span class="built_in">setOpenExternalLinks</span>(<span class="literal">true</span>);  <span class="comment">// 设置点击链接后是否自动打开</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="显示图片"><a href="#显示图片" class="headerlink" title="显示图片"></a>显示图片</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//void setPixmap(const QPixmap&amp;);</span></span><br><span class="line">QPixmap pixmap;                   <span class="comment">// 声明对象</span></span><br><span class="line">pixmap.<span class="built_in">load</span>(<span class="string">&quot;:/image/boat.jpg&quot;</span>);  <span class="comment">// 加载图片</span></span><br><span class="line">QLabel *label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="keyword">this</span>);</span><br><span class="line">label-&gt;<span class="built_in">setPixmap</span>(pismap);         <span class="comment">// 设置到label中</span></span><br></pre></td></tr></table></figure>

<h4 id="显示动画"><a href="#显示动画" class="headerlink" title="显示动画"></a>显示动画</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//void setMovie(QMovie *movie);</span></span><br><span class="line">QMovie *movie = <span class="keyword">new</span> <span class="built_in">QMovie</span>(<span class="string">&quot;:/Mario.gif&quot;</span>);</span><br><span class="line">movie-&gt;<span class="built_in">start</span>();</span><br><span class="line">QLabel *label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="keyword">this</span>);</span><br><span class="line">label-&gt;<span class="built_in">setMovie</span>(movie);</span><br></pre></td></tr></table></figure>

<h3 id="单行文本编辑框QLineEdit"><a href="#单行文本编辑框QLineEdit" class="headerlink" title="单行文本编辑框QLineEdit"></a>单行文本编辑框QLineEdit</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QString <span class="title">text</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">// 获取编辑框内容</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setText</span><span class="params">(<span class="type">const</span> Qstring&amp;)</span></span>;  <span class="comment">// 设置编辑框内容</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setEchoMode</span><span class="params">(EchoMode mode)</span></span>;  <span class="comment">// 设置文本的显示模式</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">EchoMode是一个枚举类型，定义了四种显示模式</span></span><br><span class="line"><span class="comment">    QLineEdit::Normal 模式显示方式</span></span><br><span class="line"><span class="comment">    QLineEdit::NoEcho 不显示任何内容，此模式下无法看到用户的输入</span></span><br><span class="line"><span class="comment">    QLineEdit::Password 密码模式，输入的字符会根据平台转换为特殊字符</span></span><br><span class="line"><span class="comment">    QLineEdit::PasswordEchoOnEdit 编辑时显示字符否则显示字符作为密码</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 指定显示文本与输入框上下左右边界间隔的像素数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setTextMargins</span><span class="params">(<span class="type">int</span> left, <span class="type">int</span> top, <span class="type">int</span> right, <span class="type">int</span> bottom)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="Qt消息事件机制"><a href="#Qt消息事件机制" class="headerlink" title="Qt消息事件机制"></a>Qt消息事件机制</h3><p>​    事件是由系统或者Qt程序本身在不同时刻发出的，比如按下鼠标，敲下键盘或者窗口需要重新绘制的时候，都会发出一个相应的事件。</p>
<h4 id="事件处理函数"><a href="#事件处理函数" class="headerlink" title="事件处理函数"></a>事件处理函数</h4><p>​    在所有组件的父类QWidget中，有很多事件处理函数：</p>
<ul>
<li>keyPressEvent()：键盘按下事件</li>
<li>keyReleaseEvent()：键盘松开事件</li>
<li>mouseDoubleClickEvent()：鼠标双击事件</li>
<li>mouseMoveEvent()：鼠标移动事件</li>
<li>mousePressEvent()：鼠标按键按下事件</li>
<li>mouseReleaseEvent()：鼠标按键松开事件</li>
<li>…</li>
</ul>
<p>​    这些函数都是protected virtual的，也就是我们可以在子类中重新实现这些函数:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventLabel</span> : <span class="keyword">public</span> QLabel</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mouseMoveEvent</span><span class="params">(QMouseEvent *ev)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mousePressEvent</span><span class="params">(QMouseEvent *ev)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">mouseReleaseEvent</span><span class="params">(QMouseEvent *ev)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 鼠标移动事件</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLabel::mouseMoveEvent</span><span class="params">(QMouseEvent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setText</span>(<span class="built_in">QString</span>(<span class="string">&quot;&lt;center&gt;&lt;h1&gt;Move:(%1, %2)&lt;/h1&gt;&lt;/center&gt;&quot;</span>).<span class="built_in">arg</span>(</span><br><span class="line">                      QString::<span class="built_in">number</span>(ev-&gt;<span class="built_in">x</span>()), QString::<span class="built_in">number</span>(ev-&gt;<span class="built_in">y</span>())));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 鼠标点击事件</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLabel::mousePressEvent</span><span class="params">(QMouseEvent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setText</span>(<span class="built_in">QString</span>(<span class="string">&quot;&lt;center&gt;&lt;h1&gt;Press:(%1, %2)&lt;/h1&gt;&lt;/center&gt;&quot;</span>).<span class="built_in">arg</span>(</span><br><span class="line">                      QString::<span class="built_in">number</span>(ev-&gt;<span class="built_in">x</span>()), QString::<span class="built_in">number</span>(ev-&gt;<span class="built_in">y</span>())));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 鼠标释放事件</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLabel::mouseReleaseEvent</span><span class="params">(QMouseEvent *ev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QString msg;</span><br><span class="line">    msg.<span class="built_in">asprintf</span>(<span class="string">&quot;&lt;center&gt;&lt;h1&gt;Release:(%d, %d)&lt;/h1&gt;&lt;/center&gt;&quot;</span>, ev-&gt;<span class="built_in">x</span>(), ev-&gt;<span class="built_in">y</span>());</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setText</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用如下</span></span><br><span class="line">...</span><br><span class="line">    EventLabel *evlabel = <span class="keyword">new</span> EventLabel;</span><br><span class="line">    evlabel-&gt;<span class="built_in">setMouseTracking</span>(<span class="literal">true</span>);  <span class="comment">// 是否直接追踪鼠标，默认为false，表示需要至少点击一次后才会被追踪</span></span><br><span class="line">    evlabel-&gt;<span class="built_in">setWindowTitle</span>(<span class="string">&quot;MouseEvent Demo&quot;</span>);</span><br><span class="line">    evlabel-&gt;<span class="built_in">resize</span>(<span class="number">300</span>,<span class="number">200</span>);</span><br><span class="line">    evlabel-&gt;<span class="built_in">show</span>();</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="事件分发函数event"><a href="#事件分发函数event" class="headerlink" title="事件分发函数event()"></a>事件分发函数event()</h4><p>​    事件对象创建完毕后，Qt将这个事件对象传递给QObject的event()函数，event()函数并不直接处理事件，而是将这些事件对象按照他们不同的类型，分发给不同得事件处理器(event handler)。</p>
<p>​    如果希望在事件分发之前做一些操作，那么就需要重写这个event函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CustomWidget::event</span><span class="params">(QEvent *e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e-&gt;<span class="built_in">type</span>() == QEvent::KeyPress) &#123;</span><br><span class="line">        QKeyEvent *keyEvent = <span class="built_in">static_cast</span>&lt;QKeyEvent *&gt;(e);</span><br><span class="line">        <span class="keyword">if</span> (keyEvent-&gt;<span class="built_in">key</span>() == Qt::Key_Tab) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;You press tab.&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 需要调用父类的event()继续转发，否则这个组件只能处理我们定义的事件了</span></span><br><span class="line">    <span class="keyword">return</span> QWidget::<span class="built_in">event</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果传入的事件已被识别并处理，则返回true，否则返回false；如果返回true，那么Qt会认为这个事件已经被处理完毕，不会将这个对象发送给其他对象，而是会继续处理事件队列中的下一个事件</li>
<li>在event()函数中，调用事件对象的accept()和ignore()是没有作用的，不会影响到事件的传播</li>
</ul>
<p>​    QObject::event()本质就是调用switch-case来进行判断和事件处理（调用相应的事件处理器）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//!!! Qt5</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QObject::event</span><span class="params">(QEvent *e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (e-&gt;<span class="built_in">type</span>()) &#123;</span><br><span class="line">    <span class="keyword">case</span> QEvent::Timer:</span><br><span class="line">        <span class="built_in">timerEvent</span>((QTimerEvent*)e);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> QEvent::ChildAdded:</span><br><span class="line">    <span class="keyword">case</span> QEvent::ChildPolished:</span><br><span class="line">    <span class="keyword">case</span> QEvent::ChildRemoved:</span><br><span class="line">        <span class="built_in">childEvent</span>((QChildEvent*)e);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> (e-&gt;<span class="built_in">type</span>() &gt;= QEvent::User) &#123;</span><br><span class="line">            <span class="built_in">customEvent</span>(e);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="事件过滤器"><a href="#事件过滤器" class="headerlink" title="事件过滤器"></a>事件过滤器</h3><p>​    对象需要查看、甚至拦截发送到另外对象的事件，Qt提供了另外一种机制来达到这一目的：事件过滤器：<br>​    事件过滤器主要是解决以下两个问题：</p>
<ul>
<li>由于event()是protected，event()需要继承已经有的类，如果组件很多，就要重写很多个event函数，这很麻烦。并且还有一个问题，就是如果基于第三方的库进行开发，而对方没有提供源码，只有一个链接库，其他都是封装好的，怎么去继承这种库中的组件问题。</li>
<li>有时希望某些组件根部看不见某些事件，event()只能做到阻拦，但是本质也是接受到了对象。使用过滤器可以让它收都收不到。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eventFilter()函数用于建立事件过滤器</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">QObject::eventFilter</span><span class="params">(QObject *watched, QEvent *evnet)</span></span>;</span><br><span class="line"><span class="comment">// installEventFilter()用于安装过滤器(类似注册监听红黑树)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QObject::installEventFilter</span><span class="params">(QObject *filter *filterObj)</span></span>;</span><br><span class="line"><span class="comment">// removeEventFilter()用于移除已经存在的过滤器</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QObject::removeEventFilter</span><span class="params">(QObject *obj)</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainWindow</span> : <span class="keyword">public</span> QMainWindow</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MainWindow</span>();</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">eventFilter</span><span class="params">(QObject *obj, QEvent *event)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QTextEdit *textEdit;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MainWindow::<span class="built_in">MainWindow</span>()</span><br><span class="line">&#123;</span><br><span class="line">    textEdit = <span class="keyword">new</span> QTextEdit;</span><br><span class="line">    <span class="built_in">setCentralWidget</span>(textEdit);</span><br><span class="line">    textEdit-&gt;<span class="built_in">installEventFilter</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MainWindow::eventFilter</span><span class="params">(QObject *obj, QEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == textEdit) &#123;</span><br><span class="line">        <span class="keyword">if</span> (event-&gt;<span class="built_in">type</span>() == QEvent::KeyPress) &#123;</span><br><span class="line">            QKeyEvent *keyEvent = <span class="built_in">static_cast</span>&lt;QKeyEvent *&gt;(event);</span><br><span class="line">            <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Are key press&quot;</span> &lt;&lt; keyEvent-&gt;<span class="built_in">key</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// pass the event on to the parent class</span></span><br><span class="line">        <span class="keyword">return</span> QMainWindow::<span class="built_in">eventFilter</span>(obj, event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    <strong>ps：事件过滤器和被安装过滤器的组件必须在同一线程创建，否则过滤器不起作用。如果在安装过滤器后，这两个组件到了不同的线程，那么只有等二者重新回到同一线程的时候过滤器才有效。</strong></p>
<h3 id="Qt的五种事件处理方式"><a href="#Qt的五种事件处理方式" class="headerlink" title="Qt的五种事件处理方式"></a>Qt的五种事件处理方式</h3><ul>
<li>重写mousePressEvent()等事件处理函数</li>
<li>重写event()函数，记得如果没有触发需要处理的事件需要调用父类的event()来转发</li>
<li>在特定的对象上安装事件过滤器，该过滤器仅过滤该对象接收到的事件</li>
<li>在 <code>QCoreApplication::instance()</code> 上安装事件过滤器，该过滤器会过滤所有事件的所有对象。但是全局过滤器有一个问题，只能用在主线程</li>
<li>重写QCoreApplication::notify()函数，这是最强大的，和全局事件过滤器一样提供完全控制，并且不受线程控制。但是在全局范围只能由一个被使用，因为CoreApplication是单例模式的</li>
</ul>
<h3 id="Qt源码事件处理过程调用函数"><a href="#Qt源码事件处理过程调用函数" class="headerlink" title="Qt源码事件处理过程调用函数"></a>Qt源码事件处理过程调用函数</h3><ol>
<li><p>进入QApplication事件循环</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> app.<span class="built_in">exec</span>();  <span class="comment">// 进入QApplication事件循环</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入QCoreApplication事件循环</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">QApplication::exec</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> QT_NO_ACCESSIBILITY</span></span><br><span class="line">    QAccessible::<span class="built_in">setRootObject</span>(qAPP);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 简单的交给QCoreApplication来处理事件循环</span></span><br><span class="line">    <span class="keyword">return</span> QCoreApplication::<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入QEventLoop事件队列循环</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">QCoreApplication::exec</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!QCoreApplicationPrivate::<span class="built_in">checkInstance</span>(<span class="string">&quot;exec&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//得到当前Thread数据  </span></span><br><span class="line">    QThreadData *threadData = self-&gt;<span class="built_in">d_func</span>()-&gt;threadData;</span><br><span class="line">    <span class="keyword">if</span> (threadData != QThreadData::<span class="built_in">current</span>()) &#123;</span><br><span class="line">        <span class="built_in">qWarning</span>(<span class="string">&quot;%s::exec: Must be called from the main thread&quot;</span>, self-&gt;<span class="built_in">metaObject</span>()-&gt;<span class="built_in">className</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//检查event loop是否已经创建 </span></span><br><span class="line">    <span class="keyword">if</span> (!threadData-&gt;eventLoops.<span class="built_in">isEmpty</span>()) &#123;</span><br><span class="line">        <span class="built_in">qWarning</span>(<span class="string">&quot;QCoreApplication::exec: The event loop is already running&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    threadData-&gt;quitNow = <span class="literal">false</span>;</span><br><span class="line">    QEventLoop eventLoop;</span><br><span class="line">    self-&gt;<span class="built_in">d_func</span>()-&gt;in_exec = <span class="literal">true</span>;</span><br><span class="line">    self-&gt;<span class="built_in">d_func</span>()-&gt;aboutToQuitEmitted = <span class="literal">false</span>;</span><br><span class="line">     <span class="comment">//委任QEventLoop 处理事件队列循环</span></span><br><span class="line">    <span class="type">int</span> returnCode = eventLoop.<span class="built_in">exec</span>();</span><br><span class="line">    threadData-&gt;quitNow = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (self) &#123;</span><br><span class="line">        self-&gt;<span class="built_in">d_func</span>()-&gt;in_exec = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!self-&gt;<span class="built_in">d_func</span>()-&gt;aboutToQuitEmitted)</span><br><span class="line">            emit self-&gt;<span class="built_in">aboutToQuit</span>();</span><br><span class="line">        self-&gt;<span class="built_in">d_func</span>()-&gt;aboutToQuitEmitted = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">sendPostedEvents</span>(<span class="number">0</span>, QEvent::DeferredDelete);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> returnCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入QEventLoop::processEvents</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">QEventLoop::exec</span><span class="params">(ProcessEventsFlags flags)</span></span>&#123;</span><br><span class="line">    <span class="built_in">Q_D</span>(QEventLoop);  <span class="comment">//访问QEventloop私有类实例d</span></span><br><span class="line">    <span class="comment">//we need to protect from race condition with QThread::exit</span></span><br><span class="line">    <span class="function">QMutexLocker <span class="title">locker</span><span class="params">(&amp;<span class="keyword">static_cast</span>&lt;QThreadPrivate *&gt;(QObjectPrivate::get(d-&gt;threadData-&gt;thread))-&gt;mutex)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (d-&gt;threadData-&gt;quitNow)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (d-&gt;inExec) &#123;</span><br><span class="line">        <span class="built_in">qWarning</span>(<span class="string">&quot;QEventLoop::exec: instance %p has already called exec()&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    d-&gt;inExec = <span class="literal">true</span>;</span><br><span class="line">    d-&gt;exit = <span class="literal">false</span>;</span><br><span class="line">    ++d-&gt;threadData-&gt;loopLevel;</span><br><span class="line">    d-&gt;threadData-&gt;eventLoops.<span class="built_in">push</span>(<span class="keyword">this</span>);</span><br><span class="line">    locker.<span class="built_in">unlock</span>();</span><br><span class="line">    <span class="comment">// remove posted quit events when entering a new event loop</span></span><br><span class="line">    QCoreApplication *app = QCoreApplication::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> (app &amp;&amp; app-&gt;<span class="built_in">thread</span>() == <span class="built_in">thread</span>())</span><br><span class="line">        QCoreApplication::<span class="built_in">removePostedEvents</span>(app, QEvent::Quit);</span><br><span class="line">    <span class="comment">//这里的实现代码不少，最为重要的是以下几行 </span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(QT_NO_EXCEPTIONS)</span></span><br><span class="line">    <span class="keyword">while</span> (!d-&gt;exit)</span><br><span class="line">        <span class="built_in">processEvents</span>(flags | WaitForMoreEvents | EventLoopExec);<span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!d-&gt;exit)  <span class="comment">//只要没有遇见exit，循环派发事件 </span></span><br><span class="line">            <span class="built_in">processEvents</span>(flags | WaitForMoreEvents | EventLoopExec);</span><br><span class="line">    &#125; <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">        <span class="built_in">qWarning</span>(<span class="string">&quot;Qt has caught an exception thrown from an event handler. Throwing\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;exceptions from an event handler is not supported in Qt. You must\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;reimplement QApplication::notify() and catch all exceptions there.\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// copied from below        locker.relock();</span></span><br><span class="line">        QEventLoop *eventLoop = d-&gt;threadData-&gt;eventLoops.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="built_in">Q_ASSERT_X</span>(eventLoop == <span class="keyword">this</span>, <span class="string">&quot;QEventLoop::exec()&quot;</span>, <span class="string">&quot;internal error&quot;</span>);</span><br><span class="line">        <span class="built_in">Q_UNUSED</span>(eventLoop); <span class="comment">// --release warning</span></span><br><span class="line">        d-&gt;inExec = <span class="literal">false</span>;</span><br><span class="line">        --d-&gt;threadData-&gt;loopLevel;</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;<span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// copied above    locker.relock();</span></span><br><span class="line">    QEventLoop *eventLoop = d-&gt;threadData-&gt;eventLoops.<span class="built_in">pop</span>();</span><br><span class="line">    <span class="built_in">Q_ASSERT_X</span>(eventLoop == <span class="keyword">this</span>, <span class="string">&quot;QEventLoop::exec()&quot;</span>, <span class="string">&quot;internal error&quot;</span>);</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(eventLoop); <span class="comment">// --release warning</span></span><br><span class="line">    d-&gt;inExec = <span class="literal">false</span>;</span><br><span class="line">    --d-&gt;threadData-&gt;loopLevel;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> d-&gt;returnCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>事件处理QEventDispatcherWin32::processEvents</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QEventLoop::processEvents</span><span class="params">(ProcessEventsFlags flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">Q_D</span>(QEventLoop);</span><br><span class="line">    <span class="keyword">if</span> (!d-&gt;threadData-&gt;eventDispatcher)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; DeferredDeletion)</span><br><span class="line">        QCoreApplication::<span class="built_in">sendPostedEvents</span>(<span class="number">0</span>, QEvent::DeferredDelete);</span><br><span class="line"><span class="comment">//将事件派发给与平台相关的QAbstractEventDispatcher子类 </span></span><br><span class="line">    <span class="keyword">return</span> d-&gt;threadData-&gt;eventDispatcher-&gt;<span class="built_in">processEvents</span>(flags);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将获取的事件打包为消息，传递给操作系统：AbstractEventDispatcher的子类QEventDispatcherWin32获得用户的输入事件，并将其打包成message后，通过标准的Windows API传递给Windows OS</p>
</li>
<li><p>操作系统将事件发回给Qt平台</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">LRESULT QT_WIN_CALLBACK <span class="title">QtWndProc</span><span class="params">(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)</span>     </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//将消息重新封装成QEvent的子类QMouseEvent ==&gt; Section 8</span></span><br><span class="line">         result = widget-&gt;<span class="built_in">translateMouseEvent</span>(msg);</span><br><span class="line">         ...     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将操作系统打包的事件解包，翻译成QApplication可识别的事件</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QApplicationPrivate::sendMouseEvent</span><span class="params">(QWidget *receiver, QMouseEvent *event,</span></span></span><br><span class="line"><span class="params"><span class="function">  QWidget *alienWidget, QWidget *nativeWidget,QWidget **buttonDown,  QPointer&lt;QWidget&gt; &amp;lastMouseReceiver,<span class="type">bool</span> spontaneous)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (spontaneous)</span><br><span class="line">        result = QApplication::<span class="built_in">sendSpontaneousEvent</span>(receiver, event);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        result = QApplication::<span class="built_in">sendEvent</span>(receiver, event);</span><br><span class="line">      </span><br><span class="line">    ...</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据事件类型发送事件</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QApplicationPrivate::sendMouseEvent</span><span class="params">(QWidget *receiver, QMouseEvent *event,</span></span></span><br><span class="line"><span class="params"><span class="function">  QWidget *alienWidget, QWidget *nativeWidget,QWidget **buttonDown,  QPointer&lt;QWidget&gt; &amp;lastMouseReceiver,<span class="type">bool</span> spontaneous)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (spontaneous)</span><br><span class="line">        result = QApplication::<span class="built_in">sendSpontaneousEvent</span>(receiver, event);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        result = QApplication::<span class="built_in">sendEvent</span>(receiver, event);</span><br><span class="line">      </span><br><span class="line">    ...</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送事件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">QCoreApplication::sendSpontaneousEvent</span><span class="params">(QObject *receiver, QEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">      <span class="comment">//将event标记为自发事件</span></span><br><span class="line">     <span class="comment">//进一步调用 2-5 QCoreApplication::notifyInternal     </span></span><br><span class="line">      <span class="keyword">if</span> (event) </span><br><span class="line">          event-&gt;spont = <span class="literal">true</span>; </span><br><span class="line">      <span class="keyword">return</span> self ? self-&gt;<span class="built_in">notifyInternal</span>(receiver, event) : <span class="literal">false</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>线程内事件的处理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QCoreApplication::notifyInternal</span><span class="params">(QObject *receiver, QEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    <span class="comment">// 以下代码主要意图为Qt强制事件只能够发送给当前线程里的对象，也就是说receiver-&gt;d_func()-&gt;threadData应该等于QThreadData::current()。</span></span><br><span class="line">    <span class="comment">//注意，跨线程的事件需要借助Event Loop来派发</span></span><br><span class="line">    QObjectPrivate *d = receiver-&gt;<span class="built_in">d_func</span>();</span><br><span class="line">    QThreadData *threadData = d-&gt;threadData;</span><br><span class="line">    ++threadData-&gt;loopLevel;</span><br><span class="line">    QT_TRY &#123;</span><br><span class="line">        returnValue = <span class="built_in">notify</span>(receiver, event);</span><br><span class="line">    &#125; <span class="built_in">QT_CATCH</span> (...) &#123;</span><br><span class="line">        --threadData-&gt;loopLevel;</span><br><span class="line">        QT_RETHROW;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>事件的派发：任何线程的任何对象的所有事件在发送时都会调用notify函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QCoreApplication::notify</span><span class="params">(QObject *receiver, QEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">Q_D</span>(QCoreApplication);</span><br><span class="line">    <span class="comment">// no events are delivered after ~QCoreApplication() has started</span></span><br><span class="line">    <span class="keyword">if</span> (QCoreApplicationPrivate::is_app_closing)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (receiver == <span class="number">0</span>) &#123;                        <span class="comment">// serious error</span></span><br><span class="line">        <span class="built_in">qWarning</span>(<span class="string">&quot;QCoreApplication::notify: Unexpected null receiver&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> QT_NO_DEBUG</span></span><br><span class="line">    d-&gt;<span class="built_in">checkReceiverThread</span>(receiver);<span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> receiver-&gt;<span class="built_in">isWidgetType</span>() ? <span class="literal">false</span> : d-&gt;<span class="built_in">notify_helper</span>(receiver, event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用事件过滤器对发送的对象进行处理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QCoreApplicationPrivate::notify_helper</span><span class="params">(QObject *receiver, QEvent * event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// send to all application event filters</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sendThroughApplicationEventFilters</span>(receiver, event))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     <span class="comment">// 向事件过滤器发送该事件，这里介绍一下Event Filters. 事件过滤器是一个接受即将发送给目标对象所有事件的对象。 </span></span><br><span class="line">    <span class="comment">//如代码所示它开始处理事件在目标对象行动之前。过滤器的QObject::eventFilter（）实现被调用，能接受或者丢弃过滤</span></span><br><span class="line">    <span class="comment">//允许或者拒绝事件的更进一步的处理。如果所有的事件过滤器允许更进一步的事件处理，事件将被发送到目标对象本身。</span></span><br><span class="line">    <span class="comment">//如果他们中的一个停止处理，目标和任何后来的事件过滤器不能看到任何事件。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sendThroughObjectEventFilters</span>(receiver, event))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> receiver-&gt;<span class="built_in">event</span>(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>事件派发至QObject的子类QWidget</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QWidget::event</span><span class="params">(QEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (event-&gt;<span class="built_in">type</span>()) &#123;</span><br><span class="line">    <span class="keyword">case</span> QEvent::MouseMove:</span><br><span class="line">        <span class="built_in">mouseMoveEvent</span>((QMouseEvent*)event);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> QEvent::MouseButtonPress:</span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">        <span class="built_in">resetInputContext</span>();</span><br><span class="line"> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="built_in">mousePressEvent</span>((QMouseEvent*)event);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="绘图系统"><a href="#绘图系统" class="headerlink" title="绘图系统"></a>绘图系统</h3><p>​    Qt的绘图系统基于QPatinter、QPaintDevice、QPaintEngine三个类实现，QPainter用来执行绘制操作，QPaintDevice是一个二维空间的抽象，允许QPainter在其上面进行绘制，也就是QPainter工作的空间，QPaintEngine提供了在不同设备上进行绘制的统一的接口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PaintedWidget</span> : <span class="keyword">public</span> QWidget</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">PaintedWidget</span>(QWidget *parent = <span class="number">0</span>);</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">paintEvent</span><span class="params">(QPaintEvent *)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">PaintedWidget::<span class="built_in">PaintedWidget</span>(QWidget *parent) : <span class="built_in">QWidget</span>(parent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">resize</span>(<span class="number">800</span>, <span class="number">600</span>);</span><br><span class="line">    <span class="built_in">setWindowTitle</span>(<span class="built_in">tr</span>(<span class="string">&quot;Paint Demo&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PaintedWidget::paintEvent</span><span class="params">(QPaintEvent *)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QPainter <span class="title">painter</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">    painter.<span class="built_in">drawLine</span>(<span class="number">80</span>, <span class="number">100</span>, <span class="number">650</span>, <span class="number">500</span>);</span><br><span class="line">    painter.<span class="built_in">setPen</span>(Qt::red);</span><br><span class="line">    painter.<span class="built_in">drawRect</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">400</span>);</span><br><span class="line">    painter.<span class="built_in">setPen</span>(<span class="built_in">QPen</span>(Qt::green, <span class="number">5</span>));</span><br><span class="line">    painter.<span class="built_in">setBrush</span>(Qt::blue);</span><br><span class="line">    painter.<span class="built_in">drawEllipse</span>(<span class="number">50</span>, <span class="number">150</span>, <span class="number">400</span>, <span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绘图设备"><a href="#绘图设备" class="headerlink" title="绘图设备"></a>绘图设备</h3><p>​    绘图设备是指继承QPaintDevice的子类。Qt一共提供四种这样的类，分别为：</p>
<ul>
<li>QPixmap，专门为图像在屏幕上的显示做了优化</li>
<li>QBitmap，是QPixmap的一个子类，他的色深限定为1，可以使用QPismap的isQBitmap()来确定这个QPismap是不是一个QBitmap</li>
<li>QImage，专门为图像的像素级访问做了优化</li>
<li>QPicture，可以记录可重视QPainter的各条命令</li>
</ul>
<h4 id="QPixmap"><a href="#QPixmap" class="headerlink" title="QPixmap"></a>QPixmap</h4><p>​    继承了QPaintDevice，可以使用QPainter直接在上面绘制图形，也可以接受一个文件名来显示这个文件。QPixmap针对屏幕进行特殊优化，因此，它与实际的底层显示设备息息相关，在不同的操作平台下，QPixmap的显示有所不同。</p>
<h4 id="QBitmap"><a href="#QBitmap" class="headerlink" title="QBitmap"></a>QBitmap</h4><p>​    继承自QPixmap，因此具有QPixmap的所有属性，提供单色图像，QBitmap的色深始终为1，表示他所显示的颜色只有黑白两种，所以说Qbitmap实际上是只有黑白两色的图像数据。由于QBitmap色深小，因此只占用很少的空间，所以适合做光标文件和笔刷。</p>
<h4 id="QImage"><a href="#QImage" class="headerlink" title="QImage"></a>QImage</h4><p>​    QImage主要用于图像I&#x2F;O、图片访问和像素修改而设计的，由于QImage是独立于硬件的，也是一种QPaintDevice，因此我们可以在另一个线程种对其进行绘制，而不需要在GUI线程中处理，使用这一方式可以很大幅度提高UI响应速度，与QPixmap可以互相转换：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QPixmap <span class="title">fromImage</span><span class="params">(<span class="type">const</span> QImage &amp;image, Qt::ImageConversionFlags flags = Qt::AutoColor;</span></span></span><br><span class="line"><span class="params"><span class="function">QImage toImage() <span class="type">const</span>;</span></span></span><br></pre></td></tr></table></figure>

<h4 id="QPicture"><a href="#QPicture" class="headerlink" title="QPicture"></a>QPicture</h4><p>​    这是一个可以记录和重现QPainter命令的绘图设备，QPicture将QPainter的命令序列化到一个I&#x2F;O设备，保存为一个平台独立的文件格式。</p>
<h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><ul>
<li>QIODevice：所有I&#x2F;O设备的父类，提供了字节块读写的通用操作以及基本接口</li>
<li>QFileDevice：Qt5新增的类，提供了有关文件操作的通用实现</li>
<li>QFile：访问本地文件或者嵌入资源</li>
<li>QTemporaryFile：创建和访问本地文件系统的临时文件</li>
<li>QBuffer：读写QbyteArray，内存文件</li>
<li>QProcess：运行外部程序，处理进程间通信</li>
<li>QAbstractSocket：所有套接字类的父类</li>
<li>QTcpSocket：Tcp协议网络数据传输</li>
<li>QUdpSocket：Udp协议网络数据传输</li>
<li>QSslSocket：使用SSL&#x2F;TLS传输数据</li>
</ul>
<p>​    文件系统分为以下两类：</p>
<ul>
<li><p>顺序访问设备</p>
<p>  是指他们的数据只能访问一遍，从头走到尾，从第一个字节开始访问，直到最后一个字节，中途不能返回读取上一个字节，QProcess、QTcpSocket、QUdpSocket、QSslSocket是顺序访问设备</p>
</li>
<li><p>随机访问设备</p>
<p>  可以访问任意位置任意次数，还可以使用QIODevice::seek()函数来重新定位文件访问位置指针，QFile、QTemporaryFule和QBuffer是随机访问设备</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">    QString s = QDir::<span class="built_in">currentPath</span>();  <span class="comment">// 获得应用程序执行时的当前路径</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; s; </span><br><span class="line">    <span class="function">QFile <span class="title">file</span><span class="params">(<span class="string">&quot;in.txt&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!file.<span class="built_in">open</span>(QIODevice::ReadOnly|QIODevice::Text)) &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Open file failed.&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!file.<span class="built_in">atEnd</span>()) &#123;</span><br><span class="line">            <span class="built_in">qDebug</span>() &lt;&lt; file.<span class="built_in">readLine</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">QFileInfo <span class="title">info</span><span class="params">(file)</span></span>;  <span class="comment">// 使用QFileInfo获取有关该文件的信息</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; info.<span class="built_in">isDir</span>();             <span class="comment">// 是否为目录</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; info.<span class="built_in">isExecutable</span>();      <span class="comment">// 检查文件是否可执行</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; info.<span class="built_in">baseName</span>();          <span class="comment">// 直接获取文件名</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; info.<span class="built_in">completeBaseName</span>();  <span class="comment">// 获取完整的文件名</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; info.<span class="built_in">suffix</span>();            <span class="comment">// 直接获取文件后缀</span></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; info.<span class="built_in">completeSuffix</span>();    <span class="comment">// 获取完整的文件后缀</span></span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    QFileInfo fi(&quot;/tmp/archive.tar.gz&quot;);</span></span><br><span class="line"><span class="comment">    QString base  = fi.baseName();  // base = &quot;archive&quot;</span></span><br><span class="line"><span class="comment">    QString base  = fi.completeBaseName();  // base = &quot;archive.tar&quot;</span></span><br><span class="line"><span class="comment">    QString ext   = fi.suffix();  // ext = &quot;gz&quot;</span></span><br><span class="line"><span class="comment">    QString ext   = fi.completeSuffix();  // ext = &quot;tar.gz&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="二进制文件的读写"><a href="#二进制文件的读写" class="headerlink" title="二进制文件的读写"></a>二进制文件的读写</h3><p>​    QDataStream提供了基于QIODevice的二进制数据的序列化，数据流是一种二进制流，这种流完全不依赖底层操作系统、CPU或字节顺序。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QFile <span class="title">file</span><span class="params">(<span class="string">&quot;file.dat&quot;</span>)</span></span>;</span><br><span class="line">file.<span class="built_in">open</span>(QIODevice::WriteOnly);</span><br><span class="line"><span class="function">QDataStream <span class="title">out</span><span class="params">(&amp;file)</span></span>;</span><br><span class="line">out &lt;&lt; <span class="built_in">QString</span>(<span class="string">&quot;the answer is&quot;</span>);</span><br><span class="line">out &lt;&lt; (qint32)<span class="number">42</span>;</span><br></pre></td></tr></table></figure>

<h3 id="文本文件读写"><a href="#文本文件读写" class="headerlink" title="文本文件读写"></a>文本文件读写</h3><p>​    操作文本文件需要使用QTextStream，它会将Unicode编码同操作系统的编码进行转换。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QFile <span class="title">data</span><span class="params">(<span class="string">&quot;file.txt&quot;</span>)</span></span>;</span><br><span class="line"><span class="keyword">if</span> (data.<span class="built_in">open</span>(QFile::WriteOnly | QIODevice::Truncate)) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">QTextStream <span class="title">out</span><span class="params">(&amp;data)</span></span>;</span><br><span class="line">    out.<span class="built_in">setCodec</span>(<span class="string">&quot;UTF-8&quot;</span>);  <span class="comment">// 设置编码，默认为Unicode</span></span><br><span class="line">    out &lt;&lt; <span class="string">&quot;The answer is &quot;</span> &lt;&lt; <span class="number">42</span>;</span><br><span class="line">&#125;</span><br><span class="line">QTextStream::<span class="built_in">readline</span>();</span><br><span class="line">QTextStream::<span class="built_in">readAll</span>();</span><br></pre></td></tr></table></figure>

<p>​    open()中有一些打开方式，为枚举值存储的打开方式：</p>
<ul>
<li>QIODevice::ReadOnly：只读方式打开</li>
<li>QIODevice::WriteOnly：只写方式打开</li>
<li>QIODevice::NotOpen：未打开</li>
<li>QIODevice::ReadWrite：读写方式打开</li>
<li>QIODevice::Append：以追加方式打开，新增的内容将被追加到文件末尾</li>
<li>QIODevice::Truncate：以重写方式打开，再写入新的数据时会将原有的数据全部清除，游标设置在文件开头</li>
<li>QIODevice::Text：在读取时，将行结束符转换为\n；在写入时，将结束符转换成本地格式</li>
<li>QIODevice::Unbuffered：忽略缓存</li>
</ul>
<h3 id="Qt多线程"><a href="#Qt多线程" class="headerlink" title="Qt多线程"></a>Qt多线程</h3><p>​    每个程序启动后拥有的第一个线程成为主线程，即GUI线程，Qt中所有的组件类和其他几个相关的类只能工作在GUI线程，不能工作在子线程，子线程主要负责处理GUI卸下的工作。每个线程都有自己的栈空间，因此每个线程都要自己调用历史和本地变量，线程共享相同的地址空间。Qt中的线程类包含如下：</p>
<ul>
<li>QThread：提供了跨平台的多线程解决方案</li>
<li>QThreadStorage：提供了逐线程数据存储</li>
<li>QMutex：提供相互排斥的锁，或互斥量</li>
<li>QMutexLocker：是一个辅助类，自动对QMutex加锁与解锁</li>
<li>QReadWriteLock：提供一个可以同时读操作的锁</li>
<li>QReadLocker，QWriteLocker：自动对QReadWriteLock加锁解锁</li>
<li>QSemaphore：提供了一个整型信号量，是互斥量的泛化</li>
<li>QWaitCondtion：提供了一种方法，使得线程可以被另外线程唤醒前一直休眠</li>
</ul>
<h4 id="1-QThread线程"><a href="#1-QThread线程" class="headerlink" title="1.QThread线程"></a>1.QThread线程</h4><p>​    QThread是Qt线程中的一个公共抽象类，所有的线程类都是从QThread抽象类中派生出来的，需要实现QThread中的虚函数run()，通过start()调用run()：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">QThread::<span class="built_in">QThread</span>(QObject *parent=Q_NULLPTR);  <span class="comment">// 构造</span></span><br><span class="line">[<span class="keyword">virtual</span> <span class="keyword">protected</span>] <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span></span>;  <span class="comment">// 线程体函数，用于定义线程的功能</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">(Priority priority=InheritPriority)</span></span>;  <span class="comment">// 线程启动函数，用于将线程入口地址设置为run函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">exit</span><span class="params">(<span class="type">int</span> returnCode=<span class="number">0</span>)</span></span>;  <span class="comment">// 退出线程的工作函数，一般调用后不会直接退出，因为可能有任务还未完成</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">wait</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> time = ULONG_MAX)</span></span>;  <span class="comment">// 一般在exit后调用wait，等待任务完成退出线程，即阻塞线程</span></span><br><span class="line">[slot] <span class="function"><span class="type">void</span> <span class="title">terminate</span><span class="params">()</span></span>;  <span class="comment">// 强制结束线程，不保证数据完整性和资源释放</span></span><br><span class="line">[slot] <span class="function"><span class="type">void</span> <span class="title">quit</span><span class="params">()</span></span>;  <span class="comment">// 退出子线程</span></span><br><span class="line">QCoreApplication::<span class="built_in">exec</span>();  <span class="comment">// 总是在主线程中被调用，不能从一个QThread中调用</span></span><br><span class="line">[signal] <span class="function"><span class="type">void</span> <span class="title">started</span><span class="params">()</span></span>;  <span class="comment">// 线程启动时发送的信号</span></span><br><span class="line">[signal] <span class="function"><span class="type">void</span> <span class="title">finished</span><span class="params">()</span></span>;  <span class="comment">// 线程结束时发送的信号</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isRunning</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 子线程是否在执行任务</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isFinished</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 线程中的任务是否处理完毕</span></span><br><span class="line">[<span class="type">static</span>] <span class="function"><span class="type">int</span> <span class="title">currentThreadId</span><span class="params">()</span></span>;  <span class="comment">// 返回标识当前正在执行的线程，返回线程的ID</span></span><br><span class="line">[<span class="type">static</span>] <span class="function">QThread* <span class="title">currentThread</span><span class="params">()</span></span>;  <span class="comment">// 同上，返回线程指针</span></span><br><span class="line">[<span class="type">static</span>] <span class="function"><span class="type">void</span> <span class="title">msleep</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> msecs)</span></span>;	<span class="comment">// 单位: 毫秒</span></span><br><span class="line">[<span class="type">static</span>] <span class="function"><span class="type">void</span> <span class="title">sleep</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> secs)</span></span>;	<span class="comment">// 单位: 秒</span></span><br><span class="line">[<span class="type">static</span>] <span class="function"><span class="type">void</span> <span class="title">usleep</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> usecs)</span></span>;	<span class="comment">// 单位: 微秒</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setPriority</span><span class="params">(Priority priority)</span></span>;  <span class="comment">// 设置正在运行线程的优先级</span></span><br></pre></td></tr></table></figure>

<p>​    线程优先级：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QThread::IdlePriority          <span class="number">0</span><span class="comment">// 最低的优先级</span></span><br><span class="line">QThread::LowestPriority        <span class="number">1</span>   </span><br><span class="line">QThread::LowPriority           <span class="number">2</span></span><br><span class="line">QThread::NormalPriority        <span class="number">3</span> </span><br><span class="line">QThread::HighPriority          <span class="number">4</span></span><br><span class="line">QThread::HighestPriority       <span class="number">5</span></span><br><span class="line">QThread::TimeCriticalPriority  <span class="number">6</span><span class="comment">// 最高的优先级</span></span><br><span class="line">QThread::InheritPriority       <span class="number">7</span><span class="comment">// 子线程和其父线程的优先级相同, 默认是这个</span></span><br></pre></td></tr></table></figure>

<h4 id="2-Mutex互斥量"><a href="#2-Mutex互斥量" class="headerlink" title="2.Mutex互斥量"></a>2.Mutex互斥量</h4><p>​    提供互斥锁或呼出量，QMutex类的所有成员函数是线程安全的，如果对没有加锁的互斥量进行解锁，结果是未定义的，加锁和解锁必须成对出现，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">构造函数，默认为NonRecursive模式，还有另一种Recursive模式</span></span><br><span class="line"><span class="comment">NonRecursive只能被lock一次</span></span><br><span class="line"><span class="comment">Recursive可以被lock很多次，直到相应次数的unlock调用后，才被真正的解锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">QMutex::<span class="built_in">QMutex</span>(RecursionMode mode = NonRecursive); </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span></span>;  <span class="comment">// 阻塞加锁</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span></span>;  <span class="comment">// 解锁</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">trylock</span><span class="params">()</span></span>;  <span class="comment">// 尝试加锁，不会被阻塞</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">trylock</span><span class="params">(inb timeout)</span></span>;  <span class="comment">// 阻塞等待timeout时间，超时则返回</span></span><br></pre></td></tr></table></figure>

<h4 id="3-QMutexLocker互斥锁"><a href="#3-QMutexLocker互斥锁" class="headerlink" title="3.QMutexLocker互斥锁"></a>3.QMutexLocker互斥锁</h4><p>​    引入QMutexLocker辅助QMutex来避免lcok与unlock操作，QMutexLocker对象创建时，把mutex指针传给这个对象，此时mutex指针已经加锁，等待释放QMutexLocker会销毁并解锁mutex：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QMutexLocker::<span class="built_in">QMutexLocker</span>(QRecurisiveMutex *mutex);  <span class="comment">// 构造</span></span><br><span class="line">QMutexLocker::<span class="built_in">QMutexLocker</span>(QMutex *mutex);</span><br></pre></td></tr></table></figure>

<h4 id="4-QReadWriteLock读写操作锁"><a href="#4-QReadWriteLock读写操作锁" class="headerlink" title="4.QReadWriteLock读写操作锁"></a>4.QReadWriteLock读写操作锁</h4><p>​    允许多个读者读，但是只允许一个写，并且写读操作不同时进行：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">QReadWriteLock::<span class="built_in">QReadWriteLock</span>(QReadWriteLock::RecursionMode recursionMode=NonRecursive);  <span class="comment">// 构造，默认为NonRecursive</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lockForRead</span><span class="params">()</span></span>;  <span class="comment">// 上读锁</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lockForWrite</span><span class="params">()</span></span>;  <span class="comment">// 上写锁</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">tryLockForRead</span><span class="params">()</span></span>;  <span class="comment">// 尝试上读锁</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">tryLockForWrite</span><span class="params">()</span></span>;  <span class="comment">// 尝试上写锁</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">tryLockForRead</span><span class="params">(<span class="type">int</span> timeout)</span></span>;  <span class="comment">// 阻塞等待timeout时间，超时则返回</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">tryLockForWrite</span><span class="params">(<span class="type">int</span> timeout)</span></span>;  <span class="comment">// 阻塞等待timeout时间，超时则返回</span></span><br></pre></td></tr></table></figure>

<h4 id="5-QReadLocker和QWriteLocker"><a href="#5-QReadLocker和QWriteLocker" class="headerlink" title="5.QReadLocker和QWriteLocker"></a>5.QReadLocker和QWriteLocker</h4><p>​    类似QMutexLocker，二者对QReadWriteLock进行复制，在需要加读锁的地方使用QReadLocker，需要加写锁的地方使用QWriteLocker，用法和QMutexLocker差不多。</p>
<h4 id="6-信号量QSemaphore"><a href="#6-信号量QSemaphore" class="headerlink" title="6.信号量QSemaphore"></a>6.信号量QSemaphore</h4><p>​    是一个特殊的线程锁，允许多个线程同时访问临界资源，QSemaphore的所有成员函数都是现成安全的:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QSemaphore::<span class="built_in">QSemaphore</span>(<span class="type">int</span> n = <span class="number">0</span>);  <span class="comment">// 创建保护n个资源的信号量</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">acquire</span><span class="params">(<span class="type">int</span> n = <span class="number">1</span>)</span></span>;  <span class="comment">// 尝试用获取信号量保护的n个资源，如果n大于available()，将被阻塞等待</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">available</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 返回信号量当前可用资源</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">(<span class="type">int</span> n = <span class="number">1</span>)</span></span>;  <span class="comment">// 释放信号量保护的n个资源</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">tryAcquire</span><span class="params">(<span class="type">int</span> n = <span class="number">1</span>)</span></span>;  <span class="comment">// 尝试获取n个信号量资源，不阻塞等待</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">tryAcquire</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> timeout)</span></span>;  <span class="comment">// 阻塞等待timeout时间，超时则返回</span></span><br></pre></td></tr></table></figure>

<h4 id="7-QWaitCondition等待条件"><a href="#7-QWaitCondition等待条件" class="headerlink" title="7.QWaitCondition等待条件"></a>7.QWaitCondition等待条件</h4><p>​    QWaitCondition允许线程在某些情况发生时唤醒另外的线程，一个或多个线程可以阻塞等待条件变量：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">QWaitCondition::<span class="built_in">QWaitCondition</span>();  <span class="comment">// 构造</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">notify_all</span><span class="params">()</span></span>;  <span class="comment">// 唤醒所有等待线程(Qt5.8以后)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">wakeAll</span><span class="params">()</span></span>;  <span class="comment">// 唤醒所有等待线程(Qt5.8以前)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">notify_once</span><span class="params">()</span></span>;  <span class="comment">// 随即唤醒一个线程</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">wakeOne</span><span class="params">()</span></span>;  <span class="comment">//随即唤醒一个线程(Qt5.8以前)</span></span><br><span class="line"><span class="comment">// 释放lockedMutex并阻塞在等待条件上直到满足条件或超时</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">wait</span><span class="params">(QMutex *lockedMutex, <span class="type">unsigned</span> <span class="type">long</span> time = ULONG_MAX)</span></span>;</span><br><span class="line"><span class="comment">// 释放锁定的读写锁，并阻塞在条件变量上直到满足条件或超时</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">wait</span><span class="params">(QReadWriteLock *lockedReadWriteLock, <span class="type">unsigned</span> <span class="type">long</span> time = ULONG_MAX)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="8-QThreadStroage"><a href="#8-QThreadStroage" class="headerlink" title="8.QThreadStroage"></a>8.QThreadStroage</h4><p>​    提供了每个线程数据存储的模板类：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">QThreadStorage::<span class="built_in">QThreadStorage</span>();  <span class="comment">// 构造</span></span><br><span class="line"><span class="comment">// 如果T是指针类型，若调用的线程有非0数据则返回true  </span></span><br><span class="line"><span class="comment">// 如果T是指类型，则返回为数据是否被setLocalData或localData构造</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">QThreadStorage::hasLocalData</span><span class="params">()</span> <span class="type">const</span></span>;  </span><br><span class="line"><span class="function">T&amp; <span class="title">localData</span><span class="params">()</span></span>;  <span class="comment">// 返回线程的设置的数据的引用</span></span><br><span class="line"><span class="function">T <span class="title">localData</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 返回线程的设置的数据的副本（深拷贝）</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setLocalData</span><span class="params">(T data)</span></span>;  <span class="comment">// 将调用线程的数据设置为data</span></span><br></pre></td></tr></table></figure>

<h3 id="QML语言"><a href="#QML语言" class="headerlink" title="QML语言"></a>QML语言</h3><p>​    QML是一种声明语言，用于描述程序界面，QML将用户界面分解成一块块小的元素，每一个元素都由很多组件构成。</p>
<h4 id="QML基础语法"><a href="#QML基础语法" class="headerlink" title="QML基础语法"></a>QML基础语法</h4><ul>
<li><p>import语句：import写在头几行，主要用于包含类型的命名空间，包含QML代码文件的目录，js代码文件</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Namespace VersionMajor.VersionMinor</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../directroy&quot;</span></span><br><span class="line"><span class="keyword">import</span> QtQuick2<span class="number">.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对象声明：QML代码都定义一个对象树，所有QtQuick元素都是继承自QQuickItem，对象类型以大写字母开头，在定义对象的同时，对象的属性也会被赋初值</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rectangle&#123;</span><br><span class="line">    width: <span class="number">100</span></span><br><span class="line">    height: <span class="number">100</span></span><br><span class="line">    color: <span class="string">&quot;red&quot;</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>子对象：每个QML对象中可以包含无限个子对象</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Rectangle&#123;</span><br><span class="line">    width: <span class="number">100</span></span><br><span class="line">    height: <span class="number">100</span></span><br><span class="line">    color: <span class="string">&quot;red&quot;</span> </span><br><span class="line">    Text&#123;</span><br><span class="line">        anchors.centerIn : parent</span><br><span class="line">        text: <span class="string">&quot;Hello QML&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注释：类似c++，有两种</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单行注释</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">多行注释</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>模块声明：QML中每个类都单独存放一个文件，每个文件都是一个模块，但不能单独声明一个函数，函数必须写在类内，引用时以模块名引用</p>
</li>
<li><p>表达式：可以包含其他对象与属性的引用，会建立约束关联</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Item</span><br><span class="line">&#123;</span><br><span class="line">     Text</span><br><span class="line">     &#123;</span><br><span class="line">         id: text1</span><br><span class="line">         x:<span class="number">2</span>;y:<span class="number">2</span></span><br><span class="line">         text: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">     Text</span><br><span class="line">     &#123;</span><br><span class="line">         id: text2</span><br><span class="line">         x:<span class="number">2</span>;y:<span class="number">20</span></span><br><span class="line">         text: text1.text</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>信号处理器：允许响应事件时处理动作</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MouseArea&#123;</span><br><span class="line">    acceptedButtons: Qt.LeftButton | Qt.RightButton</span><br><span class="line">    onPressed:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mouse.button == Qt.RightButton)</span><br><span class="line">            console.<span class="built_in">log</span>(<span class="string">&quot;right mouse button pressed&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="基本的可视化项"><a href="#基本的可视化项" class="headerlink" title="基本的可视化项"></a>基本的可视化项</h4><p>​    可视元素具有几何坐标，会在屏幕上占据一块显示区域：</p>
<ul>
<li>Item：基本的项元素，所有可视化项都继承自Item</li>
<li>Rectangle：基本的可视化矩形元素，在Item的基础上增加了填充色属性、边框相关的属性</li>
<li>Gradient：定义一个两种颜色的渐变过程</li>
<li>GradientStop：定义一个颜色，被Gradient使用</li>
<li>Image：在场景中使用位图</li>
<li>BorderImage：定义一张图片作为边界</li>
<li>AnimatedImage：为播放动画存储一系列的帧</li>
<li>Text：在场景中使用文本</li>
<li>TextEdit：显示多行可编辑文本</li>
<li>TextInput：显示可编辑为文本</li>
<li>IntValidatorint：验证器</li>
<li>DoubleValidator：double验证器</li>
<li>RegExpValidator：验证字符串正则表达式</li>
</ul>
<h4 id="基本的交互项"><a href="#基本的交互项" class="headerlink" title="基本的交互项"></a>基本的交互项</h4><p>​    不可视元素通常提供一种作用于可视元素的功能：</p>
<ul>
<li>MouseArea：鼠标句柄交互</li>
<li>FocusScope：键盘焦点句柄</li>
<li>Flickable：提供一种浏览整张图片的一部分的效果</li>
<li>Flipable：提供一个平面，可以进行翻转看前面或后面</li>
</ul>
<h4 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h4><ul>
<li>State：定义一个配置对象和属性的集合</li>
<li>PropertyChanges：使用一个State描述属性的改变</li>
<li>StateGroup：包含一个状态集合和状态变换</li>
<li>ParentChange：重新定义父集，也就是换父节点</li>
<li>AnchorChanges：在一个状态中改变anchors</li>
</ul>
<h4 id="动画和变换"><a href="#动画和变换" class="headerlink" title="动画和变换"></a>动画和变换</h4><p>​    有很多…</p>
<h3 id="QML与c-混合编程（交互）"><a href="#QML与c-混合编程（交互）" class="headerlink" title="QML与c++混合编程（交互）"></a>QML与c++混合编程（交互）</h3><p>​    QML访问c++有两个方法：</p>
<ol>
<li><p>在Qt元对象系统中注册c++类，在QML中实例化、访问，使c++类在QML中作为一个数据类型使用</p>
<p> ​    信号在QML中使用和普通函数一样</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//C++类实现</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HELLO_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HELLO_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hello</span>: <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line"><span class="function">Q_OBJECT</span></span><br><span class="line"><span class="function"><span class="title">Q_ENUMS</span><span class="params">(Color)</span>  <span class="comment">// 枚举类型需要Q_ENUMS,在QML中使用&#x27;.&#x27;操作符直接访问枚举变量</span></span></span><br><span class="line"><span class="function"><span class="comment">// 属性声明,需要使用Q_PROPERTY宏，属性同类的数据成员一样，但又有额外的特性可通过Qt元对象系统来访问，READ读取属性值，WRITE设置属性值，NOTIFY与属性关联的可选信号</span></span></span><br><span class="line"><span class="function"><span class="title">Q_PROPERTY</span><span class="params">(Color color READ color WRITE setColor NOTIFY colorChanged)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span>:</span></span><br><span class="line"><span class="function">    Hello() : m_color(RED)</span></span><br><span class="line"><span class="function">    &#123;</span></span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Hello() is called.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Color</span></span><br><span class="line">    &#123;</span><br><span class="line">        RED,</span><br><span class="line">        BLUE,</span><br><span class="line">        BLACK</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// QML如果要访问的成员函数必须为public或protected且使用Q_INVOKABLE宏</span></span><br><span class="line">    <span class="function">Q_INVOKABLE <span class="type">void</span> <span class="title">show</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;show() is called.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setColor</span><span class="params">(<span class="type">const</span> Color&amp; color)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span>(color != m_color)</span><br><span class="line">    	&#123;</span><br><span class="line">        	m_color = color;</span><br><span class="line">        	<span class="function">emit <span class="title">colorChanged</span><span class="params">()</span></span>;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">doSomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Hello::dosomething() is called.&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">begin</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">colorChanged</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Color m_color;  <span class="comment">// 属性</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// HELLO_H</span></span></span><br></pre></td></tr></table></figure>

<p> ​    将c++类注册到Qt元对象系统</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册C++类型</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QGuiApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QQmlApplicationEngine&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtQml&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">QGuiApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">  <span class="comment">//注册C++类型Hello</span></span><br><span class="line">  <span class="built_in">qmlRegisterType</span>&lt;Hello&gt;(<span class="string">&quot;Hello.module&quot;</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  QQmlApplicationEngine engine;</span><br><span class="line">  engine.<span class="built_in">load</span>(<span class="built_in">QUrl</span>(<span class="built_in">QStringLiteral</span>(<span class="string">&quot;qrc:/main.qml&quot;</span>)));</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> app.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ​    在QML文件中导入注册的c+类：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> QtQuick <span class="number">2.5</span></span><br><span class="line"><span class="keyword">import</span> QtQuick.Window <span class="number">2.2</span></span><br><span class="line"><span class="comment">//导入注册的C++类</span></span><br><span class="line"><span class="keyword">import</span> Hello.<span class="keyword">module</span> <span class="number">1.0</span></span><br><span class="line"> </span><br><span class="line">Window &#123;</span><br><span class="line">    visible: <span class="literal">true</span></span><br><span class="line">    width: <span class="number">640</span></span><br><span class="line">    height: <span class="number">480</span></span><br><span class="line">    title: <span class="built_in">qsTr</span>(<span class="string">&quot;Hello QML&quot;</span>)</span><br><span class="line">    MouseArea &#123;</span><br><span class="line">        anchors.fill: parent</span><br><span class="line">        onClicked: &#123;</span><br><span class="line">            hello.<span class="built_in">begin</span>() <span class="comment">//单击鼠标调用begin信号函数</span></span><br><span class="line">            hello.<span class="built_in">show</span>()</span><br><span class="line">            hello.color = <span class="number">2</span> <span class="comment">// 修改属性</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Hello&#123;</span><br><span class="line">        id:hello   <span class="comment">//Hello类的实例</span></span><br><span class="line">        onBegin:<span class="built_in">doSomething</span>()</span><br><span class="line">        onColorChanged:console.<span class="built_in">log</span>(<span class="string">&quot;color changed.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在c++中实例化并设置QML上下文属性，在QML中直接使用</p>
<p> ​    先实例化在注册为QML上下文属性</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QGuiApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QQuickView&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QQmlContext&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">QGuiApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">  </span><br><span class="line">  QQuickView view;</span><br><span class="line">  Hello hello;</span><br><span class="line">  view.<span class="built_in">rootContext</span>()-&gt;<span class="built_in">setContextProperty</span>(<span class="string">&quot;hello&quot;</span>, &amp;hello);</span><br><span class="line">  view.<span class="built_in">setSource</span>(<span class="built_in">QUrl</span>(<span class="built_in">QStringLiteral</span>(<span class="string">&quot;qrc:///main.qml&quot;</span>)));</span><br><span class="line">  view.<span class="built_in">show</span>();</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> app.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ​    在main.qml中不能使用Hello来实例化，也不能调用doSomething()槽函数，因为doSomething()中的枚举类型是访问不到的，通过设置的QML上下文属性“hello”类访问c++，此时信号处理函数需要用Connections来处理</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> QtQuick <span class="number">2.5</span></span><br><span class="line"> </span><br><span class="line">Item &#123;</span><br><span class="line">    width: <span class="number">640</span></span><br><span class="line">    height: <span class="number">480</span></span><br><span class="line">    MouseArea &#123;</span><br><span class="line">        anchors.fill: parent</span><br><span class="line">        onClicked: &#123;</span><br><span class="line">            hello.<span class="built_in">begin</span>()<span class="comment">//单击鼠标调用begin信号函数</span></span><br><span class="line">            hello.<span class="built_in">show</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Connections&#123;</span><br><span class="line">       target:hello</span><br><span class="line">       onBegin:console.<span class="built_in">log</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>​     在c++中加载QML文件可以用QQMLComponent或QQucikView，然后就可以在c++中访问QML对象，QQuickView提供了一个显示用户界面的窗口，而QQMLComponent没有。</p>
<p>​    c++想要被QML访问，必须满足两个条件：</p>
<ol>
<li>派生自QObject类或为QObject类的子类</li>
<li>使用Q_OBJECT宏</li>
</ol>
<h3 id="Qt容器类"><a href="#Qt容器类" class="headerlink" title="Qt容器类"></a>Qt容器类</h3><p>​    Qt容器类分为顺序式容器与关联式容器:</p>
<p>顺序式容器：</p>
<ul>
<li>QList：最常用的容器类，在前后添加元素很快，可以以下标的方式对数据项进行访问。</li>
<li>QLinkedList：链式列表，数据项不使用连续的内存存储的，基于迭代器访问</li>
<li>QVector：动态数组，以下标索引访问数据</li>
<li>QStack：类似堆栈后入先出操作的容器</li>
<li>QQueue：类似队列先入先出操作的容器</li>
</ul>
<p>关联式容器：</p>
<ul>
<li>QMap：提供一个字典（关联数组），一个键映射一个值，存储顺序为键的顺序</li>
<li>QMultiMap：QMap的子类，允许处理多值映射的便利类，不支持’[]‘操作符</li>
<li>QHash：基于散列表实现的字典功能的模板类</li>
<li>QMultiHash：QHash的子类，用于处理多值映射的便利类，用法与QMultiMap类似</li>
<li>QSet：基于散列表的集合模板类，存储顺序不定，查找速度很快，内部是基于QHash实现的</li>
</ul>
<p>​    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/25/BiFPN%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/25/BiFPN%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">BiFPN代码详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-25 15:01:21" itemprop="dateCreated datePublished" datetime="2023-04-25T15:01:21+08:00">2023-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-05-06 14:51:26" itemprop="dateModified" datetime="2023-05-06T14:51:26+08:00">2023-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">深度学习</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="AdelaiDet中的BiFPN代码详解-更新中"><a href="#AdelaiDet中的BiFPN代码详解-更新中" class="headerlink" title="AdelaiDet中的BiFPN代码详解(更新中)"></a>AdelaiDet中的BiFPN代码详解(更新中)</h1><p>AdelaiDet中的bifpn模块代码位于adet&#x2F;modeling&#x2F;backbone&#x2F;bifpn.py中，主要的为三个部分：</p>
<ul>
<li>BiFPN模块</li>
<li>构建backbone网络结构的BackboneWithTopLevels模块</li>
<li>单层的FPN结构SignleBiFPN模块</li>
</ul>
<p>​    <strong>通过注册为框架可使用的backbone：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在yaml中使用 </span></span><br><span class="line"><span class="comment">#MODEL:</span></span><br><span class="line"><span class="comment">#  BACKBONE:</span></span><br><span class="line"><span class="comment">#    NAME: &quot;build_fcos_resnet_bifpn_backbone&quot;</span></span><br><span class="line"><span class="meta">@BACKBONE_REGISTRY.register()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_fcos_resnet_bifpn_backbone</span>(<span class="params">cfg, input_shape: ShapeSpec</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        cfg: a detectron2 CfgNode</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        backbone (Backbone): backbone module, must be a subclass of :class:`Backbone`.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> cfg.MODEL.MOBILENET:</span><br><span class="line">        bottom_up = build_mnv2_backbone(cfg, input_shape)</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># resnet</span></span><br><span class="line">        bottom_up = build_resnet_backbone(cfg, input_shape)</span><br><span class="line">    in_features = cfg.MODEL.BiFPN.IN_FEATURES</span><br><span class="line">    out_channels = cfg.MODEL.BiFPN.OUT_CHANNELS</span><br><span class="line">    num_repeats = cfg.MODEL.BiFPN.NUM_REPEATS</span><br><span class="line">    top_levels = cfg.MODEL.FCOS.TOP_LEVELS</span><br><span class="line">    <span class="comment"># 下面的注释为我自己训练的参数，参数具体解释间后面的BiFPN模块</span></span><br><span class="line">    backbone = BiFPN(</span><br><span class="line">        bottom_up=bottom_up,  </span><br><span class="line">        in_features=in_features,    <span class="comment"># [res3,res4,res5]/[res2,res3,res4,res5]</span></span><br><span class="line">        out_channels=out_channels,  <span class="comment"># 256</span></span><br><span class="line">        num_top_levels=top_levels,  <span class="comment"># 2/1</span></span><br><span class="line">        num_repeats=num_repeats,    <span class="comment"># 6</span></span><br><span class="line">        norm=cfg.MODEL.BiFPN.NORM   <span class="comment"># 为空</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> backbone</span><br></pre></td></tr></table></figure>

<p>​    <strong>下面的内容除非有 ‘&#x2F;‘ 分开表示的，其他默认为 in_features&#x3D;[res2,res3,res4,res5]的情况！！！</strong></p>
<h2 id="BiFPN模块"><a href="#BiFPN模块" class="headerlink" title="BiFPN模块"></a>BiFPN模块</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分割字母和后面的数字，比如将&#x27;res3&#x27;分为&#x27;res&#x27;与&#x27;3&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_name</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(name):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> c.isalpha():</span><br><span class="line">            <span class="keyword">return</span> name[:i], <span class="built_in">int</span>(name[i:])</span><br><span class="line">    <span class="keyword">raise</span> ValueError()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BiFPN</span>(<span class="title class_ inherited__">Backbone</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This module implements Feature Pyramid Network.</span></span><br><span class="line"><span class="string">    It creates pyramid features built on top of some input feature maps.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, bottom_up, in_features, out_channels, num_top_levels, num_repeats, norm=<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            bottom_up (Backbone): module representing the bottom up subnetwork.</span></span><br><span class="line"><span class="string">                Must be a subclass of :class:`Backbone`. The multi-scale feature</span></span><br><span class="line"><span class="string">                maps generated by the bottom up network, and listed in `in_features`,</span></span><br><span class="line"><span class="string">                are used to generate FPN levels.</span></span><br><span class="line"><span class="string">            in_features (list[str]): names of the input feature maps coming</span></span><br><span class="line"><span class="string">                from the backbone to which FPN is attached. For example, if the</span></span><br><span class="line"><span class="string">                backbone produces [&quot;res2&quot;, &quot;res3&quot;, &quot;res4&quot;], any *contiguous* sublist</span></span><br><span class="line"><span class="string">                of these may be used; order must be from high to low resolution.</span></span><br><span class="line"><span class="string">            out_channels (int): number of channels in the output feature maps.</span></span><br><span class="line"><span class="string">            num_top_levels (int): the number of the top levels (p6 or p7).</span></span><br><span class="line"><span class="string">            num_repeats (int): the number of repeats of BiFPN.</span></span><br><span class="line"><span class="string">            norm (str): the normalization to use.</span></span><br><span class="line"><span class="string">            ---------------------------------------</span></span><br><span class="line"><span class="string">            bottom_up (Backbone): 必须是Backbone的子类，多尺度特侦图列在in_features中，用于生成FPN levels</span></span><br><span class="line"><span class="string">            in_features (list[str]): 输入特征图的名称，顺序必须为高分辨率到低分辨率，例如如果骨干网路输出到BiFPN的为[res2,res3,res4]，则可使用其中任意连续的子序列</span></span><br><span class="line"><span class="string">            out_channels (int): 输出特征图的channels</span></span><br><span class="line"><span class="string">            num_top_levels (int): 顶层的数量（p6或p7）1时为p6，2时为p7</span></span><br><span class="line"><span class="string">            num_repeats (int): BiFPN的重复次数</span></span><br><span class="line"><span class="string">            norm (str): the normalization to use.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>(BiFPN, self).__init__()</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">isinstance</span>(bottom_up, Backbone)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建backbone网络结构，要注意self.bottom_up与bottom_up区别</span></span><br><span class="line">        <span class="comment"># add extra feature levels (i.e., 6 and 7)</span></span><br><span class="line">        self.bottom_up = BackboneWithTopLevels(</span><br><span class="line">            bottom_up, out_channels,</span><br><span class="line">            num_top_levels, norm</span><br><span class="line">        )</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        BackboneWithTopLevels处理后的bottom_up：</span></span><br><span class="line"><span class="string">        &#123;   [res3,res4,res5] 2</span></span><br><span class="line"><span class="string">            &#x27;res3&#x27;: ShapeSpec(channels=512, height=None, width=None, stride=8),  </span></span><br><span class="line"><span class="string">            &#x27;res4&#x27;: ShapeSpec(channels=1024, height=None, width=None, stride=16), </span></span><br><span class="line"><span class="string">            &#x27;res5&#x27;: ShapeSpec(channels=2048, height=None, width=None, stride=32), </span></span><br><span class="line"><span class="string">            &#x27;res6&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=64), </span></span><br><span class="line"><span class="string">            &#x27;res7&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=128)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &#123;   [res2,res3,res4,res5] 1</span></span><br><span class="line"><span class="string">            &#x27;res2&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=4), </span></span><br><span class="line"><span class="string">            &#x27;res3&#x27;: ShapeSpec(channels=512, height=None, width=None, stride=8), </span></span><br><span class="line"><span class="string">            &#x27;res4&#x27;: ShapeSpec(channels=1024, height=None, width=None, stride=16), </span></span><br><span class="line"><span class="string">            &#x27;res5&#x27;: ShapeSpec(channels=2048, height=None, width=None, stride=32), </span></span><br><span class="line"><span class="string">            &#x27;res6&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=64)&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        bottom_up_output_shapes = self.bottom_up.output_shape()</span><br><span class="line"></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># in_features [res3, res4, res5, res6, res7]/[&#x27;res2&#x27;, &#x27;res3&#x27;, &#x27;res4&#x27;, &#x27;res5&#x27;, &#x27;res6&#x27;]</span></span><br><span class="line">        in_features = <span class="built_in">sorted</span>(in_features, key=<span class="keyword">lambda</span> x: split_name(x)[<span class="number">1</span>])</span><br><span class="line">        self._size_divisibility = bottom_up_output_shapes[in_features[-<span class="number">1</span>]].stride  <span class="comment"># 最后一个in_features（res6/res5）的stride</span></span><br><span class="line">        self.out_channels = out_channels</span><br><span class="line">        self.min_level = split_name(in_features[<span class="number">0</span>])[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add the names for top blocks</span></span><br><span class="line">        prefix, last_suffix = split_name(in_features[-<span class="number">1</span>])  <span class="comment"># split_name分割为字母与数字</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_top_levels):</span><br><span class="line">            in_features.append(prefix + <span class="built_in">str</span>(last_suffix + i + <span class="number">1</span>))</span><br><span class="line">        self.in_features = in_features</span><br><span class="line"></span><br><span class="line">        <span class="comment"># generate output features</span></span><br><span class="line">        self._out_features = [<span class="string">&quot;p&#123;&#125;&quot;</span>.<span class="built_in">format</span>(split_name(name)[<span class="number">1</span>]) <span class="keyword">for</span> name <span class="keyword">in</span> in_features]  <span class="comment">#[&#x27;p2&#x27;,&#x27;p3&#x27;,&#x27;p4&#x27;,&#x27;p5&#x27;,&#x27;p6&#x27;]</span></span><br><span class="line">        <span class="comment"># 和输入特征的步长对应&#123;&#x27;p2&#x27;: 4, &#x27;p3&#x27;: 8, &#x27;p4&#x27;: 16, &#x27;p5&#x27;: 32, &#x27;p6&#x27;: 64&#125;</span></span><br><span class="line">        self._out_feature_strides = &#123;</span><br><span class="line">            out_name: bottom_up_output_shapes[in_name].stride</span><br><span class="line">            <span class="keyword">for</span> out_name, in_name <span class="keyword">in</span> <span class="built_in">zip</span>(self._out_features, in_features)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 都为输出的channels&#123;&#x27;p2&#x27;: 256, &#x27;p3&#x27;: 256, &#x27;p4&#x27;: 256, &#x27;p5&#x27;: 256, &#x27;p6&#x27;: 256&#125;</span></span><br><span class="line">        self._out_feature_channels = &#123;k: out_channels <span class="keyword">for</span> k <span class="keyword">in</span> self._out_features&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># build bifpn</span></span><br><span class="line">        <span class="comment"># 构建多级的FPN结构，其中SingleBiFPM实现了单层的FPN结构</span></span><br><span class="line">        self.repeated_bifpn = nn.ModuleList()</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            i = 0时   in_channels_list = [256, 512, 1024, 2048, 256]</span></span><br><span class="line"><span class="string">            i = 其他时 in_channels_list = [256, 256, 256, 256, 256]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_repeats):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                in_channels_list = [</span><br><span class="line">                    bottom_up_output_shapes[name].channels <span class="keyword">for</span> name <span class="keyword">in</span> in_features</span><br><span class="line">                ]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                in_channels_list = [</span><br><span class="line">                    self._out_feature_channels[name] <span class="keyword">for</span> name <span class="keyword">in</span> self._out_features</span><br><span class="line">                ]</span><br><span class="line">            self.repeated_bifpn.append(SingleBiFPN(</span><br><span class="line">                in_channels_list, out_channels, norm</span><br><span class="line">            ))</span><br><span class="line">            <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size_divisibility</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._size_divisibility</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            input (dict[str-&gt;Tensor]): mapping feature map name (e.g., &quot;p5&quot;) to</span></span><br><span class="line"><span class="string">                feature map tensor for each feature level in high to low resolution order.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            dict[str-&gt;Tensor]:</span></span><br><span class="line"><span class="string">                mapping from feature map name to FPN feature map tensor</span></span><br><span class="line"><span class="string">                in high to low resolution order. Returned feature names follow the FPN</span></span><br><span class="line"><span class="string">                paper convention: &quot;p&lt;stage&gt;&quot;, where stage has stride = 2 ** stage e.g.,</span></span><br><span class="line"><span class="string">                [&quot;n2&quot;, &quot;n3&quot;, ..., &quot;n6&quot;].</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        bottom_up_features = self.bottom_up(x)  <span class="comment"># resnet</span></span><br><span class="line">        feats = [bottom_up_features[f] <span class="keyword">for</span> f <span class="keyword">in</span> self.in_features]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 这里体现联级，将第一层的FPN输出到feats，再次送入第二层FPN</span></span><br><span class="line">        <span class="keyword">for</span> bifpn <span class="keyword">in</span> self.repeated_bifpn:</span><br><span class="line">            <span class="comment">#pdb.set_trace()</span></span><br><span class="line">            feats = bifpn(feats)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(<span class="built_in">zip</span>(self._out_features, feats))</span><br></pre></td></tr></table></figure>



<h2 id="BackboneWithTopLevels"><a href="#BackboneWithTopLevels" class="headerlink" title="BackboneWithTopLevels"></a>BackboneWithTopLevels</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BackboneWithTopLevels</span>(<span class="title class_ inherited__">Backbone</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, backbone, out_channels, num_top_levels, norm=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(BackboneWithTopLevels, self).__init__()</span><br><span class="line">        <span class="comment"># 下面的参数很好理解，都是backbone中的一些参数</span></span><br><span class="line">        self.backbone = backbone</span><br><span class="line">        backbone_output_shape = backbone.output_shape()</span><br><span class="line"></span><br><span class="line">        self._out_feature_channels = &#123;name: shape.channels <span class="keyword">for</span> name, shape <span class="keyword">in</span> backbone_output_shape.items()&#125;</span><br><span class="line">        self._out_feature_strides = &#123;name: shape.stride <span class="keyword">for</span> name, shape <span class="keyword">in</span> backbone_output_shape.items()&#125;</span><br><span class="line">        self._out_features = <span class="built_in">list</span>(self._out_feature_strides.keys())</span><br><span class="line"></span><br><span class="line">        last_feature_name = <span class="built_in">max</span>(self._out_feature_strides.keys(), key=<span class="keyword">lambda</span> x: split_name(x)[<span class="number">1</span>])</span><br><span class="line">        self.last_feature_name = last_feature_name</span><br><span class="line">        self.num_top_levels = num_top_levels</span><br><span class="line"></span><br><span class="line">        last_channels = self._out_feature_channels[last_feature_name]</span><br><span class="line">        last_stride = self._out_feature_strides[last_feature_name]</span><br><span class="line"></span><br><span class="line">        prefix, suffix = split_name(last_feature_name)</span><br><span class="line">        prev_channels = last_channels</span><br><span class="line"></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_top_levels):</span><br><span class="line">            name = prefix + <span class="built_in">str</span>(suffix + i + <span class="number">1</span>)</span><br><span class="line">            self.add_module(name, FeatureMapResampler(</span><br><span class="line">                prev_channels, out_channels, <span class="number">2</span>, norm</span><br><span class="line">            ))</span><br><span class="line">            prev_channels = out_channels</span><br><span class="line"></span><br><span class="line">            self._out_feature_channels[name] = out_channels</span><br><span class="line">            self._out_feature_strides[name] = last_stride * <span class="number">2</span> ** (i + <span class="number">1</span>)</span><br><span class="line">            self._out_features.append(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        outputs = self.backbone(x)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            outputs[&#x27;res2&#x27;].shape = [8, 256, 40, 32]</span></span><br><span class="line"><span class="string">            outputs[&#x27;res3&#x27;].shape = [8, 512, 20, 16]</span></span><br><span class="line"><span class="string">            outputs[&#x27;res4&#x27;].shape = [8, 1024, 10, 8]</span></span><br><span class="line"><span class="string">            outputs[&#x27;res5&#x27;].shape = [8, 2048, 5, 4]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        last_features = outputs[self.last_feature_name]</span><br><span class="line">        prefix, suffix = split_name(self.last_feature_name)</span><br><span class="line"></span><br><span class="line">        x = last_features</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_top_levels):</span><br><span class="line">            name = prefix + <span class="built_in">str</span>(suffix + i + <span class="number">1</span>)</span><br><span class="line">            x = self.__getattr__(name)(x)</span><br><span class="line">            outputs[name] = x</span><br><span class="line">        <span class="string">&quot;&quot;&quot;  通过上面outputs新增了一个outputs[&#x27;res6&#x27;] shape=[8, 256, 3, 2];  &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>

<h2 id="SingleBiFPN"><a href="#SingleBiFPN" class="headerlink" title="SingleBiFPN"></a>SingleBiFPN</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/24/BlendMask%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/24/BlendMask%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">BlendMask代码详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-04-24 16:25:24 / 修改时间：21:24:05" itemprop="dateCreated datePublished" datetime="2023-04-24T16:25:24+08:00">2023-04-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">深度学习</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="BlendMask代码详解"><a href="#BlendMask代码详解" class="headerlink" title="BlendMask代码详解"></a>BlendMask代码详解</h1><p>​    以下代码出自官方AdelaiDet，添加了注释方便阅读理解，BlendMask代码主要包含以下三个文件：</p>
<ul>
<li>blendmask.py</li>
<li>blender.py</li>
<li>basis_module.py</li>
</ul>
<h2 id="AdelaiDet-x2F-adet-x2F-modeling-x2F-blendmask-x2F-blendmask-py"><a href="#AdelaiDet-x2F-adet-x2F-modeling-x2F-blendmask-x2F-blendmask-py" class="headerlink" title="AdelaiDet&#x2F;adet&#x2F;modeling&#x2F;blendmask&#x2F;blendmask.py"></a>AdelaiDet&#x2F;adet&#x2F;modeling&#x2F;blendmask&#x2F;blendmask.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># Copyright (c) Facebook, Inc. and its affiliates. All Rights Reserved</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> detectron2.structures <span class="keyword">import</span> ImageList</span><br><span class="line"><span class="keyword">from</span> detectron2.modeling.postprocessing <span class="keyword">import</span> detector_postprocess, sem_seg_postprocess</span><br><span class="line"><span class="keyword">from</span> detectron2.modeling.proposal_generator <span class="keyword">import</span> build_proposal_generator</span><br><span class="line"><span class="keyword">from</span> detectron2.modeling.backbone <span class="keyword">import</span> build_backbone</span><br><span class="line"><span class="keyword">from</span> detectron2.modeling.meta_arch.panoptic_fpn <span class="keyword">import</span> combine_semantic_and_instance_outputs</span><br><span class="line"><span class="keyword">from</span> detectron2.modeling.meta_arch.build <span class="keyword">import</span> META_ARCH_REGISTRY</span><br><span class="line"><span class="keyword">from</span> detectron2.modeling.meta_arch.semantic_seg <span class="keyword">import</span> build_sem_seg_head</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .blender <span class="keyword">import</span> build_blender</span><br><span class="line"><span class="keyword">from</span> .basis_module <span class="keyword">import</span> build_basis_module</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">&quot;BlendMask&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试用</span></span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@META_ARCH_REGISTRY.register()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlendMask</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Main class for BlendMask architectures (see https://arxiv.org/abd/1901.02446).</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.device = torch.device(cfg.MODEL.DEVICE)</span><br><span class="line">        self.instance_loss_weight = cfg.MODEL.BLENDMASK.INSTANCE_LOSS_WEIGHT</span><br><span class="line"></span><br><span class="line">        self.backbone = build_backbone(cfg)  <span class="comment"># 骨干网络</span></span><br><span class="line">        self.proposal_generator = build_proposal_generator(cfg, self.backbone.output_shape())</span><br><span class="line">        self.blender = build_blender(cfg)</span><br><span class="line">        self.basis_module = build_basis_module(cfg, self.backbone.output_shape())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># options when combining instance &amp; semantic outputs</span></span><br><span class="line">        self.combine_on = cfg.MODEL.PANOPTIC_FPN.COMBINE.ENABLED</span><br><span class="line">        <span class="keyword">if</span> self.combine_on:</span><br><span class="line">            self.panoptic_module = build_sem_seg_head(cfg, self.backbone.output_shape())</span><br><span class="line">            self.combine_overlap_threshold = cfg.MODEL.PANOPTIC_FPN.COMBINE.OVERLAP_THRESH</span><br><span class="line">            self.combine_stuff_area_limit = cfg.MODEL.PANOPTIC_FPN.COMBINE.STUFF_AREA_LIMIT</span><br><span class="line">            self.combine_instances_confidence_threshold = (</span><br><span class="line">                cfg.MODEL.PANOPTIC_FPN.COMBINE.INSTANCES_CONFIDENCE_THRESH)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># build top module</span></span><br><span class="line">        <span class="comment"># 下面的内容在你训练输出的文件夹中的log.txt都能查到</span></span><br><span class="line">        in_channels = cfg.MODEL.FPN.OUT_CHANNELS  <span class="comment"># FPN为256</span></span><br><span class="line">        num_bases = cfg.MODEL.BASIS_MODULE.NUM_BASES  <span class="comment"># 26</span></span><br><span class="line">        attn_size = cfg.MODEL.BLENDMASK.ATTN_SIZE  <span class="comment"># 14</span></span><br><span class="line">        attn_len = num_bases * attn_size * attn_size  <span class="comment"># K*M*M</span></span><br><span class="line">        self.top_layer = nn.Conv2d(</span><br><span class="line">            in_channels, attn_len,</span><br><span class="line">            kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        torch.nn.init.normal_(self.top_layer.weight, std=<span class="number">0.01</span>)</span><br><span class="line">        torch.nn.init.constant_(self.top_layer.bias, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        pixel_mean = torch.Tensor(cfg.MODEL.PIXEL_MEAN).to(self.device).view(<span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        pixel_std = torch.Tensor(cfg.MODEL.PIXEL_STD).to(self.device).view(<span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        self.normalizer = <span class="keyword">lambda</span> x: (x - pixel_mean) / pixel_std</span><br><span class="line">        self.to(self.device)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, batched_inputs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            batched_inputs: a list, batched outputs of :class:`DatasetMapper`.</span></span><br><span class="line"><span class="string">                Each item in the list contains the inputs for one image.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        For now, each item in the list is a dict that contains:</span></span><br><span class="line"><span class="string">            image: Tensor, image in (C, H, W) format.</span></span><br><span class="line"><span class="string">            instances: Instances</span></span><br><span class="line"><span class="string">            sem_seg: semantic segmentation ground truth.</span></span><br><span class="line"><span class="string">            Other information that&#x27;s included in the original dicts, such as:</span></span><br><span class="line"><span class="string">                &quot;height&quot;, &quot;width&quot; (int): the output resolution of the model, used in inference.</span></span><br><span class="line"><span class="string">                    See :meth:`postprocess` for details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            list[dict]: each dict is the results for one image. The dict</span></span><br><span class="line"><span class="string">                contains the following keys:</span></span><br><span class="line"><span class="string">                &quot;instances&quot;: see :meth:`GeneralizedRCNN.forward` for its format.</span></span><br><span class="line"><span class="string">                &quot;sem_seg&quot;: see :meth:`SemanticSegmentor.forward` for its format.</span></span><br><span class="line"><span class="string">                &quot;panoptic_seg&quot;: available when `PANOPTIC_FPN.COMBINE.ENABLED`.</span></span><br><span class="line"><span class="string">                    See the return value of</span></span><br><span class="line"><span class="string">                    :func:`combine_semantic_and_instance_outputs` for its format.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        images = [x[<span class="string">&quot;image&quot;</span>].to(self.device) <span class="keyword">for</span> x <span class="keyword">in</span> batched_inputs]</span><br><span class="line">        images = [self.normalizer(x) <span class="keyword">for</span> x <span class="keyword">in</span> images]  <span class="comment"># 正则化</span></span><br><span class="line">        images = ImageList.from_tensors(images, self.backbone.size_divisibility)</span><br><span class="line">        features = self.backbone(images.tensor)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        (Pbd) features.keys()</span></span><br><span class="line"><span class="string">        dict_keys([&#x27;p3&#x27;, &#x27;p4&#x27;, &#x27;p5&#x27;, &#x27;p6&#x27;, &#x27;p7&#x27;])</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.combine_on:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;sem_seg&quot;</span> <span class="keyword">in</span> batched_inputs[<span class="number">0</span>]:</span><br><span class="line">                gt_sem = [x[<span class="string">&quot;sem_seg&quot;</span>].to(self.device) <span class="keyword">for</span> x <span class="keyword">in</span> batched_inputs]</span><br><span class="line">                gt_sem = ImageList.from_tensors(</span><br><span class="line">                    gt_sem, self.backbone.size_divisibility, self.panoptic_module.ignore_value</span><br><span class="line">                ).tensor</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                gt_sem = <span class="literal">None</span></span><br><span class="line">            sem_seg_results, sem_seg_losses = self.panoptic_module(features, gt_sem)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;basis_sem&quot;</span> <span class="keyword">in</span> batched_inputs[<span class="number">0</span>]:</span><br><span class="line">            basis_sem = [x[<span class="string">&quot;basis_sem&quot;</span>].to(self.device) <span class="keyword">for</span> x <span class="keyword">in</span> batched_inputs]</span><br><span class="line">            basis_sem = ImageList.from_tensors(</span><br><span class="line">                basis_sem, self.backbone.size_divisibility, <span class="number">0</span>).tensor</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            basis_sem = <span class="literal">None</span></span><br><span class="line">        basis_out, basis_losses = self.basis_module(features, basis_sem)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        (Pdb) basis_losses</span></span><br><span class="line"><span class="string">        &#123;&#x27;loss_basis_sem&#x27;: tensor(1.3870, device=&#x27;cuda:0&#x27;, grad_fn=&lt;MulBackward0&gt;)&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;instances&quot;</span> <span class="keyword">in</span> batched_inputs[<span class="number">0</span>]:</span><br><span class="line">            gt_instances = [x[<span class="string">&quot;instances&quot;</span>].to(self.device) <span class="keyword">for</span> x <span class="keyword">in</span> batched_inputs]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt_instances = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 对应fcos_outputs.py 的444行 self.top_layer不参与fcos原本的分支以及loss计算，只是多加了一个维度的变换。 256 --&gt; 784</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        (Pdb) proposal_losses</span></span><br><span class="line"><span class="string">        &#123;&#x27;loss_fcos_cls&#x27;: tensor(1.2077, device=&#x27;cuda:0&#x27;, grad_fn=&lt;MulBackward0&gt;), </span></span><br><span class="line"><span class="string">         &#x27;loss_fcos_loc&#x27;: tensor(0.9512, device=&#x27;cuda:0&#x27;, grad_fn=&lt;DivBackward0&gt;), </span></span><br><span class="line"><span class="string">         &#x27;loss_fcos_ctr&#x27;: tensor(0.7081, device=&#x27;cuda:0&#x27;, grad_fn=&lt;DivBackward0&gt;)&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        proposals, proposal_losses = self.proposal_generator(</span><br><span class="line">            images, features, gt_instances, self.top_layer)</span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        (Pdb) detector_losses</span></span><br><span class="line"><span class="string">        &#123;&#x27;loss_mask&#x27;: tensor(0.6993, device=&#x27;cuda:0&#x27;, grad_fn=&lt;DivBackward0&gt;)&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        detector_results, detector_losses = self.blender(  <span class="comment"># 调用了__call__方法</span></span><br><span class="line">            basis_out[<span class="string">&quot;bases&quot;</span>], proposals, gt_instances)</span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.training:</span><br><span class="line">            losses = &#123;&#125;</span><br><span class="line">            losses.update(basis_losses)</span><br><span class="line">            losses.update(&#123;k: v * self.instance_loss_weight <span class="keyword">for</span> k, v <span class="keyword">in</span> detector_losses.items()&#125;)</span><br><span class="line">            losses.update(proposal_losses)</span><br><span class="line">            <span class="keyword">if</span> self.combine_on:</span><br><span class="line">                losses.update(sem_seg_losses)</span><br><span class="line">            <span class="keyword">return</span> losses</span><br><span class="line"></span><br><span class="line">        processed_results = []</span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line">        <span class="keyword">for</span> i, (detector_result, input_per_image, image_size) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(</span><br><span class="line">                detector_results, batched_inputs, images.image_sizes)):</span><br><span class="line">            height = input_per_image.get(<span class="string">&quot;height&quot;</span>, image_size[<span class="number">0</span>])</span><br><span class="line">            width = input_per_image.get(<span class="string">&quot;width&quot;</span>, image_size[<span class="number">1</span>])</span><br><span class="line">            detector_r = detector_postprocess(detector_result, height, width)</span><br><span class="line">            processed_result = &#123;<span class="string">&quot;instances&quot;</span>: detector_r&#125;</span><br><span class="line">            <span class="keyword">if</span> self.combine_on:</span><br><span class="line">                sem_seg_r = sem_seg_postprocess(</span><br><span class="line">                    sem_seg_results[i], image_size, height, width)</span><br><span class="line">                processed_result[<span class="string">&quot;sem_seg&quot;</span>] = sem_seg_r</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;seg_thing_out&quot;</span> <span class="keyword">in</span> basis_out:</span><br><span class="line">                seg_thing_r = sem_seg_postprocess(</span><br><span class="line">                    basis_out[<span class="string">&quot;seg_thing_out&quot;</span>], image_size, height, width)</span><br><span class="line">                processed_result[<span class="string">&quot;sem_thing_seg&quot;</span>] = seg_thing_r</span><br><span class="line">            <span class="keyword">if</span> self.basis_module.visualize:</span><br><span class="line">                processed_result[<span class="string">&quot;bases&quot;</span>] = basis_out[<span class="string">&quot;bases&quot;</span>]</span><br><span class="line">            processed_results.append(processed_result)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.combine_on:</span><br><span class="line">                panoptic_r = combine_semantic_and_instance_outputs(</span><br><span class="line">                    detector_r,</span><br><span class="line">                    sem_seg_r.argmax(dim=<span class="number">0</span>),</span><br><span class="line">                    self.combine_overlap_threshold,</span><br><span class="line">                    self.combine_stuff_area_limit,</span><br><span class="line">                    self.combine_instances_confidence_threshold)</span><br><span class="line">                processed_results[-<span class="number">1</span>][<span class="string">&quot;panoptic_seg&quot;</span>] = panoptic_r</span><br><span class="line">            <span class="comment">#pdb.set_trace()</span></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line">        <span class="keyword">return</span> processed_results</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">(Pdb) batched_inputs[0]</span></span><br><span class="line"><span class="string">&#123;&#x27;file_name&#x27;: &#x27;/mnt/big_disk/big_disk_1/zhuzhibo/download/AdelaiDet/datasets/handwritten_chinese_stroke_2021/train2021/HandwrittenChineseStroke_train_0000028734.jpg&#x27;, &#x27;height&#x27;: 77, &#x27;width&#x27;: 47, &#x27;image_id&#x27;: 6569, &#x27;image&#x27;: tensor(</span></span><br><span class="line"><span class="string">       [[[252, 253, 254,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [252, 253, 254,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [252, 253, 255,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         ...,</span></span><br><span class="line"><span class="string">         [255, 235, 199,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [255, 247, 234,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [255, 254, 253,  ..., 255, 255, 255]],</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        [[252, 253, 254,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [252, 253, 254,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [252, 253, 255,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         ...,</span></span><br><span class="line"><span class="string">         [255, 235, 199,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [255, 247, 234,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [255, 254, 253,  ..., 255, 255, 255]],</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        [[252, 253, 254,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [252, 253, 254,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [252, 253, 255,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         ...,</span></span><br><span class="line"><span class="string">         [255, 235, 199,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [255, 247, 234,  ..., 255, 255, 255],</span></span><br><span class="line"><span class="string">         [255, 254, 253,  ..., 255, 255, 255]]], dtype=torch.uint8), &#x27;instances&#x27;: Instances(num_instances=9, image_height=144, image_width=88, fields=[gt_boxes: Boxes(tensor(</span></span><br><span class="line"><span class="string">       [[ 41.0402,   0.0000,  88.0000,  52.9219],</span></span><br><span class="line"><span class="string">        [ 48.8080,  26.3713,  75.8560,  82.4046],</span></span><br><span class="line"><span class="string">        [ 36.6902,  28.8540,  57.2133,  70.4563],</span></span><br><span class="line"><span class="string">        [  0.0000,   5.1126,  44.1634,  66.7322],</span></span><br><span class="line"><span class="string">        [ 15.7172,  20.0092,  34.6867,  64.0943],</span></span><br><span class="line"><span class="string">        [ 56.4204,  80.8368,  76.4774, 127.8701],</span></span><br><span class="line"><span class="string">        [  8.2601,  61.4402,  59.2329, 126.1632],</span></span><br><span class="line"><span class="string">        [ 29.2331,  80.9919,  52.5526, 129.2667],</span></span><br><span class="line"><span class="string">        [  0.0000, 105.6644,  39.9688, 144.0000]])), gt_classes: tensor([ 3, 23, 17, 14,  3, 18,  8,  3, 17]), gt_masks: PolygonMasks(num_instances=9)]), &#x27;basis_sem&#x27;: tensor(</span></span><br><span class="line"><span class="string">       [[ 0,  0,  0,  ...,  0,  0,  0],</span></span><br><span class="line"><span class="string">        [ 0,  0,  0,  ...,  0,  0,  0],</span></span><br><span class="line"><span class="string">        [ 0,  0,  0,  ...,  0,  0,  0],</span></span><br><span class="line"><span class="string">        ...,</span></span><br><span class="line"><span class="string">        [ 0,  0, 18,  ...,  0,  0,  0],</span></span><br><span class="line"><span class="string">        [ 0,  0, 18,  ...,  0,  0,  0],</span></span><br><span class="line"><span class="string">        [ 0,  0, 18,  ...,  0,  0,  0]])&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="AdelaiDet-x2F-adet-x2F-modeling-x2F-blendmask-x2F-blender-py"><a href="#AdelaiDet-x2F-adet-x2F-modeling-x2F-blendmask-x2F-blender-py" class="headerlink" title="AdelaiDet&#x2F;adet&#x2F;modeling&#x2F;blendmask&#x2F;blender.py"></a>AdelaiDet&#x2F;adet&#x2F;modeling&#x2F;blendmask&#x2F;blender.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> detectron2.layers <span class="keyword">import</span> cat</span><br><span class="line"><span class="keyword">from</span> detectron2.modeling.poolers <span class="keyword">import</span> ROIPooler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_blender</span>(<span class="params">cfg</span>):</span><br><span class="line">    <span class="keyword">return</span> Blender(cfg)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试用</span></span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Blender</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fmt: off</span></span><br><span class="line">        <span class="comment"># 以下内容在训练输出的文件夹中的log.txt都能找到</span></span><br><span class="line">        self.pooler_resolution = cfg.MODEL.BLENDMASK.BOTTOM_RESOLUTION     <span class="comment"># 56</span></span><br><span class="line">        sampling_ratio         = cfg.MODEL.BLENDMASK.POOLER_SAMPLING_RATIO <span class="comment"># 1</span></span><br><span class="line">        pooler_type            = cfg.MODEL.BLENDMASK.POOLER_TYPE           <span class="comment"># &#x27;ROIAlignV2&#x27;</span></span><br><span class="line">        pooler_scales          = cfg.MODEL.BLENDMASK.POOLER_SCALES         <span class="comment"># (0.25,)</span></span><br><span class="line">        self.attn_size         = cfg.MODEL.BLENDMASK.ATTN_SIZE             <span class="comment"># 14</span></span><br><span class="line">        self.top_interp        = cfg.MODEL.BLENDMASK.TOP_INTERP            <span class="comment"># &#x27;bililnear&#x27;</span></span><br><span class="line">        num_bases              = cfg.MODEL.BASIS_MODULE.NUM_BASES          <span class="comment"># 4</span></span><br><span class="line">        <span class="comment"># fmt: on</span></span><br><span class="line"></span><br><span class="line">        self.attn_len = num_bases * self.attn_size * self.attn_size  <span class="comment"># 14*14*4 = 784</span></span><br><span class="line"></span><br><span class="line">        self.pooler = ROIPooler(</span><br><span class="line">            output_size=self.pooler_resolution,</span><br><span class="line">            scales=pooler_scales,</span><br><span class="line">            sampling_ratio=sampling_ratio,</span><br><span class="line">            pooler_type=pooler_type,</span><br><span class="line">            canonical_level=<span class="number">2</span>)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        (Pdb) self.pooler</span></span><br><span class="line"><span class="string">        ROIPooler(</span></span><br><span class="line"><span class="string">            (level_poolers): ModuleList(</span></span><br><span class="line"><span class="string">                (0): ROIAlign(output_size=(56, 56), spatial_scale=0.25, sampling_ratio=1, aligned=True)</span></span><br><span class="line"><span class="string">            )</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, bases, proposals, gt_instances</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        gt_instances表示batch_size上的gt实例</span></span><br><span class="line"><span class="string">        len(gt_instances) = 64 (因为我的batchsize为64)</span></span><br><span class="line"><span class="string">        gt_instances[0]就表示第0个batch上的图片的gt实例信息</span></span><br><span class="line"><span class="string">        (Pdb) gt_instances[0]</span></span><br><span class="line"><span class="string">        Instances(num_instances=5, image_height=144, image_width=112, fields=[gt_boxes: Boxes(tensor([[  0.0000,   0.0000,  38.6394,  55.8094],</span></span><br><span class="line"><span class="string">            [ 14.5582,   6.7498,  86.0460,  82.6530],</span></span><br><span class="line"><span class="string">            [ 19.5723,  46.5602, 112.0000,  69.2312],</span></span><br><span class="line"><span class="string">            [ 34.3869,  64.0956, 108.8377, 144.0000],</span></span><br><span class="line"><span class="string">            [ 23.9028,  59.5271,  84.4506, 135.4303]], device=&#x27;cuda:0&#x27;)), gt_classes: tensor([ 3, 15,  1, 14,  3], device=&#x27;cuda:0&#x27;), gt_masks: PolygonMasks(num_instances=5)])</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> gt_instances <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># training</span></span><br><span class="line">            <span class="comment"># reshape attns</span></span><br><span class="line">            dense_info = proposals[<span class="string">&quot;instances&quot;</span>]  <span class="comment"># 我这里是3473个instance</span></span><br><span class="line">            attns = dense_info.top_feats  <span class="comment"># attns.shape = [instances, 784]</span></span><br><span class="line">            pos_inds = dense_info.pos_inds  <span class="comment"># pos_inds.shape = [instances] :正样本的数量 pos_ind表示所有FPN层的像素点加起来的某些正样本的点</span></span><br><span class="line">            <span class="keyword">if</span> pos_inds.numel() == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span>, &#123;<span class="string">&quot;loss_mask&quot;</span>: <span class="built_in">sum</span>([x.<span class="built_in">sum</span>() * <span class="number">0</span> <span class="keyword">for</span> x <span class="keyword">in</span> attns]) + bases[<span class="number">0</span>].<span class="built_in">sum</span>() * <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">            gt_inds = dense_info.gt_inds  <span class="comment"># gt_inds.shape = [instances] :对应pos_inds位置上的类别</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 1.这里表示 RoIPool r_d = RoIPool(B, p_d)</span></span><br><span class="line">            rois = self.pooler(bases, [x.gt_boxes <span class="keyword">for</span> x <span class="keyword">in</span> gt_instances])</span><br><span class="line">            rois = rois[gt_inds]   <span class="comment"># rois.shape = [instances, num_bases, 56, 56],根据gt_inds上的值进行复制</span></span><br><span class="line">            pred_mask_logits = self.merge_bases(rois, attns)  <span class="comment"># pred_mask_logits.shape = [instances, 56*56]</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># gen targets</span></span><br><span class="line">            gt_masks = []</span><br><span class="line">            <span class="comment"># 遍历每个图片的实例信息</span></span><br><span class="line">            <span class="keyword">for</span> instances_per_image <span class="keyword">in</span> gt_instances:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(instances_per_image.gt_boxes.tensor) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment"># crop到56*56 gt_mask_per_image.shape = [7(这张图包含的实例个数), 56, 56]</span></span><br><span class="line">                gt_mask_per_image = instances_per_image.gt_masks.crop_and_resize(</span><br><span class="line">                    instances_per_image.gt_boxes.tensor, self.pooler_resolution</span><br><span class="line">                ).to(device=pred_mask_logits.device)</span><br><span class="line">                gt_masks.append(gt_mask_per_image)</span><br><span class="line">            gt_masks = cat(gt_masks, dim=<span class="number">0</span>) <span class="comment"># gt_masks.shape = [484, 56, 56]</span></span><br><span class="line">            <span class="comment">#pdb.set_trace()</span></span><br><span class="line">            gt_masks = gt_masks[gt_inds]  <span class="comment"># gt_masks.shape = [3473, 56, 56] 3473为总共的实例数</span></span><br><span class="line">            <span class="comment">#pdb.set_trace()</span></span><br><span class="line">            N = gt_masks.size(<span class="number">0</span>)</span><br><span class="line">            gt_masks = gt_masks.view(N, -<span class="number">1</span>)  <span class="comment"># gt_masks.shape = [3473, 56*56]</span></span><br><span class="line"></span><br><span class="line">            gt_ctr = dense_info.gt_ctrs  <span class="comment"># gt_ctr.shape = [3473]</span></span><br><span class="line">            loss_denorm = proposals[<span class="string">&quot;loss_denorm&quot;</span>]  <span class="comment"># loss_denorm = ctrness_targets.sum()</span></span><br><span class="line">            <span class="comment"># mask BCE loss [3473, 56*56]</span></span><br><span class="line">            <span class="comment"># F.binary_cross_entropy_with_logits等价于torch.nn.BCEWithLogitsLoss,reduction=&quot;none&quot;表示逐个元素相加、reduction=&quot;sum&quot;为所有元素求和</span></span><br><span class="line">            mask_losses = F.binary_cross_entropy_with_logits(</span><br><span class="line">                pred_mask_logits, gt_masks.to(dtype=torch.float32), reduction=<span class="string">&quot;none&quot;</span>)</span><br><span class="line">            mask_loss = ((mask_losses.mean(dim=-<span class="number">1</span>) * gt_ctr).<span class="built_in">sum</span>()</span><br><span class="line">                         / loss_denorm)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#pdb.set_trace()</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, &#123;<span class="string">&quot;loss_mask&quot;</span>: mask_loss&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># no proposals</span></span><br><span class="line">            total_instances = <span class="built_in">sum</span>([<span class="built_in">len</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> proposals])</span><br><span class="line">            <span class="keyword">if</span> total_instances == <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># add empty pred_masks results</span></span><br><span class="line">                <span class="keyword">for</span> box <span class="keyword">in</span> proposals:</span><br><span class="line">                    box.pred_masks = box.pred_classes.view(</span><br><span class="line">                        -<span class="number">1</span>, <span class="number">1</span>, self.pooler_resolution, self.pooler_resolution)</span><br><span class="line">                <span class="keyword">return</span> proposals, &#123;&#125;</span><br><span class="line">            rois = self.pooler(bases, [x.pred_boxes <span class="keyword">for</span> x <span class="keyword">in</span> proposals])</span><br><span class="line">            attns = cat([x.top_feat <span class="keyword">for</span> x <span class="keyword">in</span> proposals], dim=<span class="number">0</span>)</span><br><span class="line">            pred_mask_logits = self.merge_bases(rois, attns).sigmoid()</span><br><span class="line">            pred_mask_logits = pred_mask_logits.view(</span><br><span class="line">                -<span class="number">1</span>, <span class="number">1</span>, self.pooler_resolution, self.pooler_resolution)</span><br><span class="line">            start_ind = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> box <span class="keyword">in</span> proposals:</span><br><span class="line">                end_ind = start_ind + <span class="built_in">len</span>(box)</span><br><span class="line">                box.pred_masks = pred_mask_logits[start_ind:end_ind]</span><br><span class="line">                start_ind = end_ind</span><br><span class="line">            <span class="keyword">return</span> proposals, &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 融合部分    </span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">merge_bases</span>(<span class="params">self, rois, coeffs, location_to_inds=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="comment"># merge predictions</span></span><br><span class="line">        <span class="comment"># 输入的coeffss = [instances=3473, attn_len=784]</span></span><br><span class="line">        N = coeffs.size(<span class="number">0</span>)</span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> location_to_inds <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            rois = rois[location_to_inds]</span><br><span class="line">        N, B, H, W = rois.size()</span><br><span class="line"></span><br><span class="line">        coeffs = coeffs.view(N, -<span class="number">1</span>, self.attn_size, self.attn_size)  <span class="comment"># [instances, -1, M, M] --&gt; [instances, nums_bases, 14, 14]</span></span><br><span class="line">        <span class="comment"># 2. 对应 a&#x27;d = interpolate_(M x M) --&gt; (R x R)(a_d)  Sd = softmax(a&#x27;d)</span></span><br><span class="line">        <span class="comment"># S_d = softmax(a&#x27;_d) 在通道上对每一个元素做softmax。此处也就是对于4个元素。  # [instances, 4, 14, 14] --&gt; [instances, 4, 56, 56]</span></span><br><span class="line">        coeffs = F.interpolate(coeffs, (H, W),</span><br><span class="line">                               mode=self.top_interp).softmax(dim=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 3.对应 m_d = sum(s^k_d * r^k_d)</span></span><br><span class="line">        masks_preds = (rois * coeffs).<span class="built_in">sum</span>(dim=<span class="number">1</span>)  <span class="comment"># [instances, 56, 56]</span></span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line">        <span class="keyword">return</span> masks_preds.view(N, -<span class="number">1</span>)  <span class="comment"># [instances, 56*56]</span></span><br></pre></td></tr></table></figure>

<h2 id="AdelaiDet-x2F-adet-x2F-modeling-x2F-blendmask-x2F-basis-modules-py"><a href="#AdelaiDet-x2F-adet-x2F-modeling-x2F-blendmask-x2F-basis-modules-py" class="headerlink" title="AdelaiDet&#x2F;adet&#x2F;modeling&#x2F;blendmask&#x2F;basis_modules.py"></a>AdelaiDet&#x2F;adet&#x2F;modeling&#x2F;blendmask&#x2F;basis_modules.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> detectron2.utils.registry <span class="keyword">import</span> Registry</span><br><span class="line"><span class="keyword">from</span> detectron2.layers <span class="keyword">import</span> ShapeSpec</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> adet.layers <span class="keyword">import</span> conv_with_kaiming_uniform</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BASIS_MODULE_REGISTRY = Registry(<span class="string">&quot;BASIS_MODULE&quot;</span>)</span><br><span class="line">BASIS_MODULE_REGISTRY.__doc__ = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Registry for basis module, which produces global bases from feature maps.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The registered object will be called with `obj(cfg, input_shape)`.</span></span><br><span class="line"><span class="string">The call should return a `nn.Module` object.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试用</span></span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_basis_module</span>(<span class="params">cfg, input_shape</span>):</span><br><span class="line">    name = cfg.MODEL.BASIS_MODULE.NAME  <span class="comment"># ProtoNet，具体内容见adet/config/defaults</span></span><br><span class="line">    <span class="keyword">return</span> BASIS_MODULE_REGISTRY.get(name)(cfg, input_shape)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@BASIS_MODULE_REGISTRY.register()</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProtoNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cfg, input_shape: <span class="type">Dict</span>[<span class="built_in">str</span>, ShapeSpec]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        (Pdb) input_shape</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &#x27;p3&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=8),</span></span><br><span class="line"><span class="string">            &#x27;p4&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=16),</span></span><br><span class="line"><span class="string">            &#x27;p5&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=32),</span></span><br><span class="line"><span class="string">            &#x27;p6&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=64),</span></span><br><span class="line"><span class="string">            &#x27;p7&#x27;: ShapeSpec(channels=256, height=None, width=None, stride=128)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        TODO: support deconv and variable channel width</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># official protonet has a relu after each conv</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># fmt: off</span></span><br><span class="line">        mask_dim          = cfg.MODEL.BASIS_MODULE.NUM_BASES    <span class="comment"># 4</span></span><br><span class="line">        planes            = cfg.MODEL.BASIS_MODULE.CONVS_DIM    <span class="comment"># 128</span></span><br><span class="line">        self.in_features  = cfg.MODEL.BASIS_MODULE.IN_FEATURES  <span class="comment"># [&#x27;p3&#x27;, &#x27;p4&#x27;, &#x27;p5&#x27;]</span></span><br><span class="line">        self.loss_on      = cfg.MODEL.BASIS_MODULE.LOSS_ON      <span class="comment"># True</span></span><br><span class="line">        norm              = cfg.MODEL.BASIS_MODULE.NORM         <span class="comment"># BN</span></span><br><span class="line">        num_convs         = cfg.MODEL.BASIS_MODULE.NUM_CONVS    <span class="comment"># 3</span></span><br><span class="line">        self.visualize    = cfg.MODEL.BLENDMASK.VISUALIZE       <span class="comment"># False</span></span><br><span class="line">        <span class="comment"># fmt: on</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># &#123;&#x27;p3&#x27;:256, ... , &#x27;p6&#x27;:256&#125;</span></span><br><span class="line">        feature_channels = &#123;k: v.channels <span class="keyword">for</span> k, v <span class="keyword">in</span> input_shape.items()&#125;</span><br><span class="line"></span><br><span class="line">        conv_block = conv_with_kaiming_uniform(norm, <span class="literal">True</span>)  <span class="comment"># conv relu bn</span></span><br><span class="line">        self.refine = nn.ModuleList()</span><br><span class="line">        <span class="keyword">for</span> in_feature <span class="keyword">in</span> self.in_features:</span><br><span class="line">            self.refine.append(conv_block(</span><br><span class="line">                feature_channels[in_feature], planes, <span class="number">3</span>, <span class="number">1</span>))</span><br><span class="line">        tower = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_convs):</span><br><span class="line">            tower.append(</span><br><span class="line">                conv_block(planes, planes, <span class="number">3</span>, <span class="number">1</span>))</span><br><span class="line">        tower.append(</span><br><span class="line">            nn.Upsample(scale_factor=<span class="number">2</span>, mode=<span class="string">&#x27;bilinear&#x27;</span>, align_corners=<span class="literal">False</span>))</span><br><span class="line">        tower.append(</span><br><span class="line">            conv_block(planes, planes, <span class="number">3</span>, <span class="number">1</span>))</span><br><span class="line">        tower.append(</span><br><span class="line">            nn.Conv2d(planes, mask_dim, <span class="number">1</span>))</span><br><span class="line">        self.add_module(<span class="string">&#x27;tower&#x27;</span>, nn.Sequential(*tower))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.loss_on:</span><br><span class="line">            <span class="comment"># fmt: off</span></span><br><span class="line">            self.common_stride   = cfg.MODEL.BASIS_MODULE.COMMON_STRIDE    <span class="comment"># 8</span></span><br><span class="line">            num_classes          = cfg.MODEL.BASIS_MODULE.NUM_CLASSES + <span class="number">1</span>  <span class="comment"># 26</span></span><br><span class="line">            self.sem_loss_weight = cfg.MODEL.BASIS_MODULE.LOSS_WEIGHT      <span class="comment"># 0.3</span></span><br><span class="line">            <span class="comment"># fmt: on</span></span><br><span class="line"></span><br><span class="line">            inplanes = feature_channels[self.in_features[<span class="number">0</span>]]  <span class="comment"># 256</span></span><br><span class="line">            self.seg_head = nn.Sequential(nn.Conv2d(inplanes, planes, kernel_size=<span class="number">3</span>,</span><br><span class="line">                                                    stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                                          nn.BatchNorm2d(planes),</span><br><span class="line">                                          nn.ReLU(),</span><br><span class="line">                                          nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>,</span><br><span class="line">                                                    stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                                          nn.BatchNorm2d(planes),</span><br><span class="line">                                          nn.ReLU(),</span><br><span class="line">                                          nn.Conv2d(planes, num_classes, kernel_size=<span class="number">1</span>,</span><br><span class="line">                                                    stride=<span class="number">1</span>))</span><br><span class="line">        <span class="comment">#pdb.set_trace()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, features, targets=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param features: len(features)=5</span></span><br><span class="line"><span class="string">        :param targets:[N, h, w]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i, f <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.in_features):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                x = self.refine[i](features[f])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                x_p = self.refine[i](features[f])</span><br><span class="line">                x_p = F.interpolate(x_p, x.size()[<span class="number">2</span>:], mode=<span class="string">&quot;bilinear&quot;</span>, align_corners=<span class="literal">False</span>)</span><br><span class="line">                <span class="comment"># x_p = aligned_bilinear(x_p, x.size(3) // x_p.size(3))</span></span><br><span class="line">                x = x + x_p  <span class="comment"># [N, 128, h, w]</span></span><br><span class="line">                pdb.set_trace()</span><br><span class="line">        outputs = &#123;<span class="string">&quot;bases&quot;</span>: [self.tower(x)]&#125;</span><br><span class="line">        losses = &#123;&#125;</span><br><span class="line">        <span class="comment"># auxiliary thing semantic loss 辅助语义损失</span></span><br><span class="line">        <span class="keyword">if</span> self.training <span class="keyword">and</span> self.loss_on:</span><br><span class="line">            sem_out = self.seg_head(features[self.in_features[<span class="number">0</span>]])</span><br><span class="line">            <span class="comment"># resize target to reduce memory</span></span><br><span class="line">            gt_sem = targets.unsqueeze(<span class="number">1</span>).<span class="built_in">float</span>()</span><br><span class="line">            gt_sem = F.interpolate(</span><br><span class="line">                gt_sem, scale_factor=<span class="number">1</span> / self.common_stride)</span><br><span class="line">            seg_loss = F.cross_entropy(</span><br><span class="line">                sem_out, gt_sem.squeeze(<span class="number">1</span>).long())</span><br><span class="line">            losses[<span class="string">&#x27;loss_basis_sem&#x27;</span>] = seg_loss * self.sem_loss_weight</span><br><span class="line">        <span class="keyword">elif</span> self.visualize <span class="keyword">and</span> <span class="built_in">hasattr</span>(self, <span class="string">&quot;seg_head&quot;</span>):</span><br><span class="line">            outputs[<span class="string">&quot;seg_thing_out&quot;</span>] = self.seg_head(features[self.in_features[<span class="number">0</span>]])</span><br><span class="line">        pdb.set_trace()</span><br><span class="line">        <span class="keyword">return</span> outputs, losses</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.freesion.com/article/58821475331/">https://www.freesion.com/article/58821475331/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/aim-uofa/AdelaiDet">https://github.com/aim-uofa/AdelaiDet</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">BlendMask笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-04-22 10:10:24 / 修改时间：10:56:29" itemprop="dateCreated datePublished" datetime="2023-04-22T10:10:24+08:00">2023-04-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">深度学习</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>863</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="实例分割算法BlendMask"><a href="#实例分割算法BlendMask" class="headerlink" title="实例分割算法BlendMask"></a>实例分割算法BlendMask</h1><p>论文地址：<a target="_blank" rel="noopener" href="https://arxiv.org/abs/2001.00309">https://arxiv.org/abs/2001.00309</a></p>
<p>github代码：<a target="_blank" rel="noopener" href="https://github.com/aim-uofa/AdelaiDet">https://github.com/aim-uofa/AdelaiDet</a></p>
<h2 id="密集实例分割"><a href="#密集实例分割" class="headerlink" title="密集实例分割"></a>密集实例分割</h2><p>​    密集实例分割主要分为自上而下top-down与自下而上bottom-up两类方法：</p>
<h3 id="Top-down方法"><a href="#Top-down方法" class="headerlink" title="Top-down方法"></a>Top-down方法</h3><p>​    top-down方法主要表现为先检测后分割，先通过一些方法获得box区域，然后对区域内的像素进行mask提取，比如著名的Mask-RCNN就是top-down方法。</p>
<p>​    这种模型一般有以下问题：</p>
<ol>
<li>特征和mask之间的局部一致性会丢失</li>
<li>冗余的特征提取，不同的bbox会重新提取一次mask</li>
<li>由于使用了缩小的特征图卷积，位置信息会损失</li>
</ol>
<h3 id="Bottom-up方法"><a href="#Bottom-up方法" class="headerlink" title="Bottom-up方法"></a>Bottom-up方法</h3><p>​    bottom-up方法将整个图进行逐像素的预测（per-pixel prediction），然后按照聚类等方法，对每个像素做embedding，最后group出不同的instance。虽然保留个更好的低层特征，但是效果一般略差于top-down方法。</p>
<p>​    这种模型一般存在以下问题：</p>
<ol>
<li>严重依赖逐像素预测的质量，容易导致非最优的分割</li>
<li>由于mask在低维度提取，对于复杂场景的分割能力有限</li>
<li>需要复杂的后处理方法</li>
</ol>
<h3 id="混合方法"><a href="#混合方法" class="headerlink" title="混合方法"></a>混合方法</h3><p>​    BlendMask主要结合了top-down与botton-up两种思路，利用t-d方法生成实例级别的高维信息（如bbox），利用b-u方法生成per-pixel的预测进行融合。基于FCOS，融合的方法借鉴FCIS（裁剪）与YOLACT（权重加法）的思想，提出了blender模块，更好的将实例级别的全局信息与提供细节的底层特征融合。</p>
<h2 id="总体思路"><a href="#总体思路" class="headerlink" title="总体思路"></a>总体思路</h2><img src="/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/image-20230422102619797.png" class="" title="BlendMask整体架构">

<p>   整体架构如上图所示，包含一个detector模块与BlendMask模块。detector模块直接采用的FCOS，BlendMask模块分为三部分：</p>
<ul>
<li>Bottom Module：对底层特征进行处理，生成的score map称为Bases</li>
<li>Top Layer：串联在检测器的box head上，生成Base对应的top level attention</li>
<li>Blender：将Bases与attention融合</li>
</ul>
<h3 id="Bottom-Module"><a href="#Bottom-Module" class="headerlink" title="Bottom Module"></a>Bottom Module</h3><p>​    采用Deelpabv3+的decoder，包含两个输入，一个低层特征一个高层特征，对高层特征进行上采用后与低层特征融合输出，</p>
<img src="/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/image-20230422103608570.png" class="" title="Deeplabv3+结构">

<p>​    bottom输出的feature特征为：(N * K * H&#x2F;s * W&#x2F;s)，N为channel，K为bases的数量，(H,W)为输入的size，s为scroe的步长。</p>
<h3 id="Top-Layer"><a href="#Top-Layer" class="headerlink" title="Top Layer"></a>Top Layer</h3><p>​    在检测的特征金字塔的每一层后都加了一层卷积，用来预测top-level attentions(A)，输出的特征为：(N * (K*M*M)) * H_i * W_i)，M*M为attention的分辨率，即对应的base的每个像素点的权重值，包含的粒度更细。</p>
<h3 id="Blender"><a href="#Blender" class="headerlink" title="Blender"></a>Blender</h3><p>​    Blender的输入为bottom的输出B、top-level的输出attentions(A)和bbox(P)，该部分的融合如下：</p>
<ol>
<li>使用RoiPooler来裁取每个bbox对应的区域，并resize成固定的RxR大小的特征图。训练时直接使用ground truth bbox作为propasals，而在推理时直接用FCOS的结果<img src="/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/image-20230422104735998.png" class="" title="RoIPool"></li>
<li>attention的大小M是比R小的，因此需要插值，这里采用的双线性插值，从MxM变为RxR<img src="/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/image-20230422105051459.png" class="" title="attention上采样"></li>
<li>接着插值完的attention进行softmax，产生一组score map<img src="/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/image-20230422105309801.png" class="" title="attention的score map"></li>
<li>对每个r_d和对应的s_d进行逐像素的相加，最后将K个结果相加得到m_d<img src="/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/image-20230422105357473.png" class=""></li>
</ol>
<p>​    可视化的blender过程：</p>
<img src="/2023/04/22/BlendMask%E7%AC%94%E8%AE%B0/image-20230422105439280.png" class="" title="可视化过程">

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/21/FCOS%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/21/FCOS%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">FCOS笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-04-21 20:24:48 / 修改时间：21:09:54" itemprop="dateCreated datePublished" datetime="2023-04-21T20:24:48+08:00">2023-04-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">深度学习</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="FCOS笔记"><a href="#FCOS笔记" class="headerlink" title="FCOS笔记"></a>FCOS笔记</h1><h2 id="1-FCOS基本"><a href="#1-FCOS基本" class="headerlink" title="1.FCOS基本"></a>1.FCOS基本</h2><p>《FCOS: A Simple and Strong Anchor-free Object Detector》</p>
<p>FCOS 第二篇paper地址：<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1904.01355.pdf">https://arxiv.org/pdf/1904.01355.pdf</a></p>
<p>FCOS 第二篇paper地址：<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2006.09214.pdf">https://arxiv.org/pdf/2006.09214.pdf</a></p>
<p>FCOS code地址：<a target="_blank" rel="noopener" href="https://github.com/tianzhi0549/FCOS">https://github.com/tianzhi0549/FCOS</a></p>
<h3 id="1-1-核心概念"><a href="#1-1-核心概念" class="headerlink" title="1.1 核心概念"></a>1.1 核心概念</h3><p>​    将锚框转换为铺设锚点进行物体检测。</p>
<p>​    FCOS是基于无锚框（Anchor-Free）的目标检测方法，是指将锚框（Anchor-Based）中的对锚框分类与回归转变为：对锚点进行分类与回归，其中回归是预测这个锚点到检测框上下左右四条边界的距离。</p>
<h3 id="1-2-Anchor-Based的缺点"><a href="#1-2-Anchor-Based的缺点" class="headerlink" title="1.2 Anchor-Based的缺点"></a>1.2 Anchor-Based的缺点</h3><ul>
<li>Anchor-Based对检测框anchor的大小、数量、长款都比较敏感</li>
<li>固定尺寸size和纵横比aspext ratio的锚框不利于检测器的泛化能力，导致对不同任务，anchor可能需要重新设置大小和尺寸</li>
<li>为了达到更好的效果，需要生成很多的anchor，但是大部分anchor都为负样本，造成了样本的不均衡</li>
<li>在训练中，需要计算所有anchor与真实框的IOU，消耗大量资源内存资源与时间</li>
</ul>
<h3 id="1-3-FCOS优点"><a href="#1-3-FCOS优点" class="headerlink" title="1.3 FCOS优点"></a>1.3 FCOS优点</h3><ul>
<li>检测问题完全交给FCN去处理，可以复用到其他任务上，比如语义分割、关键点检测</li>
<li>anchor-free方法减少了参数的设计，使训练更简单</li>
<li>不需要计算IOU，节省资源</li>
</ul>
<h2 id="2-FCOS网络结构"><a href="#2-FCOS网络结构" class="headerlink" title="2.FCOS网络结构"></a>2.FCOS网络结构</h2><h3 id="2-1-原始的FCOS"><a href="#2-1-原始的FCOS" class="headerlink" title="2.1 原始的FCOS"></a>2.1 原始的FCOS</h3><img src="/2023/04/21/FCOS%E7%AC%94%E8%AE%B0/fcos_structure-16820799089041.png" class="" title="FCOS Structure">

<p>​    初始的FCOS网络如上图所示，C3、C4、C5代表了骨干网络的特征映射，P3-P7为最终预测所使用的特征层，hw为特征图的高和宽，最左侧为下采样比例。</p>
<p>​    然后将P3-P7输入检测头，每个检测头head包含以下三个分支：</p>
<ul>
<li>Classification分支：预测类别分支，预测类别，图中的C即表示类别</li>
<li>Center-ness分支：中心度分支，一个锚点对应一个中心都，用于锚点相对检测框中心的判断</li>
<li>Regression分支：回归位置分支，用来回归正样本锚点到检测框的距离，图中的4表示<code>l t r b</code>即上下左右四条边界</li>
</ul>
<p>​    改进前Classification分支既包含了正、负样本锚点的类别预测分支，又包含了正、负样本锚点中心性判断的center-ness分支。</p>
<h3 id="2-2-改进的FCOS"><a href="#2-2-改进的FCOS" class="headerlink" title="2.2 改进的FCOS"></a>2.2 改进的FCOS</h3><p>​    后来发现Center-ness分支与Regression分支放在一起更好，所以就将这二者放在了一起：</p>
<p>​    下图引自我的b站导师：<a href="https://link.zhihu.com/?target=https://blog.csdn.net/qq_37541097/article/details/124844726?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165884537116782246451205%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=165884537116782246451205&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-2-124844726-null-null.185%5Ev2%5Econtrol&utm_term=fpn&spm=1018.2226.3001.4450">FCOS网络解析_太阳花的小绿豆的博客-CSDN博客_fcos网络</a></p>
<img src="/2023/04/21/FCOS%E7%AC%94%E8%AE%B0/fcos_structure_gai-16820799089052.png" class="" title="改进的FCOS Structure">

<h3 id="2-3-损失函数"><a href="#2-3-损失函数" class="headerlink" title="2.3 损失函数"></a>2.3 损失函数</h3><p>​    以改进版的损失函数为例，Head总共有三个输出分支，故损失由分类损失 L_cls、定位损失 L_rcs与center-ness损失 L_ctrness三部分组成 ：</p>
<img src="/2023/04/21/FCOS%E7%AC%94%E8%AE%B0/fcos_loss-16820799089053.png" class="" title="FCOS损失函数">

<p>   其中：</p>
<img src="/2023/04/21/FCOS%E7%AC%94%E8%AE%B0/fcos_loss_expr-16820799089054.png" class="" title="参数详解">

<ul>
<li><p>分类损失L_cls采用 BCE Loss+Focal Loss，计算损失时所有样本都会参与</p>
</li>
<li><p>定位损失L_rcs次啊用GIoU Loss（即现在的IoU Loss），计算损失时只有正样本参与</p>
</li>
<li><p>center-ness损失L_ctrness采用BCE Loss，计算损失时只有正样本参与，s*x,y的计算公式如下：<img src="/2023/04/21/FCOS%E7%AC%94%E8%AE%B0/centerness-16820799089055.png" class="" title="center-ness损失"></p>
<p>  center-ness距离GT（ground truth框，即人工标注的真实样本框）中心点越近，centerness*值越大，反之越小。在推理时，center-ness还可以类别权重，在NMS（非极大值抑制）中，其排序所用的置信度由center-ness与类别概率（类别得分）得到</p>
</li>
</ul>
<h2 id="3-正样本、负样本、模糊样本的定义"><a href="#3-正样本、负样本、模糊样本的定义" class="headerlink" title="3.正样本、负样本、模糊样本的定义"></a>3.正样本、负样本、模糊样本的定义</h2><h3 id="3-1-正样本、负样本"><a href="#3-1-正样本、负样本" class="headerlink" title="3.1 正样本、负样本"></a>3.1 正样本、负样本</h3><p>​    有目标的就是正样本、没有目标的就是负样本。</p>
<p>​    对于anchor-free来说，锚点落在了特征图上的GT框内，他就是正样本，否则就是负样本。</p>
<h3 id="3-2-模糊样本"><a href="#3-2-模糊样本" class="headerlink" title="3.2 模糊样本"></a>3.2 模糊样本</h3><p>​    FCOS里的模糊样本指的是那些锚点落在多个GT框的样本，一般取最小的GT框作为回归目标。</p>
<h2 id="4-特征图上的点映回原图"><a href="#4-特征图上的点映回原图" class="headerlink" title="4.特征图上的点映回原图"></a>4.特征图上的点映回原图</h2><p>​    为了知道特征图上的点在原图的位置，我们需要上采样，根据总体的stride来定义上采样倍率</p>
<h2 id="5-锚点回归值"><a href="#5-锚点回归值" class="headerlink" title="5.锚点回归值"></a>5.锚点回归值</h2><p>​    锚点回归的回归计算公式如下所示，其中(l∗,t∗,r∗,b∗)是锚点距离物体的真实标注框左、上、右、下边界的距离，(x,y)为特征图上锚点映射到原图上的位置；在回归分支中，每个锚点预测一个四维向量，即四条边界，网络能把每个锚点距离真实标准框的距离预测的越准，说明检测效果越好：</p>
<img src="/2023/04/21/FCOS%E7%AC%94%E8%AE%B0/regression-16820799089056.png" class="">

<h2 id="6-模糊样本的处理"><a href="#6-模糊样本的处理" class="headerlink" title="6.模糊样本的处理"></a>6.模糊样本的处理</h2><p>​    采用FPN时会将大小不同的anchor放置在不同大小的特征图上，特征图越小，感受野越大，用来检测更大的物体，FCOS采用5个不同大小的特征图P3-P7(P_i)，stride对应8,16,32,64,128。</p>
<p>​    在anchor-based中，根据anchor与GT框的IoU来匹配，而FCOS直接通过限制不同特征图上的回归目标值来达到这一目的，每个特征图P都会设定一个回归下限值与回归上限值，作为其回归距离的限制。如果特征图上P_i的坐标点(x,y)满足小于下限或大于上限，这个特征层就将其设置为负样本，不再进行回归。</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45377629/article/details/124844405">https://blog.csdn.net/weixin_45377629/article/details/124844405</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44135282/article/details/89703818">https://blog.csdn.net/weixin_44135282/article/details/89703818</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/20/knowledge-summarize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/20/knowledge-summarize/" class="post-title-link" itemprop="url">暑期实习知识点总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-20 21:05:28" itemprop="dateCreated datePublished" datetime="2023-04-20T21:05:28+08:00">2023-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-05-25 09:20:41" itemprop="dateModified" datetime="2023-05-25T09:20:41+08:00">2023-05-25</time>
              </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1:10</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="暑期实习知识点总结"><a href="#暑期实习知识点总结" class="headerlink" title="暑期实习知识点总结"></a>暑期实习知识点总结</h1><p>对准备暑期实习的过程中遇到的问题与八股文进行了总结（不定期更新），主要内容包括c&#x2F;c++基本知识点、stl基础、网络编程、计算机网络、数据库等，有错误的地方请指出并多包涵！</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/04/20/knowledge-summarize/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/20/hexo%E7%BD%91%E7%AB%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.gif">
      <meta itemprop="name" content="ZzBoAYU">
      <meta itemprop="description" content="-珍惜眼前人-">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZzBoAYU HOME">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/20/hexo%E7%BD%91%E7%AB%99/" class="post-title-link" itemprop="url">Hexo搭建自己的网站</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-04-20 16:41:52 / 修改时间：18:06:21" itemprop="dateCreated datePublished" datetime="2023-04-20T16:41:52+08:00">2023-04-20</time>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>853</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  <strong>Hexo是一个快读、简洁高效的博客框架，使用Markdown解析文章</strong></p>
<h3 id="1-在安装hexo前我们必须要安装Node和Git：-有的就直接第2步"><a href="#1-在安装hexo前我们必须要安装Node和Git：-有的就直接第2步" class="headerlink" title="1.在安装hexo前我们必须要安装Node和Git：(有的就直接第2步)"></a>1.在安装hexo前我们必须要安装Node和Git：(有的就直接第2步)</h3><ul>
<li><p>Git官方下载地址：<a target="_blank" rel="noopener" href="https://git-scm.com/download/win">https://git-scm.com/download/win</a></p>
<p>  下载完在cmd输入 <code>git --version</code> 查看Git版本并确认是否安装成功 </p>
<p>  （若未出现可能是环境变量未配置，去环境变量配置一下就行）</p>
</li>
<li><p>Node.js官网下载地址：<a target="_blank" rel="noopener" href="https://nodejs.org/en">https://nodejs.org/en</a></p>
<p>  下载完在cmd输入 <code>node -v</code> 查看Node版本并确认是否安装成功</p>
</li>
</ul>
<h2 id="2-安装Hexo"><a href="#2-安装Hexo" class="headerlink" title="2.安装Hexo"></a>2.安装Hexo</h2><p><code>npm install -g hexo-cli</code></p>
<h2 id="3-配置github"><a href="#3-配置github" class="headerlink" title="3.配置github"></a>3.配置github</h2><h3 id="3-1创建github仓库"><a href="#3-1创建github仓库" class="headerlink" title="3.1创建github仓库"></a>3.1创建github仓库</h3><p>首先你需要创建一个github账户（略）</p>
<p>  创建完账户需要新建一个名为: <code>username.github.io</code>的仓库， <code>username</code>为你的github用户名，并且这个仓库有且只能有唯一一个，这样就可以通过访问 <code>https://username.github.io</code>来访问你的仓库。</p>
<h3 id="3-2配置SSH免密登录"><a href="#3-2配置SSH免密登录" class="headerlink" title="3.2配置SSH免密登录"></a>3.2配置SSH免密登录</h3><ol>
<li>首先打开首先打开电脑文件夹，找到 C:\Users\你的用户名\ .ssh文件夹并删除(如果没有，则直接进入第二步)</li>
<li>在 C:\Users\你的用户名 文件夹下右键打开 Git Bash Here 输入命令: <code>ssh-keygen -t rsa -C &quot;你的github登录邮箱&quot;</code> 生成.ssh秘钥，输入后连敲三次回车，出一个框里面一堆字符情况代表成功</li>
<li>生成了一个新的 C:\Users\你的用户名\ .ssh文件夹，打开这个文件夹，找到 .ssh\id_rsa.pub 文件，记事本打开并复制里面的内容</li>
<li>打开您的 github 主页，进入个人设置 -&gt; SSH and GPG keys -&gt; New SSH key，把复制的内容粘贴进去，title 随便填，保存即可，我们的公钥就添加成功了</li>
<li>输入命令: <code>ssh -T git@github.com</code>，会给你返回以下内容：<code>Hi 你的Github username!You&#39;ve successfully authenticated, but GitHub does not provide shell access.   </code>说明配置成功</li>
</ol>
<p>此外你还需要配置以下内容</p>
<p><code>git config --global user.name &quot;你的 Github username&quot;</code>  你的github的username</p>
<p><code>git config --global user.email &quot;xxx@qq.com&quot;</code>  你的github邮箱</p>
<h2 id="4-使用Hexo搭建博客"><a href="#4-使用Hexo搭建博客" class="headerlink" title="4.使用Hexo搭建博客"></a>4.使用Hexo搭建博客</h2><h3 id="4-1进行hexo初始化"><a href="#4-1进行hexo初始化" class="headerlink" title="4.1进行hexo初始化"></a>4.1进行hexo初始化</h3><ol>
<li>在电脑的某个磁盘或路径创建一个文件夹（名字随便取），我这里取得是D:\blog，由于这个文件夹作为将来存放代码的地方，所以一定要好好记住。</li>
<li>打开这个文件夹，在文件夹右键打开GIt Base Here，如果没有就在显示更多选项中寻找，输入命令 <code>hexo init</code> 进行初始化：hexo会下载一些文件和文件夹</li>
<li>在D:\blog这个文件夹中执行 <code>hexo g</code> 会在public文件夹下生相关的html文件</li>
<li>在D:\blog这个文件夹中执行 <code>hexo s</code> 会开启本地预览，打开浏览器访问<a href="http://localhost:4000即可看到博客内容">http://localhost:4000即可看到博客内容</a></li>
</ol>
<h3 id="4-2部署至github"><a href="#4-2部署至github" class="headerlink" title="4.2部署至github"></a>4.2部署至github</h3><ol>
<li><p>还在D:\blog这个文件夹中，执行<code>npm install hexo-deployer-git --save</code>命令</p>
</li>
<li><p>编辑D:\blog中的<code>_config.yml</code>文件，在文件末尾处添加以下内容</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">   <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">   <span class="attr">repository:</span> <span class="string">git@github.com:ZzBobo0915/ZzBobo0915.github.io.git</span></span><br><span class="line">   <span class="attr">brance:</span> <span class="string">main</span></span><br></pre></td></tr></table></figure>

<p> 其中<code>repository</code>中的内容是你的github项目的SSH链接地址</p>
</li>
<li><p>在D:\blog这个文件夹中，执行<code>hexo d</code>将本地项目推送到github远程仓库，有可能要需要输入用户名和密码</p>
<p> 推送成功后，即可通过仓库名<code>zzbobo0915.github.io/</code>访问个人博客了</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/default-index/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/default-index/">1</a><span class="page-number current">2</span><a class="page-number" href="/default-index/page/3/">3</a><a class="extend next" rel="next" href="/default-index/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZzBoAYU"
      src="/images/touxiang.gif">
  <p class="site-author-name" itemprop="name">ZzBoAYU</p>
  <div class="site-description" itemprop="description">-珍惜眼前人-</div>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ZzBobo0915" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ZzBobo0915" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhuzhibo0915@163.com" title="E-Mail → mailto:zhuzhibo0915@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<!-- 侧栏网易云音乐 -->
<div id="music163player">
  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=110 src="//music.163.com/outchain/player?type=0&id=8369008493&auto=0&height=90"></iframe>
</divb>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZzBoAYU</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">65k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:57</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/clicklove.js"></script>

</body>
</html>
